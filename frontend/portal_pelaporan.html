<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS BPKH - Portal Pelaporan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .gradient-bg { background: linear-gradient(135deg, #059669 0%, #047857 50%, #065f46 100%); }
        .input-focus:focus { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">WBS BPKH</h1>
                    <p class="text-emerald-100">Whistleblowing System - Portal Pelaporan</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Navigation Tabs -->
        <div class="flex gap-2 mb-6">
            <button onclick="showTab('submit')" id="tab-submit" class="tab-btn px-6 py-3 rounded-lg font-medium bg-emerald-600 text-white">
                <i data-lucide="file-plus" class="w-4 h-4 inline mr-2"></i>
                Buat Laporan
            </button>
            <button onclick="showTab('track')" id="tab-track" class="tab-btn px-6 py-3 rounded-lg font-medium bg-white text-slate-600 hover:bg-slate-100">
                <i data-lucide="search" class="w-4 h-4 inline mr-2"></i>
                Lacak Laporan
            </button>
        </div>

        <!-- Submit Report Tab -->
        <div id="content-submit" class="tab-content fade-in">
            <!-- Info Card -->
            <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-6 mb-6">
                <div class="flex gap-4">
                    <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center shrink-0">
                        <i data-lucide="info" class="w-6 h-6 text-emerald-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-emerald-800 mb-2">Jaminan Kerahasiaan</h3>
                        <p class="text-emerald-700 text-sm">
                            Identitas pelapor dijamin kerahasiaannya sesuai ISO 37002:2021. 
                            Anda dapat melaporkan secara anonim tanpa mencantumkan data diri.
                            Semua laporan akan ditangani secara profesional dan independen.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Report Form -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-slate-800 mb-6">Formulir Pengaduan</h2>
                
                <form id="report-form" onsubmit="submitReport(event)">
                    <!-- Anonymous Option -->
                    <div class="mb-6">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="is_anonymous" checked class="w-5 h-5 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                            <span class="font-medium text-slate-700">Laporkan secara anonim</span>
                        </label>
                        <p class="text-sm text-slate-500 mt-1 ml-8">Identitas Anda tidak akan dicatat jika opsi ini dipilih</p>
                    </div>

                    <!-- Contact Info (conditional) -->
                    <div id="contact-section" class="mb-6 hidden">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Kontak (Email/No. HP)
                            <span class="text-slate-400 font-normal">- untuk komunikasi tindak lanjut</span>
                        </label>
                        <input type="text" id="reporter_contact" placeholder="email@example.com atau 08xxxxxxxxxx" 
                            class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500">
                    </div>

                    <!-- Subject -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Judul Laporan <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="subject" required minlength="10" maxlength="200"
                            placeholder="Contoh: Dugaan penyimpangan pengadaan barang di unit XYZ"
                            class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500">
                        <p class="text-xs text-slate-400 mt-1">Minimal 10 karakter, maksimal 200 karakter</p>
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Uraian Lengkap <span class="text-red-500">*</span>
                        </label>
                        <textarea id="description" required minlength="50" rows="6"
                            placeholder="Jelaskan secara detail:
• Apa yang terjadi?
• Siapa yang terlibat?
• Kapan kejadian berlangsung?
• Di mana lokasi kejadian?
• Bagaimana kronologinya?"
                            class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500 resize-none"></textarea>
                        <p class="text-xs text-slate-400 mt-1">Minimal 50 karakter. Semakin detail, semakin mudah ditindaklanjuti.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Incident Date -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                Tanggal/Periode Kejadian
                            </label>
                            <input type="text" id="incident_date" 
                                placeholder="Contoh: Desember 2024, atau 15-20 Nov 2024"
                                class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500">
                        </div>

                        <!-- Location -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                Lokasi Kejadian
                            </label>
                            <input type="text" id="incident_location" 
                                placeholder="Contoh: Kantor Pusat BPKH, Gedung A Lt.3"
                                class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500">
                        </div>
                    </div>

                    <!-- Parties Involved -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Pihak yang Terlibat
                        </label>
                        <input type="text" id="parties_involved" 
                            placeholder="Contoh: Kepala Bagian Pengadaan, Vendor ABC (pisahkan dengan koma)"
                            class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500">
                        <p class="text-xs text-slate-400 mt-1">Sebutkan nama, jabatan, atau entitas yang diduga terlibat</p>
                    </div>

                    <!-- Category Hint -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            Jenis Pelanggaran (opsional)
                        </label>
                        <select id="category_hint" class="w-full px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500">
                            <option value="">-- Pilih jika diketahui --</option>
                            <option value="FRAUD">Fraud / Penipuan</option>
                            <option value="CORRUPTION">Korupsi</option>
                            <option value="GRATIFICATION">Gratifikasi</option>
                            <option value="COI">Conflict of Interest</option>
                            <option value="PROCUREMENT">Penyimpangan Pengadaan</option>
                            <option value="DATA_BREACH">Kebocoran Data</option>
                            <option value="ETHICS">Pelanggaran Etika</option>
                            <option value="MISCONDUCT">Pelanggaran Disiplin</option>
                            <option value="OTHER">Lainnya</option>
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                        <p class="text-sm text-slate-500">
                            <i data-lucide="lock" class="w-4 h-4 inline"></i>
                            Data terenkripsi & dilindungi
                        </p>
                        <button type="submit" id="submit-btn" class="px-8 py-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition flex items-center gap-2">
                            <i data-lucide="send" class="w-5 h-5"></i>
                            Kirim Laporan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Track Report Tab -->
        <div id="content-track" class="tab-content hidden fade-in">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-semibold text-slate-800 mb-6">Lacak Status Laporan</h2>
                
                <div class="max-w-md">
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        Nomor Tiket
                    </label>
                    <div class="flex gap-3">
                        <input type="text" id="ticket_id" placeholder="WBS-XXXXXXXX" maxlength="12"
                            class="flex-1 px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500 font-mono uppercase">
                        <button onclick="trackReport()" class="px-6 py-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition">
                            Lacak
                        </button>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Masukkan nomor tiket yang Anda terima saat membuat laporan</p>
                </div>

                <!-- Track Result -->
                <div id="track-result" class="mt-8 hidden">
                    <!-- Result will be shown here -->
                </div>

                <!-- Message Section -->
                <div id="message-section" class="mt-8 hidden border-t border-slate-100 pt-6">
                    <h3 class="font-semibold text-slate-800 mb-4">Kirim Pesan / Informasi Tambahan</h3>
                    
                    <div id="message-history" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                        <!-- Messages will be loaded here -->
                    </div>

                    <div class="flex gap-3">
                        <textarea id="new_message" rows="2" placeholder="Tulis pesan atau informasi tambahan..."
                            class="flex-1 px-4 py-3 border border-slate-200 rounded-lg input-focus focus:outline-none focus:border-emerald-500 resize-none"></textarea>
                        <button onclick="sendMessage()" class="px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="success-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-8 text-center fade-in">
                <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="check-circle" class="w-10 h-10 text-emerald-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">Laporan Terkirim!</h3>
                <p class="text-slate-600 mb-6">Simpan nomor tiket berikut untuk melacak status laporan Anda:</p>
                <div class="bg-slate-100 rounded-lg p-4 mb-6">
                    <p class="text-sm text-slate-500 mb-1">Nomor Tiket</p>
                    <p id="result-ticket-id" class="text-2xl font-mono font-bold text-emerald-600">WBS-XXXXXXXX</p>
                </div>
                <p class="text-sm text-slate-500 mb-6">
                    <i data-lucide="alert-circle" class="w-4 h-4 inline"></i>
                    Catat nomor ini! Anda membutuhkannya untuk mengecek status laporan.
                </p>
                <div class="flex gap-3 justify-center">
                    <button onclick="copyTicketId()" class="px-6 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        Salin
                    </button>
                    <button onclick="closeSuccessModal()" class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white mt-12">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h4 class="font-semibold mb-3">Tentang WBS BPKH</h4>
                    <p class="text-slate-400 text-sm">
                        Sistem Pelaporan Pelanggaran (Whistleblowing System) BPKH 
                        sesuai ISO 37002:2021 untuk mendukung tata kelola yang baik.
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Jenis Pelanggaran</h4>
                    <ul class="text-slate-400 text-sm space-y-1">
                        <li>• Korupsi & Gratifikasi</li>
                        <li>• Fraud & Penipuan</li>
                        <li>• Penyimpangan Pengadaan</li>
                        <li>• Pelanggaran Etika</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">Perlindungan Pelapor</h4>
                    <ul class="text-slate-400 text-sm space-y-1">
                        <li>✓ Kerahasiaan identitas</li>
                        <li>✓ Perlindungan dari retaliasi</li>
                        <li>✓ Komunikasi dua arah aman</li>
                        <li>✓ Penanganan independen</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-slate-700 mt-8 pt-6 text-center text-slate-400 text-sm">
                © 2024 BPKH - Badan Pengelola Keuangan Haji. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Configuration
        const API_URL = localStorage.getItem('wbs_api_url') || '';
        let currentTicketId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Toggle contact section based on anonymous checkbox
            document.getElementById('is_anonymous').addEventListener('change', (e) => {
                const contactSection = document.getElementById('contact-section');
                if (e.target.checked) {
                    contactSection.classList.add('hidden');
                } else {
                    contactSection.classList.remove('hidden');
                }
            });
        });

        // Tab Navigation
        function showTab(tab) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Reset tab buttons
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white');
                el.classList.add('bg-white', 'text-slate-600');
            });

            // Show selected content
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            // Highlight selected tab
            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.remove('bg-white', 'text-slate-600');
            activeTab.classList.add('bg-emerald-600', 'text-white');
        }

        // Submit Report
        async function submitReport(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Mengirim...';
            lucide.createIcons();

            const formData = {
                channel: "WEB",
                is_anonymous: document.getElementById('is_anonymous').checked,
                reporter_contact: document.getElementById('reporter_contact').value || null,
                subject: document.getElementById('subject').value,
                description: document.getElementById('description').value,
                incident_date: document.getElementById('incident_date').value || null,
                incident_location: document.getElementById('incident_location').value || null,
                parties_involved: document.getElementById('parties_involved').value 
                    ? document.getElementById('parties_involved').value.split(',').map(s => s.trim())
                    : []
            };

            try {
                const response = await fetch(`${API_URL}/api/v1/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Gagal mengirim laporan');
                }

                const result = await response.json();
                
                // Show success modal
                document.getElementById('result-ticket-id').textContent = result.ticket_id;
                currentTicketId = result.ticket_id;
                document.getElementById('success-modal').classList.remove('hidden');
                
                // Reset form
                document.getElementById('report-form').reset();
                document.getElementById('is_anonymous').checked = true;
                document.getElementById('contact-section').classList.add('hidden');

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i> Kirim Laporan';
                lucide.createIcons();
            }
        }

        // Track Report
        async function trackReport() {
            const ticketId = document.getElementById('ticket_id').value.trim().toUpperCase();
            
            if (!ticketId || ticketId.length < 8) {
                alert('Masukkan nomor tiket yang valid');
                return;
            }

            const resultDiv = document.getElementById('track-result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                    <p class="mt-4 text-slate-600">Mencari laporan...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/api/v1/tickets/lookup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_id: ticketId.replace('WBS-', '') })
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Nomor tiket tidak ditemukan');
                    }
                    throw new Error('Gagal mencari laporan');
                }

                const result = await response.json();
                currentTicketId = ticketId;
                
                resultDiv.innerHTML = `
                    <div class="bg-slate-50 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <p class="text-sm text-slate-500">Nomor Tiket</p>
                                <p class="text-xl font-mono font-bold text-slate-800">${result.ticket_id}</p>
                            </div>
                            <span class="px-4 py-2 rounded-full text-sm font-medium ${getStatusClass(result.status)}">
                                ${result.status}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-slate-500">Status</p>
                                <p class="text-slate-800 font-medium">${result.status_description || getStatusDescription(result.status)}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Terakhir Diperbarui</p>
                                <p class="text-slate-800">${formatDate(result.last_updated)}</p>
                            </div>
                        </div>
                    </div>
                `;

                // Show message section if report is open
                if (result.can_add_info) {
                    document.getElementById('message-section').classList.remove('hidden');
                    loadMessages(ticketId);
                } else {
                    document.getElementById('message-section').classList.add('hidden');
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <i data-lucide="alert-circle" class="w-12 h-12 text-red-400 mx-auto mb-3"></i>
                        <p class="text-red-700 font-medium">${error.message}</p>
                        <p class="text-red-600 text-sm mt-1">Pastikan nomor tiket yang dimasukkan sudah benar</p>
                    </div>
                `;
                lucide.createIcons();
                document.getElementById('message-section').classList.add('hidden');
            }
        }

        // Load Messages
        async function loadMessages(ticketId) {
            const historyDiv = document.getElementById('message-history');
            
            try {
                const response = await fetch(`${API_URL}/api/v1/tickets/${ticketId}/messages`);
                if (!response.ok) throw new Error('Gagal memuat pesan');
                
                const messages = await response.json();
                
                if (messages.length === 0) {
                    historyDiv.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">Belum ada pesan</p>';
                    return;
                }

                historyDiv.innerHTML = messages.map(msg => `
                    <div class="flex ${msg.sender_type === 'REPORTER' ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] px-4 py-2 rounded-lg ${msg.sender_type === 'REPORTER' ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-800'}">
                            <p class="text-sm">${msg.content}</p>
                            <p class="text-xs ${msg.sender_type === 'REPORTER' ? 'text-emerald-100' : 'text-slate-400'} mt-1">
                                ${formatDateTime(msg.created_at)}
                            </p>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                historyDiv.innerHTML = '<p class="text-red-500 text-sm text-center py-4">Gagal memuat pesan</p>';
            }
        }

        // Send Message
        async function sendMessage() {
            const messageInput = document.getElementById('new_message');
            const content = messageInput.value.trim();
            
            if (!content || !currentTicketId) return;

            try {
                const response = await fetch(`${API_URL}/api/v1/tickets/${currentTicketId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (!response.ok) throw new Error('Gagal mengirim pesan');

                messageInput.value = '';
                loadMessages(currentTicketId);

            } catch (error) {
                alert('Gagal mengirim pesan: ' + error.message);
            }
        }

        // Helpers
        function getStatusClass(status) {
            const classes = {
                'NEW': 'bg-blue-100 text-blue-700',
                'REVIEWING': 'bg-purple-100 text-purple-700',
                'NEED_INFO': 'bg-yellow-100 text-yellow-700',
                'INVESTIGATING': 'bg-indigo-100 text-indigo-700',
                'ESCALATED': 'bg-red-100 text-red-700',
                'CLOSED_PROVEN': 'bg-green-100 text-green-700',
                'CLOSED_NOT_PROVEN': 'bg-slate-100 text-slate-700',
                'CLOSED_INVALID': 'bg-slate-100 text-slate-700'
            };
            return classes[status] || 'bg-slate-100 text-slate-700';
        }

        function getStatusDescription(status) {
            const descriptions = {
                'NEW': 'Laporan baru diterima, menunggu review awal',
                'REVIEWING': 'Laporan sedang direview oleh tim',
                'NEED_INFO': 'Membutuhkan informasi tambahan dari pelapor',
                'INVESTIGATING': 'Sedang dalam proses investigasi',
                'ESCALATED': 'Laporan telah dieskalasi ke pihak berwenang',
                'CLOSED_PROVEN': 'Kasus ditutup - Dugaan terbukti',
                'CLOSED_NOT_PROVEN': 'Kasus ditutup - Tidak cukup bukti',
                'CLOSED_INVALID': 'Kasus ditutup - Tidak valid'
            };
            return descriptions[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('id-ID', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
        }

        function copyTicketId() {
            const ticketId = document.getElementById('result-ticket-id').textContent;
            navigator.clipboard.writeText(ticketId).then(() => {
                alert('Nomor tiket disalin!');
            });
        }
    </script>
</body>
</html>

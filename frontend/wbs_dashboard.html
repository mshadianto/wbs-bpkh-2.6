<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS BPKH - Dashboard Amanah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        islamic: {
                            green: '#006B3F',
                            gold: '#C9A227',
                            dark: '#1A3A2F',
                            light: '#E8F5E9',
                            cream: '#FDF8E7',
                            sidebar: '#0D2818'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-arabic { font-family: 'Amiri', serif; }
        .sidebar { transition: width 0.3s ease; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,107,63,0.15); }
        .severity-critical { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .severity-high { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .severity-medium { background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%); }
        .severity-low { background: linear-gradient(135deg, #006B3F 0%, #004D2C 100%); }
        .status-badge { padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #E8F5E9; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #006B3F; border-radius: 3px; }

        /* Islamic Pattern for Sidebar */
        .islamic-sidebar {
            background: linear-gradient(180deg, #0D2818 0%, #1A3A2F 100%);
            position: relative;
        }
        .islamic-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23C9A227' fill-opacity='0.05'%3E%3Cpath d='M30 0l30 30-30 30L0 30 30 0zm0 10L10 30l20 20 20-20-20-20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .gold-border { border-color: #C9A227; }
    </style>
</head>
<body class="bg-islamic-cream">
    <!-- Global Loading Overlay -->
    <div id="global-loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 shadow-2xl flex flex-col items-center gap-4 max-w-sm">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-green-200 border-t-green-700"></div>
            <p id="loading-message" class="text-gray-700 font-medium text-center">Memproses...</p>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[9998] flex flex-col gap-2 pointer-events-none"></div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar with Islamic Design -->
        <aside id="sidebar" class="sidebar w-64 islamic-sidebar text-white flex flex-col relative z-10">
            <!-- Logo -->
            <div class="p-6 border-b border-islamic-gold/20 relative">
                <div class="text-center mb-2">
                    <span class="text-islamic-gold font-arabic text-lg">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-islamic-gold/20 rounded-xl flex items-center justify-center border border-islamic-gold/30">
                        <svg class="w-7 h-7 text-islamic-gold" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2C8 2 4 6 4 10v10h16V10c0-4-4-8-8-8z"/>
                            <path d="M12 2v4"/>
                            <circle cx="12" cy="1" r="1" fill="currentColor"/>
                            <path d="M8 22v-6a4 4 0 018 0v6"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">WBS BPKH</h1>
                        <p class="text-xs text-islamic-gold">Dashboard Amanah</p>
                    </div>
                </div>
            </div>

            <!-- Navigation (Role-based) -->
            <nav class="flex-1 p-4 space-y-2 relative">
                <a href="#" onclick="showPage('dashboard')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg bg-islamic-gold/20 text-white border border-islamic-gold/30">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="showPage('reports')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span>Laporan</span>
                    <span id="report-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </a>
                <a href="#" onclick="showPage('inbox')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                    <i data-lucide="inbox" class="w-5 h-5"></i>
                    <span>Inbox</span>
                </a>

                <!-- Intake Officer Section: INTAKE_OFFICER, ADMIN -->
                <div id="menu-intake-section" class="pt-4 mt-4 border-t border-islamic-gold/20 hidden">
                    <p class="px-4 text-xs text-islamic-gold uppercase tracking-wider mb-2">€ù Intake</p>
                    <a href="#" onclick="showPage('intake-queue')" id="menu-intake-queue" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="inbox" class="w-5 h-5"></i>
                        <span>Antrian Laporan</span>
                        <span id="intake-queue-badge" class="ml-auto bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                    </a>
                    <a href="#" onclick="showPage('intake-review')" id="menu-intake-review" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                        <span>Review & Validasi</span>
                    </a>
                    <a href="#" onclick="showPage('intake-communicate')" id="menu-intake-communicate" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                        <span>Komunikasi Pelapor</span>
                    </a>
                    <a href="#" onclick="showPage('intake-escalate')" id="menu-intake-escalate" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="arrow-up-circle" class="w-5 h-5"></i>
                        <span>Eskalasi</span>
                    </a>
                </div>

                <!-- Manager Section: MANAGER, ADMIN -->
                <div id="menu-manager-section" class="pt-4 mt-4 border-t border-islamic-gold/20 hidden">
                    <p class="px-4 text-xs text-islamic-gold uppercase tracking-wider mb-2">€ù Manajemen</p>
                    <a href="#" onclick="showPage('mgr-overview')" id="menu-mgr-overview" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Executive Overview</span>
                    </a>
                    <a href="#" onclick="showPage('mgr-escalation')" id="menu-mgr-escalation" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        <span>Eskalasi & Approval</span>
                        <span id="escalation-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                    </a>
                    <a href="#" onclick="showPage('mgr-sla')" id="menu-mgr-sla" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                        <span>SLA Monitoring</span>
                    </a>
                    <a href="#" onclick="showPage('mgr-risk')" id="menu-mgr-risk" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="shield-alert" class="w-5 h-5"></i>
                        <span>Risk Dashboard</span>
                    </a>
                    <a href="#" onclick="showPage('mgr-performance')" id="menu-mgr-performance" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <span>Performance</span>
                    </a>
                </div>

                <!-- Investigation Section: INVESTIGATOR, MANAGER, ADMIN -->
                <div id="menu-investigation-section" class="pt-4 mt-4 border-t border-islamic-gold/20 hidden">
                    <p class="px-4 text-xs text-islamic-gold uppercase tracking-wider mb-2">€ù Investigasi</p>
                    <a href="#" onclick="showPage('inv-dashboard')" id="menu-inv-dashboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        <span>Kasus Aktif</span>
                        <span id="active-case-badge" class="ml-auto bg-indigo-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                    </a>
                    <a href="#" onclick="showPage('inv-intake')" id="menu-inv-intake" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                        <span>Intake & Mandat</span>
                    </a>
                    <a href="#" onclick="showPage('inv-analysis')" id="menu-inv-analysis" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="file-search" class="w-5 h-5"></i>
                        <span>Analisis Data</span>
                    </a>
                    <a href="#" onclick="showPage('inv-evidence')" id="menu-inv-evidence" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="folder-lock" class="w-5 h-5"></i>
                        <span>Bukti & CoC</span>
                    </a>
                    <a href="#" onclick="showPage('inv-interview')" id="menu-inv-interview" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Wawancara</span>
                    </a>
                    <a href="#" onclick="showPage('inv-findings')" id="menu-inv-findings" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="file-check" class="w-5 h-5"></i>
                        <span>Temuan & Laporan</span>
                    </a>
                </div>

                <!-- AI Analysis - Role Specific -->
                <!-- INTAKE_OFFICER: AI Screening -->
                <a href="#" onclick="showPage('ai-screening')" id="menu-ai-screening" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                    <i data-lucide="scan-search" class="w-5 h-5"></i>
                    <span>AI Screening</span>
                </a>
                <!-- INVESTIGATOR: AI Deep Analysis -->
                <a href="#" onclick="showPage('ai-deep-analysis')" id="menu-ai-deep-analysis" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                    <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                    <span>AI Deep Analysis</span>
                </a>
                <!-- MANAGER: AI Insights -->
                <a href="#" onclick="showPage('ai-insights')" id="menu-ai-insights" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                    <i data-lucide="chart-network" class="w-5 h-5"></i>
                    <span>AI Insights</span>
                </a>
                <!-- ADMIN: All AI Analysis (legacy) -->
                <a href="#" onclick="showPage('analysis')" id="menu-analysis" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                    <i data-lucide="brain" class="w-5 h-5"></i>
                    <span>AI Analysis</span>
                </a>
                <!-- Knowledge Base: ADMIN only -->
                <a href="#" onclick="showPage('knowledge')" id="menu-knowledge" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                    <i data-lucide="database" class="w-5 h-5"></i>
                    <span>Knowledge Base</span>
                </a>

                <!-- Settings Section: MANAGER, ADMIN -->
                <div id="menu-settings-section" class="pt-4 mt-4 border-t border-islamic-gold/20 hidden">
                    <p class="px-4 text-xs text-islamic-gold uppercase tracking-wider mb-2">€ù Settings</p>
                    <a href="#" onclick="showPage('settings')" id="menu-settings" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Pengaturan</span>
                    </a>
                    <a href="#" onclick="showPage('audit')" id="menu-audit" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <span>Audit Log</span>
                    </a>
                    <!-- User Management: ADMIN only -->
                    <a href="#" onclick="showPage('users')" id="menu-users" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-emerald-100 hover:bg-islamic-gold/10 hover:text-white transition hidden">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Manajemen User</span>
                    </a>
                </div>
            </nav>

            <!-- User -->
            <div class="p-4 border-t border-islamic-gold/20 relative">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-islamic-gold/20 rounded-full flex items-center justify-center border border-islamic-gold/30">
                        <span class="font-semibold text-islamic-gold">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </span>
                    </div>
                    <div class="flex-1">
                        <p id="user-name" class="font-medium text-sm">Loading...</p>
                        <p id="user-role" class="text-xs text-islamic-gold">-</p>
                    </div>
                    <button onclick="logout()" class="text-emerald-300 hover:text-red-400 transition" title="Logout">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-white border-b border-islamic-green/20 px-6 py-4 sticky top-0 z-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="lg:hidden text-islamic-dark">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <div>
                            <h2 id="page-title" class="text-xl font-semibold text-islamic-dark">Dashboard</h2>
                            <p class="text-xs text-islamic-gold font-arabic">ÿ•ŸêŸÜŸéŸëÿß ŸÑŸêŸÑŸéŸëŸáŸê ŸàŸéÿ•ŸêŸÜŸéŸëÿß ÿ•ŸêŸÑŸéŸäŸíŸáŸê ÿ±Ÿéÿßÿ¨ŸêÿπŸèŸàŸÜŸé</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <input type="text" placeholder="Cari laporan..." class="pl-10 pr-4 py-2 border border-islamic-green/20 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-islamic-green focus:border-transparent">
                            <i data-lucide="search" class="w-5 h-5 text-islamic-green/50 absolute left-3 top-2.5"></i>
                        </div>
                        <button class="relative p-2 text-islamic-dark hover:bg-islamic-light rounded-lg">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="p-6">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content fade-in">
                    <!-- Role-specific Welcome Banner -->
                    <div id="role-banner" class="bg-gradient-to-r from-islamic-green to-islamic-dark text-white rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <span class="text-islamic-gold text-3xl font-arabic">€û</span>
                                <div>
                                    <p id="role-welcome" class="font-semibold text-lg">Selamat Datang</p>
                                    <p id="role-description" class="text-emerald-100 text-sm">Dashboard WBS BPKH</p>
                                </div>
                            </div>
                            <div id="role-focus" class="text-right">
                                <p class="text-islamic-gold font-arabic text-lg">"ŸàŸéÿ™ŸéÿπŸéÿßŸàŸéŸÜŸèŸàÿß ÿπŸéŸÑŸéŸâ ÿßŸÑŸíÿ®Ÿêÿ±ŸêŸë ŸàŸéÿßŸÑÿ™ŸéŸëŸÇŸíŸàŸéŸâŸ∞"</p>
                                <p class="text-emerald-100 text-xs">QS. Al-Maidah: 2</p>
                            </div>
                        </div>
                    </div>

                    <!-- Role-specific Quick Actions -->
                    <div id="quick-actions" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
                        <!-- Will be populated based on role -->
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all border border-islamic-green/10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-islamic-green/10 rounded-lg flex items-center justify-center">
                                    <i data-lucide="file-text" class="w-6 h-6 text-islamic-green"></i>
                                </div>
                                <span class="text-islamic-green text-sm font-medium flex items-center gap-1">
                                    <i data-lucide="trending-up" class="w-4 h-4"></i> +12%
                                </span>
                            </div>
                            <h3 id="stat-total" class="text-3xl font-bold text-islamic-dark">0</h3>
                            <p class="text-slate-500 text-sm">Total Laporan</p>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all border border-islamic-gold/20">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-islamic-gold/10 rounded-lg flex items-center justify-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-islamic-gold"></i>
                                </div>
                            </div>
                            <h3 id="stat-pending" class="text-3xl font-bold text-islamic-dark">0</h3>
                            <p class="text-slate-500 text-sm">Menunggu Review</p>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all border border-red-200">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                            </div>
                            <h3 id="stat-sla-risk" class="text-3xl font-bold text-islamic-dark">0</h3>
                            <p class="text-slate-500 text-sm">SLA Berisiko</p>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all border border-islamic-green/20">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-islamic-green/10 rounded-lg flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-islamic-green"></i>
                                </div>
                            </div>
                            <h3 id="stat-closed" class="text-3xl font-bold text-islamic-dark">0</h3>
                            <p class="text-slate-500 text-sm">Selesai Bulan Ini</p>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Laporan per Kategori
                            </h3>
                            <canvas id="categoryChart" height="200"></canvas>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Laporan per Severity
                            </h3>
                            <canvas id="severityChart" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Recent Reports & Activity -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-islamic-green/10">
                            <div class="p-6 border-b border-islamic-green/10">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Laporan Terbaru
                                    </h3>
                                    <button onclick="showPage('reports')" class="text-islamic-green text-sm font-medium hover:underline">Lihat Semua</button>
                                </div>
                            </div>
                            <div id="recent-reports" class="divide-y divide-islamic-green/10">
                                <!-- Reports will be loaded here -->
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-islamic-green/10">
                            <div class="p-6 border-b border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Aktivitas Terkini
                                </h3>
                            </div>
                            <div id="recent-activity" class="p-4 space-y-4 max-h-96 overflow-y-auto scrollbar-thin">
                                <!-- Activity will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="page-reports" class="page-content hidden fade-in">
                    <!-- Filters -->
                    <div class="bg-white rounded-xl p-4 shadow-sm mb-6 border border-islamic-green/10">
                        <div class="flex flex-wrap items-center gap-4">
                            <select id="filter-status" class="px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                <option value="">Semua Status</option>
                                <option value="NEW">Baru</option>
                                <option value="REVIEWING">Sedang Direview</option>
                                <option value="NEED_INFO">Butuh Info</option>
                                <option value="INVESTIGATING">Investigasi</option>
                                <option value="ESCALATED">Dieskalasi</option>
                            </select>
                            <select id="filter-severity" class="px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                <option value="">Semua Severity</option>
                                <option value="CRITICAL">Critical</option>
                                <option value="HIGH">High</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="LOW">Low</option>
                            </select>
                            <select id="filter-category" class="px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                <option value="">Semua Kategori</option>
                                <option value="FRAUD">Fraud</option>
                                <option value="CORRUPTION">Korupsi</option>
                                <option value="GRATIFICATION">Gratifikasi</option>
                                <option value="COI">Conflict of Interest</option>
                                <option value="PROCUREMENT">Pengadaan</option>
                            </select>
                            <select id="filter-channel" class="px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                <option value="">Semua Sumber</option>
                                <option value="WEB">üåê Web Portal</option>
                                <option value="WHATSAPP">üí¨ WhatsApp</option>
                                <option value="EMAIL">üìß Email</option>
                            </select>
                            <button onclick="loadReports()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark transition flex items-center gap-2">
                                <i data-lucide="filter" class="w-4 h-4"></i>
                                Filter
                            </button>
                            <button onclick="exportReports()" class="px-4 py-2 border border-islamic-green/20 rounded-lg hover:bg-islamic-light transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <!-- Reports Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-islamic-green/10">
                        <table class="w-full">
                            <thead class="bg-islamic-light border-b border-islamic-green/20">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Ticket ID</th>
                                    <th class="px-4 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Sumber</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Subject</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Kategori</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Severity</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Fraud Score</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-islamic-dark uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table" class="divide-y divide-islamic-green/10">
                                <!-- Reports will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-4">
                        <p class="text-sm text-slate-600">Menampilkan <span id="showing-count">0</span> dari <span id="total-count">0</span> laporan</p>
                        <div class="flex items-center gap-2">
                            <button onclick="prevPage()" class="px-3 py-2 border border-islamic-green/20 rounded-lg hover:bg-islamic-light disabled:opacity-50">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <span id="page-info" class="px-4 py-2 text-sm">Halaman 1</span>
                            <button onclick="nextPage()" class="px-3 py-2 border border-islamic-green/20 rounded-lg hover:bg-islamic-light disabled:opacity-50">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Detail Modal -->
                <div id="report-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden border-2 border-islamic-gold/30">
                        <div class="p-6 border-b border-islamic-green/20 flex items-center justify-between bg-islamic-light">
                            <div>
                                <h3 class="text-xl font-semibold text-islamic-dark flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Detail Laporan
                                </h3>
                                <p id="modal-ticket-id" class="text-sm text-slate-500">Ticket: -</p>
                            </div>
                            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
                            <div id="modal-content">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        <div class="p-6 border-t border-islamic-green/20 flex items-center justify-between bg-islamic-light">
                            <div class="flex items-center gap-2">
                                <button onclick="runAnalysis()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                                    <i data-lucide="brain" class="w-4 h-4"></i>
                                    Run AI Analysis
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="modal-status" class="px-4 py-2 border border-islamic-green/20 rounded-lg">
                                    <option value="REVIEWING">Sedang Direview</option>
                                    <option value="NEED_INFO">Butuh Info Tambahan</option>
                                    <option value="INVESTIGATING">Lanjut Investigasi</option>
                                    <option value="ESCALATED">Eskalasi</option>
                                    <option value="CLOSED_PROVEN">Tutup - Terbukti</option>
                                    <option value="CLOSED_NOT_PROVEN">Tutup - Tidak Terbukti</option>
                                    <option value="CLOSED_INVALID">Tutup - Invalid</option>
                                </select>
                                <button onclick="updateStatus()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark transition">
                                    Update Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Page -->
                <div id="page-analysis" class="page-content hidden fade-in">
                    <div class="bg-white rounded-xl p-6 shadow-sm mb-6 border border-islamic-green/10">
                        <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            AI Analysis Engine
                        </h3>
                        <p class="text-slate-600 mb-4">Sistem multi-agent AI untuk menganalisis laporan pengaduan dengan framework 4W+1H, Fraud Triangle Analysis, dan Compliance Check.</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="p-4 bg-islamic-light rounded-lg border border-islamic-green/20">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-islamic-green/20 rounded-lg flex items-center justify-center">
                                        <i data-lucide="scan" class="w-5 h-5 text-islamic-green"></i>
                                    </div>
                                    <h4 class="font-medium text-islamic-dark">Intake Agent</h4>
                                </div>
                                <p class="text-sm text-slate-600">Parsing laporan dengan framework 4W+1H (What, Who, When, Where, How)</p>
                            </div>
                            <div class="p-4 bg-islamic-light rounded-lg border border-islamic-green/20">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="search" class="w-5 h-5 text-red-600"></i>
                                    </div>
                                    <h4 class="font-medium text-islamic-dark">Analysis Agent</h4>
                                </div>
                                <p class="text-sm text-slate-600">Fraud Triangle Analysis: Opportunity, Pressure, Rationalization</p>
                            </div>
                            <div class="p-4 bg-islamic-light rounded-lg border border-islamic-green/20">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-islamic-gold/20 rounded-lg flex items-center justify-center">
                                        <i data-lucide="shield" class="w-5 h-5 text-islamic-gold"></i>
                                    </div>
                                    <h4 class="font-medium text-islamic-dark">Compliance Agent</h4>
                                </div>
                                <p class="text-sm text-slate-600">Pengecekan regulasi: UU Tipikor, PP PNS, Perpres PBJ, UU PDP</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <input type="text" id="analysis-report-id" placeholder="Masukkan Report ID" class="flex-1 px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                            <button onclick="runAnalysisById()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                                <i data-lucide="play" class="w-4 h-4"></i>
                                Jalankan Analisis
                            </button>
                        </div>
                    </div>

                    <div id="analysis-result" class="hidden">
                        <!-- Analysis result will be shown here -->
                    </div>
                </div>

                <!-- ============================================== -->
                <!-- ROLE-SPECIFIC AI ANALYSIS PAGES                -->
                <!-- ============================================== -->

                <!-- AI Screening Tool (INTAKE_OFFICER) -->
                <div id="page-ai-screening" class="page-content hidden fade-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-6 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="scan-search" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">AI Screening Tool</h2>
                                <p class="text-blue-100">Quick triage dan klasifikasi otomatis laporan masuk</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Screening Queue -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Quick Screen Panel -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Screening Cepat
                                </h3>
                                <div class="flex gap-4 mb-4">
                                    <select id="screen-ticket-select" class="flex-1 px-4 py-2 border border-islamic-green/20 rounded-lg" onchange="loadTicketForScreening()">
                                        <option value="">-- Pilih Laporan Baru --</option>
                                    </select>
                                    <button onclick="runQuickScreen()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                        <i data-lucide="zap" class="w-4 h-4"></i>
                                        Screen Sekarang
                                    </button>
                                </div>
                                <div id="screen-report-preview" class="p-4 bg-slate-50 rounded-lg min-h-[100px]">
                                    <p class="text-slate-500 text-center">Pilih laporan untuk melihat preview</p>
                                </div>
                            </div>

                            <!-- Screening Results -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Hasil Screening AI
                                </h3>
                                <div id="screen-results" class="space-y-4">
                                    <div class="p-8 bg-slate-50 rounded-lg text-center">
                                        <i data-lucide="scan" class="w-12 h-12 text-slate-300 mx-auto mb-3"></i>
                                        <p class="text-slate-500">Hasil screening akan muncul di sini</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-Categorization Results -->
                            <div id="screen-categorization" class="hidden bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4">Kategorisasi Otomatis</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="p-4 bg-blue-50 rounded-lg">
                                        <p class="text-xs text-blue-600 font-medium mb-1">KATEGORI TERDETEKSI</p>
                                        <p id="screen-category" class="text-lg font-bold text-blue-800">-</p>
                                    </div>
                                    <div class="p-4 bg-purple-50 rounded-lg">
                                        <p class="text-xs text-purple-600 font-medium mb-1">CONFIDENCE SCORE</p>
                                        <p id="screen-confidence" class="text-lg font-bold text-purple-800">-</p>
                                    </div>
                                    <div class="p-4 bg-amber-50 rounded-lg">
                                        <p class="text-xs text-amber-600 font-medium mb-1">PRIORITY SCORE</p>
                                        <p id="screen-priority" class="text-lg font-bold text-amber-800">-</p>
                                    </div>
                                    <div class="p-4 bg-green-50 rounded-lg">
                                        <p class="text-xs text-green-600 font-medium mb-1">COMPLETENESS</p>
                                        <p id="screen-completeness" class="text-lg font-bold text-green-800">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Screening Tools Sidebar -->
                        <div class="space-y-6">
                            <!-- AI Features -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4">Fitur AI Screening</h4>
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                        <i data-lucide="tags" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                        <div>
                                            <p class="font-medium text-blue-800 text-sm">Auto-Categorization</p>
                                            <p class="text-xs text-blue-600">Klasifikasi kategori pelanggaran otomatis</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3 p-3 bg-purple-50 rounded-lg">
                                        <i data-lucide="copy-check" class="w-5 h-5 text-purple-600 mt-0.5"></i>
                                        <div>
                                            <p class="font-medium text-purple-800 text-sm">Duplicate Detection</p>
                                            <p class="text-xs text-purple-600">Deteksi laporan serupa/duplikat</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3 p-3 bg-amber-50 rounded-lg">
                                        <i data-lucide="arrow-up-circle" class="w-5 h-5 text-amber-600 mt-0.5"></i>
                                        <div>
                                            <p class="font-medium text-amber-800 text-sm">Priority Scoring</p>
                                            <p class="text-xs text-amber-600">Skor prioritas berdasarkan urgency</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3 p-3 bg-green-50 rounded-lg">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mt-0.5"></i>
                                        <div>
                                            <p class="font-medium text-green-800 text-sm">Completeness Check</p>
                                            <p class="text-xs text-green-600">Cek kelengkapan informasi 5W1H</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Duplicate Alerts -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3 flex items-center gap-2">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-amber-500"></i>
                                    Potensi Duplikat
                                </h4>
                                <div id="screen-duplicates" class="space-y-2">
                                    <p class="text-sm text-slate-500">Tidak ada potensi duplikat terdeteksi</p>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="bg-gradient-to-br from-islamic-green to-islamic-dark text-white rounded-xl p-6">
                                <h4 class="font-semibold mb-4">Tindakan Cepat</h4>
                                <div class="space-y-2">
                                    <button onclick="applyScreeningResult()" class="w-full px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 text-sm flex items-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                        Terapkan Hasil Screening
                                    </button>
                                    <button onclick="showPage('intake-review')" class="w-full px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 text-sm flex items-center gap-2">
                                        <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                                        Lanjut ke Review
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Deep Analysis (INVESTIGATOR) -->
                <div id="page-ai-deep-analysis" class="page-content hidden fade-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-xl p-6 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="brain-circuit" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">AI Deep Analysis</h2>
                                <p class="text-indigo-100">Forensic analysis mendalam dengan multi-agent AI</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Analysis Pipeline -->
                        <div class="lg:col-span-3 space-y-6">
                            <!-- Case Selection -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Pilih Kasus untuk Analisis
                                    </h3>
                                </div>
                                <div class="flex gap-4">
                                    <select id="deep-case-select" class="flex-1 px-4 py-2 border border-islamic-green/20 rounded-lg" onchange="loadCaseForDeepAnalysis()">
                                        <option value="">-- Pilih Kasus Aktif --</option>
                                    </select>
                                    <button onclick="runDeepAnalysis()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                                        <i data-lucide="play" class="w-4 h-4"></i>
                                        Jalankan Deep Analysis
                                    </button>
                                </div>
                            </div>

                            <!-- Multi-Agent Pipeline Status -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4">Pipeline Multi-Agent AI</h3>
                                <div class="space-y-3" id="deep-pipeline-status">
                                    <div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg">
                                        <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                                            <span class="text-slate-500 font-bold">1</span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-700">Intake Agent</p>
                                            <p class="text-xs text-slate-500">Parsing 4W+1H (What, Who, When, Where, How)</p>
                                        </div>
                                        <span class="text-xs text-slate-400">Waiting</span>
                                    </div>
                                    <div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg">
                                        <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                                            <span class="text-slate-500 font-bold">2</span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-700">Analysis Agent</p>
                                            <p class="text-xs text-slate-500">Fraud Triangle: Opportunity, Pressure, Rationalization</p>
                                        </div>
                                        <span class="text-xs text-slate-400">Waiting</span>
                                    </div>
                                    <div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg">
                                        <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                                            <span class="text-slate-500 font-bold">3</span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-700">Compliance Agent</p>
                                            <p class="text-xs text-slate-500">Regulasi: UU Tipikor, PP PNS, Perpres PBJ</p>
                                        </div>
                                        <span class="text-xs text-slate-400">Waiting</span>
                                    </div>
                                    <div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg">
                                        <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                                            <span class="text-slate-500 font-bold">4</span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-700">Severity Agent</p>
                                            <p class="text-xs text-slate-500">Risk Assessment & SLA Mapping</p>
                                        </div>
                                        <span class="text-xs text-slate-400">Waiting</span>
                                    </div>
                                    <div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg">
                                        <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                                            <span class="text-slate-500 font-bold">5</span>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-slate-700">Recommendation Agent</p>
                                            <p class="text-xs text-slate-500">Action Items & Next Steps</p>
                                        </div>
                                        <span class="text-xs text-slate-400">Waiting</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Analysis Results Tabs -->
                            <div class="bg-white rounded-xl shadow-sm border border-islamic-green/10 overflow-hidden">
                                <div class="flex border-b border-islamic-green/10">
                                    <button onclick="showDeepTab('4w1h')" class="deep-tab flex-1 px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="4w1h">4W+1H</button>
                                    <button onclick="showDeepTab('fraud')" class="deep-tab flex-1 px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="fraud">Fraud Triangle</button>
                                    <button onclick="showDeepTab('compliance')" class="deep-tab flex-1 px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="compliance">Compliance</button>
                                    <button onclick="showDeepTab('timeline')" class="deep-tab flex-1 px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="timeline">Timeline</button>
                                    <button onclick="showDeepTab('patterns')" class="deep-tab flex-1 px-4 py-3 text-sm font-medium text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="patterns">Patterns</button>
                                </div>
                                <div class="p-6">
                                    <div id="deep-tab-content" class="min-h-[300px]">
                                        <div class="text-center py-12">
                                            <i data-lucide="brain-circuit" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
                                            <p class="text-slate-500">Jalankan deep analysis untuk melihat hasil</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Tools Sidebar -->
                        <div class="space-y-6">
                            <!-- Fraud Score Gauge -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4 text-center">Fraud Score</h4>
                                <div class="relative w-32 h-32 mx-auto">
                                    <svg class="w-full h-full transform -rotate-90">
                                        <circle cx="64" cy="64" r="56" stroke="#e2e8f0" stroke-width="12" fill="none"/>
                                        <circle id="deep-fraud-gauge" cx="64" cy="64" r="56" stroke="#6366f1" stroke-width="12" fill="none" stroke-dasharray="351.86" stroke-dashoffset="351.86" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="deep-fraud-score" class="text-3xl font-bold text-indigo-600">-</span>
                                    </div>
                                </div>
                                <p id="deep-fraud-level" class="text-center mt-2 text-sm text-slate-500">Belum dianalisis</p>
                            </div>

                            <!-- Evidence Correlation -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Evidence Correlation</h4>
                                <div id="deep-evidence-corr" class="space-y-2">
                                    <p class="text-sm text-slate-500">Belum ada korelasi bukti</p>
                                </div>
                            </div>

                            <!-- Similar Cases -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Kasus Serupa (RAG)</h4>
                                <div id="deep-similar-cases" class="space-y-2">
                                    <p class="text-sm text-slate-500">Tidak ditemukan kasus serupa</p>
                                </div>
                            </div>

                            <!-- Export Options -->
                            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white rounded-xl p-6">
                                <h4 class="font-semibold mb-3">Export Hasil</h4>
                                <div class="space-y-2">
                                    <button onclick="exportDeepAnalysis('pdf')" class="w-full px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 text-sm flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        Export PDF
                                    </button>
                                    <button onclick="exportDeepAnalysis('json')" class="w-full px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 text-sm flex items-center gap-2">
                                        <i data-lucide="file-json" class="w-4 h-4"></i>
                                        Export JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Dashboard (MANAGER) -->
                <div id="page-ai-insights" class="page-content hidden fade-in">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl p-6 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="chart-network" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">AI Insights Dashboard</h2>
                                <p class="text-emerald-100">Aggregate analytics dan predictive insights</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Insights -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Trend Analysis -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Trend Analysis
                                    </h3>
                                    <select id="insights-period" class="px-3 py-1 border border-islamic-green/20 rounded-lg text-sm" onchange="loadInsightsTrend()">
                                        <option value="7">7 Hari</option>
                                        <option value="30" selected>30 Hari</option>
                                        <option value="90">90 Hari</option>
                                    </select>
                                </div>
                                <div id="insights-trend-chart" class="h-64 flex items-center justify-center bg-slate-50 rounded-lg">
                                    <div class="text-center">
                                        <i data-lucide="trending-up" class="w-12 h-12 text-slate-300 mx-auto mb-2"></i>
                                        <p class="text-slate-500">Memuat trend data...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Distribution -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Distribusi Kategori Pelanggaran
                                </h3>
                                <div class="grid grid-cols-3 gap-4" id="insights-categories">
                                    <div class="text-center p-4 bg-red-50 rounded-lg">
                                        <p class="text-2xl font-bold text-red-600">0</p>
                                        <p class="text-xs text-slate-600">Korupsi</p>
                                    </div>
                                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                                        <p class="text-2xl font-bold text-orange-600">0</p>
                                        <p class="text-xs text-slate-600">Fraud</p>
                                    </div>
                                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                        <p class="text-2xl font-bold text-yellow-600">0</p>
                                        <p class="text-xs text-slate-600">COI</p>
                                    </div>
                                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                                        <p class="text-2xl font-bold text-purple-600">0</p>
                                        <p class="text-xs text-slate-600">Gratifikasi</p>
                                    </div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <p class="text-2xl font-bold text-blue-600">0</p>
                                        <p class="text-xs text-slate-600">Pelanggaran SOP</p>
                                    </div>
                                    <div class="text-center p-4 bg-slate-50 rounded-lg">
                                        <p class="text-2xl font-bold text-slate-600">0</p>
                                        <p class="text-xs text-slate-600">Lainnya</p>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Predictions -->
                            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-200">
                                <h3 class="font-semibold text-purple-800 mb-4 flex items-center gap-2">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    AI Predictive Insights
                                </h3>
                                <div id="insights-predictions" class="space-y-3">
                                    <div class="p-3 bg-white rounded-lg border border-purple-100">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="trending-up" class="w-4 h-4 text-purple-600"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-purple-800 text-sm">Prediksi Tren Naik</p>
                                                <p class="text-xs text-purple-600">Berdasarkan pola historis, laporan kategori Fraud diprediksi meningkat 15% bulan depan</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-purple-100">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-600"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-amber-800 text-sm">Area Risiko Tinggi</p>
                                                <p class="text-xs text-amber-600">Divisi Pengadaan menunjukkan pola anomali dalam 3 bulan terakhir</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Insights Sidebar -->
                        <div class="space-y-6">
                            <!-- AI Health Score -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4 text-center">Organizational Health Score</h4>
                                <div class="relative w-32 h-32 mx-auto">
                                    <svg class="w-full h-full transform -rotate-90">
                                        <circle cx="64" cy="64" r="56" stroke="#e2e8f0" stroke-width="12" fill="none"/>
                                        <circle id="insights-health-gauge" cx="64" cy="64" r="56" stroke="#10b981" stroke-width="12" fill="none" stroke-dasharray="351.86" stroke-dashoffset="105" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="insights-health-score" class="text-3xl font-bold text-emerald-600">72</span>
                                    </div>
                                </div>
                                <p class="text-center mt-2 text-sm text-emerald-600 font-medium">Good Standing</p>
                            </div>

                            <!-- Key Metrics -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4">Key AI Metrics</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-600">Avg Fraud Score</span>
                                        <span id="insights-avg-fraud" class="font-bold text-indigo-600">0.42</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-600">Detection Rate</span>
                                        <span id="insights-detection" class="font-bold text-green-600">78%</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-600">False Positive</span>
                                        <span id="insights-false-pos" class="font-bold text-amber-600">12%</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-600">AI Accuracy</span>
                                        <span id="insights-accuracy" class="font-bold text-emerald-600">86%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Top Risk Departments -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Top Risk Departments</h4>
                                <div id="insights-risk-depts" class="space-y-2">
                                    <div class="flex items-center justify-between p-2 bg-red-50 rounded">
                                        <span class="text-sm text-slate-700">Pengadaan</span>
                                        <span class="text-xs font-medium text-red-600">High</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-amber-50 rounded">
                                        <span class="text-sm text-slate-700">Keuangan</span>
                                        <span class="text-xs font-medium text-amber-600">Medium</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                                        <span class="text-sm text-slate-700">SDM</span>
                                        <span class="text-xs font-medium text-green-600">Low</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Generate Report -->
                            <div class="bg-gradient-to-br from-emerald-600 to-teal-600 text-white rounded-xl p-6">
                                <h4 class="font-semibold mb-3">Generate Report</h4>
                                <div class="space-y-2">
                                    <button onclick="generateInsightsReport('executive')" class="w-full px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 text-sm flex items-center gap-2">
                                        <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                                        Executive Summary
                                    </button>
                                    <button onclick="generateInsightsReport('detailed')" class="w-full px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 text-sm flex items-center gap-2">
                                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                        Detailed Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Base Page -->
                <div id="page-knowledge" class="page-content hidden fade-in">
                    <div class="bg-white rounded-xl p-6 shadow-sm mb-6 border border-islamic-green/10">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Knowledge Base
                                </h3>
                                <p class="text-sm text-slate-600">Regulasi dan dokumen referensi untuk RAG system</p>
                            </div>
                            <button onclick="loadKnowledgeBase()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark transition flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                Load Default Knowledge
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="knowledge-list">
                            <div class="p-4 border border-islamic-green/20 rounded-lg bg-islamic-light/50">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-islamic-green/20 rounded-lg flex items-center justify-center shrink-0">
                                        <i data-lucide="scale" class="w-5 h-5 text-islamic-green"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-islamic-dark">UU 31/1999 jo UU 20/2001</h4>
                                        <p class="text-sm text-slate-600">Tindak Pidana Korupsi</p>
                                        <span class="text-xs text-islamic-green">‚úì Loaded</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border border-islamic-green/20 rounded-lg bg-islamic-light/50">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center shrink-0">
                                        <i data-lucide="users" class="w-5 h-5 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-islamic-dark">PP 94/2021</h4>
                                        <p class="text-sm text-slate-600">Disiplin PNS</p>
                                        <span class="text-xs text-islamic-green">‚úì Loaded</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border border-islamic-green/20 rounded-lg bg-islamic-light/50">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-islamic-gold/20 rounded-lg flex items-center justify-center shrink-0">
                                        <i data-lucide="shopping-cart" class="w-5 h-5 text-islamic-gold"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-islamic-dark">Perpres 16/2018</h4>
                                        <p class="text-sm text-slate-600">Pengadaan Barang/Jasa</p>
                                        <span class="text-xs text-islamic-green">‚úì Loaded</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border border-islamic-green/20 rounded-lg bg-islamic-light/50">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center shrink-0">
                                        <i data-lucide="lock" class="w-5 h-5 text-red-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-islamic-dark">UU 27/2022</h4>
                                        <p class="text-sm text-slate-600">Perlindungan Data Pribadi</p>
                                        <span class="text-xs text-islamic-green">‚úì Loaded</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border border-islamic-green/20 rounded-lg bg-islamic-light/50">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-islamic-green/20 rounded-lg flex items-center justify-center shrink-0">
                                        <i data-lucide="shield-check" class="w-5 h-5 text-islamic-green"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-islamic-dark">ISO 37002:2021</h4>
                                        <p class="text-sm text-slate-600">Whistleblowing Management</p>
                                        <span class="text-xs text-islamic-green">‚úì Loaded</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inbox Page -->
                <div id="page-inbox" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]">
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-islamic-green/10">
                            <div class="p-4 border-b border-islamic-green/10 bg-islamic-light">
                                <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Percakapan
                                </h3>
                            </div>
                            <div id="inbox-list" class="divide-y divide-islamic-green/10 overflow-y-auto max-h-[calc(100vh-280px)] scrollbar-thin">
                                <div class="p-4 hover:bg-islamic-light cursor-pointer border-l-4 border-islamic-green">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-medium text-islamic-dark">WBS-A1B2C3D4</span>
                                        <span class="text-xs text-slate-400">2 jam lalu</span>
                                    </div>
                                    <p class="text-sm text-slate-600 truncate">Mohon update status laporan saya...</p>
                                    <span class="inline-block mt-1 text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">Belum Dibaca</span>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm overflow-hidden flex flex-col border border-islamic-green/10">
                            <div class="p-4 border-b border-islamic-green/10 bg-islamic-light">
                                <h3 class="font-semibold text-islamic-dark">Chat dengan Pelapor</h3>
                                <p class="text-sm text-slate-500">Ticket: WBS-A1B2C3D4</p>
                            </div>
                            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 scrollbar-thin">
                                <div class="flex justify-start">
                                    <div class="bg-islamic-light rounded-lg px-4 py-2 max-w-[70%]">
                                        <p class="text-islamic-dark">Selamat pagi, mohon informasi status laporan saya.</p>
                                        <span class="text-xs text-slate-400">10:30</span>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <div class="bg-islamic-green text-white rounded-lg px-4 py-2 max-w-[70%]">
                                        <p>Laporan Anda sedang dalam proses review oleh tim UP1.</p>
                                        <span class="text-xs text-emerald-200">10:35</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-islamic-green/10">
                                <div class="flex items-center gap-2">
                                    <input type="text" id="chat-input" placeholder="Ketik pesan..." class="flex-1 px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                    <button onclick="sendChatMessage()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark transition">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="page-settings" class="page-content hidden fade-in">
                    <div class="max-w-2xl">
                        <div class="bg-white rounded-xl p-6 shadow-sm mb-6 border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Pengaturan API
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">API Base URL</label>
                                    <input type="text" id="api-url" value="" placeholder="Kosongkan untuk relative URL" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                </div>
                                <button onclick="saveSettings()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark transition">
                                    Simpan Pengaturan
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Pengaturan SLA
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-4 gap-4 text-sm font-medium text-islamic-dark pb-2 border-b border-islamic-green/20">
                                    <div>Severity</div>
                                    <div>Response</div>
                                    <div>Review</div>
                                    <div>Investigation</div>
                                </div>
                                <div class="grid grid-cols-4 gap-4 text-sm">
                                    <div class="font-medium text-red-600">CRITICAL</div>
                                    <div>4 jam</div>
                                    <div>1 hari</div>
                                    <div>7 hari</div>
                                </div>
                                <div class="grid grid-cols-4 gap-4 text-sm">
                                    <div class="font-medium text-orange-600">HIGH</div>
                                    <div>24 jam</div>
                                    <div>3 hari</div>
                                    <div>14 hari</div>
                                </div>
                                <div class="grid grid-cols-4 gap-4 text-sm">
                                    <div class="font-medium text-yellow-600">MEDIUM</div>
                                    <div>72 jam</div>
                                    <div>7 hari</div>
                                    <div>30 hari</div>
                                </div>
                                <div class="grid grid-cols-4 gap-4 text-sm">
                                    <div class="font-medium text-islamic-green">LOW</div>
                                    <div>168 jam</div>
                                    <div>14 hari</div>
                                    <div>90 hari</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Page -->
                <div id="page-audit" class="page-content hidden fade-in">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-islamic-green/10">
                        <div class="p-4 border-b border-islamic-green/10 bg-islamic-light">
                            <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Audit Trail
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-islamic-light">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Timestamp</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Action</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Resource</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-table" class="divide-y divide-islamic-green/10">
                                    <tr>
                                        <td class="px-6 py-4 text-sm text-slate-600">2024-12-30 14:30:00</td>
                                        <td class="px-6 py-4 text-sm text-islamic-dark">admin@bpkh.go.id</td>
                                        <td class="px-6 py-4"><span class="status-badge bg-islamic-green/20 text-islamic-green">STATUS_UPDATE</span></td>
                                        <td class="px-6 py-4 text-sm text-slate-600">WBS-A1B2C3D4</td>
                                        <td class="px-6 py-4 text-sm text-slate-500">NEW ‚Üí REVIEWING</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- User Management Page (ADMIN only) -->
                <div id="page-users" class="page-content hidden fade-in">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-islamic-green/10">
                        <div class="p-4 border-b border-islamic-green/10 bg-islamic-light flex items-center justify-between">
                            <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Manajemen User
                            </h3>
                            <button onclick="showAddUserModal()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark transition flex items-center gap-2">
                                <i data-lucide="user-plus" class="w-4 h-4"></i>
                                Tambah User
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-islamic-light">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Department</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table" class="divide-y divide-islamic-green/10">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- =============================================== -->
                <!-- INVESTIGATION DASHBOARD PAGES (INVESTIGATOR+)  -->
                <!-- =============================================== -->

                <!-- Investigation Dashboard - Active Cases -->
                <div id="page-inv-dashboard" class="page-content hidden fade-in">
                    <!-- Investigation Pipeline Overview -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Dashboard Investigasi</h2>
                                <p class="text-indigo-200">Siklus investigasi komprehensif sesuai standar forensik</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-200 text-sm">Kasus Aktif</p>
                                <p id="inv-active-count" class="text-4xl font-bold">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Investigation Pipeline Stages -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 mb-6">
                        <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Pipeline Investigasi
                        </h3>
                        <div class="flex items-center justify-between">
                            <div class="flex-1 text-center">
                                <div class="w-16 h-16 mx-auto bg-blue-100 rounded-full flex items-center justify-center mb-2 border-4 border-blue-500">
                                    <i data-lucide="clipboard-check" class="w-8 h-8 text-blue-600"></i>
                                </div>
                                <p class="font-medium text-islamic-dark">Intake</p>
                                <p id="stage-intake-count" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="w-12 h-1 bg-slate-200"></div>
                            <div class="flex-1 text-center">
                                <div class="w-16 h-16 mx-auto bg-purple-100 rounded-full flex items-center justify-center mb-2 border-4 border-purple-500">
                                    <i data-lucide="file-search" class="w-8 h-8 text-purple-600"></i>
                                </div>
                                <p class="font-medium text-islamic-dark">Analisis</p>
                                <p id="stage-analysis-count" class="text-2xl font-bold text-purple-600">0</p>
                            </div>
                            <div class="w-12 h-1 bg-slate-200"></div>
                            <div class="flex-1 text-center">
                                <div class="w-16 h-16 mx-auto bg-amber-100 rounded-full flex items-center justify-center mb-2 border-4 border-amber-500">
                                    <i data-lucide="folder-lock" class="w-8 h-8 text-amber-600"></i>
                                </div>
                                <p class="font-medium text-islamic-dark">Bukti</p>
                                <p id="stage-evidence-count" class="text-2xl font-bold text-amber-600">0</p>
                            </div>
                            <div class="w-12 h-1 bg-slate-200"></div>
                            <div class="flex-1 text-center">
                                <div class="w-16 h-16 mx-auto bg-teal-100 rounded-full flex items-center justify-center mb-2 border-4 border-teal-500">
                                    <i data-lucide="users" class="w-8 h-8 text-teal-600"></i>
                                </div>
                                <p class="font-medium text-islamic-dark">Wawancara</p>
                                <p id="stage-interview-count" class="text-2xl font-bold text-teal-600">0</p>
                            </div>
                            <div class="w-12 h-1 bg-slate-200"></div>
                            <div class="flex-1 text-center">
                                <div class="w-16 h-16 mx-auto bg-islamic-green/20 rounded-full flex items-center justify-center mb-2 border-4 border-islamic-green">
                                    <i data-lucide="file-check" class="w-8 h-8 text-islamic-green"></i>
                                </div>
                                <p class="font-medium text-islamic-dark">Laporan</p>
                                <p id="stage-report-count" class="text-2xl font-bold text-islamic-green">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Active Cases Table -->
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-islamic-green/10">
                        <div class="p-4 border-b border-islamic-green/10 bg-islamic-light flex items-center justify-between">
                            <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Kasus Dalam Investigasi
                            </h3>
                            <select id="inv-stage-filter" onchange="loadInvestigationCases()" class="px-3 py-1 border border-islamic-green/20 rounded-lg text-sm">
                                <option value="">Semua Tahap</option>
                                <option value="INTAKE">Intake & Mandat</option>
                                <option value="ANALYSIS">Analisis Data</option>
                                <option value="EVIDENCE">Pengumpulan Bukti</option>
                                <option value="INTERVIEW">Wawancara</option>
                                <option value="REPORTING">Penyusunan Laporan</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-islamic-light">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">No. Kasus</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Ticket</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Subject</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Tahap</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Progress</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Severity</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">SLA</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="inv-cases-table" class="divide-y divide-islamic-green/10">
                                    <!-- Cases will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Investigation Intake & Mandate Page -->
                <div id="page-inv-intake" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Content -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Case Selection -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Pilih Kasus untuk Intake
                                </h3>
                                <select id="intake-case-select" onchange="loadIntakeCase()" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">-- Pilih Laporan --</option>
                                </select>
                            </div>

                            <!-- Intake Form -->
                            <div id="intake-form-container" class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 hidden">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Form Intake & Penetapan Mandat
                                </h3>
                                <form id="intake-form" onsubmit="submitIntake(event)">
                                    <!-- Independence Declaration -->
                                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <h4 class="font-medium text-blue-800 mb-3 flex items-center gap-2">
                                            <i data-lucide="shield-check" class="w-5 h-5"></i>
                                            Deklarasi Independensi
                                        </h4>
                                        <div class="space-y-2">
                                            <label class="flex items-start gap-3 cursor-pointer">
                                                <input type="checkbox" id="ind-no-conflict" required class="mt-1 w-4 h-4 text-indigo-600 rounded">
                                                <span class="text-sm text-slate-700">Tidak memiliki konflik kepentingan dengan pihak yang dilaporkan</span>
                                            </label>
                                            <label class="flex items-start gap-3 cursor-pointer">
                                                <input type="checkbox" id="ind-no-relation" required class="mt-1 w-4 h-4 text-indigo-600 rounded">
                                                <span class="text-sm text-slate-700">Tidak memiliki hubungan keluarga/finansial dengan pihak terkait</span>
                                            </label>
                                            <label class="flex items-start gap-3 cursor-pointer">
                                                <input type="checkbox" id="ind-objective" required class="mt-1 w-4 h-4 text-indigo-600 rounded">
                                                <span class="text-sm text-slate-700">Mampu bersikap objektif dan tidak memihak dalam investigasi</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Mandate Details -->
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-islamic-dark mb-1">Nomor Mandat Investigasi</label>
                                            <input type="text" id="mandate-number" required placeholder="INV/2024/001" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-islamic-dark mb-1">Tanggal Mulai</label>
                                                <input type="date" id="mandate-start" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-islamic-dark mb-1">Target Selesai</label>
                                                <input type="date" id="mandate-target" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-islamic-dark mb-1">Ruang Lingkup Investigasi</label>
                                            <textarea id="mandate-scope" rows="3" required placeholder="Jelaskan batasan dan fokus investigasi..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-islamic-dark mb-1">Hipotesis Awal</label>
                                            <textarea id="mandate-hypothesis" rows="2" placeholder="Dugaan awal berdasarkan laporan..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-islamic-dark mb-1">Tim Investigasi</label>
                                            <input type="text" id="mandate-team" placeholder="Nama anggota tim (pisahkan dengan koma)" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        </div>
                                    </div>

                                    <div class="flex items-center justify-end gap-3 mt-6 pt-4 border-t border-islamic-green/10">
                                        <button type="button" onclick="clearIntakeForm()" class="px-4 py-2 border border-islamic-green/20 rounded-lg hover:bg-islamic-light">Reset</button>
                                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                                            <i data-lucide="check" class="w-4 h-4"></i>
                                            Tetapkan Mandat
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="space-y-6">
                            <!-- Case Summary -->
                            <div id="intake-case-summary" class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 hidden">
                                <h4 class="font-semibold text-islamic-dark mb-4">Ringkasan Kasus</h4>
                                <div id="intake-summary-content" class="space-y-3 text-sm">
                                    <!-- Summary will be loaded here -->
                                </div>
                            </div>

                            <!-- Guidelines -->
                            <div class="bg-indigo-50 rounded-xl p-6 border border-indigo-200">
                                <h4 class="font-semibold text-indigo-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="info" class="w-5 h-5"></i>
                                    Panduan Intake
                                </h4>
                                <ul class="text-sm text-indigo-700 space-y-2">
                                    <li class="flex items-start gap-2">
                                        <span class="text-indigo-500">‚Ä¢</span>
                                        Pastikan independensi sebelum memulai
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-indigo-500">‚Ä¢</span>
                                        Tetapkan ruang lingkup yang jelas
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-indigo-500">‚Ä¢</span>
                                        Dokumentasikan hipotesis awal
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-indigo-500">‚Ä¢</span>
                                        Tentukan timeline realistis
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investigation Data Analysis Page -->
                <div id="page-inv-analysis" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Case Selector Sidebar -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-islamic-green/10 h-fit">
                            <h4 class="font-semibold text-islamic-dark mb-3">Kasus Aktif</h4>
                            <div id="analysis-case-list" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Case list will be loaded here -->
                            </div>
                        </div>

                        <!-- Main Analysis Area -->
                        <div class="lg:col-span-3 space-y-6">
                            <!-- Analysis Header -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Analisis Data - <span id="analysis-case-title">Pilih Kasus</span>
                                    </h3>
                                    <button onclick="runAIAnalysis()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                                        <i data-lucide="brain" class="w-4 h-4"></i>
                                        AI Analysis
                                    </button>
                                </div>

                                <!-- Analysis Tabs -->
                                <div class="flex border-b border-islamic-green/20">
                                    <button onclick="showAnalysisTab('internal')" class="analysis-tab px-4 py-2 border-b-2 border-indigo-500 text-indigo-600 font-medium">Data Internal</button>
                                    <button onclick="showAnalysisTab('sop')" class="analysis-tab px-4 py-2 text-slate-500 hover:text-islamic-dark">SOP & Kebijakan</button>
                                    <button onclick="showAnalysisTab('transaction')" class="analysis-tab px-4 py-2 text-slate-500 hover:text-islamic-dark">Transaksi</button>
                                    <button onclick="showAnalysisTab('timeline')" class="analysis-tab px-4 py-2 text-slate-500 hover:text-islamic-dark">Timeline</button>
                                </div>
                            </div>

                            <!-- Internal Data Tab -->
                            <div id="tab-internal" class="analysis-tab-content bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-medium text-islamic-dark mb-4">Analisis Data Internal</h4>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="p-4 bg-slate-50 rounded-lg border">
                                        <p class="text-sm text-slate-500 mb-1">Dokumen Diperiksa</p>
                                        <p id="internal-doc-count" class="text-2xl font-bold text-islamic-dark">0</p>
                                    </div>
                                    <div class="p-4 bg-slate-50 rounded-lg border">
                                        <p class="text-sm text-slate-500 mb-1">Anomali Ditemukan</p>
                                        <p id="internal-anomaly-count" class="text-2xl font-bold text-red-600">0</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-2">Catatan Analisis Internal</label>
                                    <textarea id="internal-notes" rows="4" placeholder="Dokumentasikan temuan dari data internal..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <button onclick="saveAnalysisNotes('internal')" class="mt-3 px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark">Simpan Catatan</button>
                            </div>

                            <!-- SOP Tab -->
                            <div id="tab-sop" class="analysis-tab-content bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 hidden">
                                <h4 class="font-medium text-islamic-dark mb-4">Analisis SOP & Kebijakan</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-2">SOP/Kebijakan yang Relevan</label>
                                        <textarea id="sop-relevant" rows="3" placeholder="Daftarkan SOP dan kebijakan yang berkaitan..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-2">Pelanggaran SOP yang Ditemukan</label>
                                        <textarea id="sop-violations" rows="3" placeholder="Dokumentasikan pelanggaran prosedur..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                    </div>
                                </div>
                                <button onclick="saveAnalysisNotes('sop')" class="mt-3 px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark">Simpan Catatan</button>
                            </div>

                            <!-- Transaction Tab -->
                            <div id="tab-transaction" class="analysis-tab-content bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 hidden">
                                <h4 class="font-medium text-islamic-dark mb-4">Analisis Rekam Jejak Transaksi</h4>
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div class="p-4 bg-slate-50 rounded-lg border">
                                        <p class="text-sm text-slate-500 mb-1">Total Transaksi</p>
                                        <p id="trx-total" class="text-xl font-bold text-islamic-dark">0</p>
                                    </div>
                                    <div class="p-4 bg-slate-50 rounded-lg border">
                                        <p class="text-sm text-slate-500 mb-1">Nilai Transaksi</p>
                                        <p id="trx-value" class="text-xl font-bold text-islamic-dark">Rp 0</p>
                                    </div>
                                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                                        <p class="text-sm text-red-500 mb-1">Transaksi Mencurigakan</p>
                                        <p id="trx-suspicious" class="text-xl font-bold text-red-600">0</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-2">Catatan Analisis Transaksi</label>
                                    <textarea id="transaction-notes" rows="4" placeholder="Dokumentasikan pola dan anomali transaksi..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <button onclick="saveAnalysisNotes('transaction')" class="mt-3 px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark">Simpan Catatan</button>
                            </div>

                            <!-- Timeline Tab -->
                            <div id="tab-timeline" class="analysis-tab-content bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 hidden">
                                <h4 class="font-medium text-islamic-dark mb-4">Timeline Kejadian</h4>
                                <div id="timeline-container" class="relative pl-8 space-y-4">
                                    <p class="text-slate-500 text-sm">Belum ada timeline. Tambahkan event untuk memulai.</p>
                                </div>
                                <div class="mt-4 pt-4 border-t border-islamic-green/10">
                                    <div class="grid grid-cols-3 gap-3">
                                        <input type="date" id="timeline-date" class="px-3 py-2 border border-islamic-green/20 rounded-lg">
                                        <input type="text" id="timeline-event" placeholder="Deskripsi kejadian" class="col-span-2 px-3 py-2 border border-islamic-green/20 rounded-lg">
                                    </div>
                                    <button onclick="addTimelineEvent()" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Tambah Event</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investigation Evidence & Chain of Custody Page -->
                <div id="page-inv-evidence" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Evidence List -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-islamic-green/10">
                                <div class="p-4 border-b border-islamic-green/10 bg-islamic-light flex items-center justify-between">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Daftar Bukti
                                    </h3>
                                    <button onclick="showAddEvidenceModal()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 flex items-center gap-2">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Tambah Bukti
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-islamic-light">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">ID Bukti</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Jenis</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Deskripsi</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Lokasi</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Status CoC</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="evidence-table" class="divide-y divide-islamic-green/10">
                                            <tr>
                                                <td colspan="6" class="px-4 py-8 text-center text-slate-500">Belum ada bukti terdaftar</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Chain of Custody Sidebar -->
                        <div class="space-y-6">
                            <!-- CoC Summary -->
                            <div class="bg-amber-50 rounded-xl p-6 border border-amber-200">
                                <h4 class="font-semibold text-amber-800 mb-4 flex items-center gap-2">
                                    <i data-lucide="link" class="w-5 h-5"></i>
                                    Chain of Custody
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-amber-700">Total Bukti</span>
                                        <span id="coc-total" class="font-bold text-amber-800">0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-amber-700">Digital</span>
                                        <span id="coc-digital" class="font-bold text-amber-800">0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-amber-700">Fisik</span>
                                        <span id="coc-physical" class="font-bold text-amber-800">0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-amber-700">Dokumen</span>
                                        <span id="coc-document" class="font-bold text-amber-800">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- CoC Guidelines -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Standar Chain of Custody</h4>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-islamic-green mt-0.5"></i>
                                        <span>Catat siapa yang mengumpulkan bukti</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-islamic-green mt-0.5"></i>
                                        <span>Dokumentasikan waktu dan lokasi pengambilan</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-islamic-green mt-0.5"></i>
                                        <span>Simpan bukti di lokasi aman</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-islamic-green mt-0.5"></i>
                                        <span>Catat setiap perpindahan/akses</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-islamic-green mt-0.5"></i>
                                        <span>Buat hash untuk bukti digital</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investigation Interview Page -->
                <div id="page-inv-interview" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Interview List -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-islamic-green/10">
                                <div class="p-4 border-b border-islamic-green/10 bg-islamic-light flex items-center justify-between">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Daftar Wawancara
                                    </h3>
                                    <button onclick="showScheduleInterviewModal()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 flex items-center gap-2">
                                        <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                                        Jadwalkan Wawancara
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-islamic-light">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Tanggal</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Narasumber</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Peran</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Berita Acara</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="interview-table" class="divide-y divide-islamic-green/10">
                                            <tr>
                                                <td colspan="6" class="px-4 py-8 text-center text-slate-500">Belum ada wawancara terjadwal</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Berita Acara Form -->
                            <div id="berita-acara-form" class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10 hidden">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Berita Acara Wawancara
                                </h3>
                                <form onsubmit="saveBeritaAcara(event)">
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-islamic-dark mb-1">Nomor Berita Acara</label>
                                            <input type="text" id="ba-number" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-islamic-dark mb-1">Tanggal & Waktu</label>
                                            <input type="datetime-local" id="ba-datetime" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-islamic-dark mb-1">Lokasi Wawancara</label>
                                        <input type="text" id="ba-location" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-islamic-dark mb-1">Pewawancara</label>
                                        <input type="text" id="ba-interviewer" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-islamic-dark mb-1">Isi Keterangan</label>
                                        <textarea id="ba-content" rows="6" required placeholder="Tuliskan hasil wawancara secara lengkap..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-islamic-dark mb-1">Kesimpulan</label>
                                        <textarea id="ba-conclusion" rows="2" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                    </div>
                                    <div class="flex items-center justify-end gap-3">
                                        <button type="button" onclick="hideBeritaAcaraForm()" class="px-4 py-2 border border-islamic-green/20 rounded-lg">Batal</button>
                                        <button type="submit" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Simpan Berita Acara</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Interview Guidelines -->
                        <div class="space-y-6">
                            <div class="bg-teal-50 rounded-xl p-6 border border-teal-200">
                                <h4 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="info" class="w-5 h-5"></i>
                                    Panduan Wawancara
                                </h4>
                                <ul class="text-sm text-teal-700 space-y-2">
                                    <li>‚Ä¢ Siapkan daftar pertanyaan terstruktur</li>
                                    <li>‚Ä¢ Jelaskan hak dan kewajiban narasumber</li>
                                    <li>‚Ä¢ Rekam dengan izin (audio/video)</li>
                                    <li>‚Ä¢ Buat notulensi detail</li>
                                    <li>‚Ä¢ Minta tanda tangan berita acara</li>
                                </ul>
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Kategori Narasumber</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                        <span>Subjek (Terlapor)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                                        <span>Saksi Langsung</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-amber-500 rounded-full"></span>
                                        <span>Saksi Tidak Langsung</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                        <span>Ahli/Expert</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investigation Findings & Report Page -->
                <div id="page-inv-findings" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Findings Matrix -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Findings Summary -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Matriks Temuan
                                </h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-islamic-light">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">No</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Temuan</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Bukti Pendukung</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Regulasi Dilanggar</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Dampak</th>
                                                <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="findings-table" class="divide-y divide-islamic-green/10">
                                            <tr>
                                                <td colspan="6" class="px-4 py-8 text-center text-slate-500">Belum ada temuan. Klik "Tambah Temuan" untuk memulai.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button onclick="showAddFindingModal()" class="mt-4 px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Tambah Temuan
                                </button>
                            </div>

                            <!-- Recommendations -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                    <span class="text-islamic-gold">€ù</span>
                                    Rekomendasi Tindakan
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-2">Tindakan Korektif</label>
                                        <textarea id="rec-corrective" rows="3" placeholder="Langkah-langkah perbaikan segera..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-2">Tindakan Preventif</label>
                                        <textarea id="rec-preventive" rows="3" placeholder="Langkah pencegahan ke depan..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-2">Mitigasi Risiko</label>
                                        <textarea id="rec-mitigation" rows="3" placeholder="Strategi mitigasi risiko..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                    </div>
                                </div>
                                <button onclick="saveRecommendations()" class="mt-4 px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark">Simpan Rekomendasi</button>
                            </div>

                            <!-- Final Report Generation -->
                            <div class="bg-gradient-to-r from-islamic-green to-islamic-dark text-white rounded-xl p-6">
                                <h3 class="font-semibold text-xl mb-2">Generate Laporan Final</h3>
                                <p class="text-emerald-200 mb-4">Buat laporan investigasi lengkap berdasarkan seluruh temuan dan analisis.</p>
                                <div class="flex items-center gap-3">
                                    <button onclick="generateFinalReport()" class="px-6 py-2 bg-white text-islamic-green rounded-lg hover:bg-islamic-cream font-medium flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-5 h-5"></i>
                                        Generate Laporan
                                    </button>
                                    <button onclick="previewReport()" class="px-6 py-2 bg-islamic-gold/20 text-white rounded-lg hover:bg-islamic-gold/30 flex items-center gap-2">
                                        <i data-lucide="eye" class="w-5 h-5"></i>
                                        Preview
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Report Status Sidebar -->
                        <div class="space-y-6">
                            <!-- Completeness Checklist -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4">Kelengkapan Laporan</h4>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3">
                                        <div id="check-mandate" class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                            <i data-lucide="check" class="w-4 h-4 text-slate-300"></i>
                                        </div>
                                        <span class="text-sm text-slate-600">Mandat Investigasi</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div id="check-analysis" class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                            <i data-lucide="check" class="w-4 h-4 text-slate-300"></i>
                                        </div>
                                        <span class="text-sm text-slate-600">Analisis Data</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div id="check-evidence" class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                            <i data-lucide="check" class="w-4 h-4 text-slate-300"></i>
                                        </div>
                                        <span class="text-sm text-slate-600">Bukti Terdokumentasi</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div id="check-interview" class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                            <i data-lucide="check" class="w-4 h-4 text-slate-300"></i>
                                        </div>
                                        <span class="text-sm text-slate-600">Berita Acara Wawancara</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div id="check-findings" class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                            <i data-lucide="check" class="w-4 h-4 text-slate-300"></i>
                                        </div>
                                        <span class="text-sm text-slate-600">Matriks Temuan</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div id="check-recommendations" class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center">
                                            <i data-lucide="check" class="w-4 h-4 text-slate-300"></i>
                                        </div>
                                        <span class="text-sm text-slate-600">Rekomendasi</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Management Response -->
                            <div class="bg-purple-50 rounded-xl p-6 border border-purple-200">
                                <h4 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="message-square" class="w-5 h-5"></i>
                                    Tanggapan Manajemen
                                </h4>
                                <textarea id="mgmt-response" rows="4" placeholder="Masukkan tanggapan dari manajemen..." class="w-full px-3 py-2 border border-purple-200 rounded-lg text-sm"></textarea>
                                <button onclick="saveManagementResponse()" class="mt-2 w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">Simpan Tanggapan</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================== -->
                <!-- MANAGER DASHBOARD PAGES                        -->
                <!-- ============================================== -->

                <!-- Manager Executive Overview Page -->
                <div id="page-mgr-overview" class="page-content hidden fade-in">
                    <!-- KPI Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">Total Laporan Bulan Ini</p>
                                    <p id="mgr-kpi-total" class="text-3xl font-bold text-islamic-dark">0</p>
                                    <p id="mgr-kpi-total-trend" class="text-xs text-green-600 flex items-center gap-1 mt-1">
                                        <i data-lucide="trending-up" class="w-3 h-3"></i> +0% vs bulan lalu
                                    </p>
                                </div>
                                <div class="w-14 h-14 bg-islamic-green/10 rounded-xl flex items-center justify-center">
                                    <i data-lucide="file-text" class="w-7 h-7 text-islamic-green"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">Tingkat Penyelesaian</p>
                                    <p id="mgr-kpi-resolution" class="text-3xl font-bold text-islamic-green">0%</p>
                                    <p class="text-xs text-slate-500 mt-1">Target: 85%</p>
                                </div>
                                <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle-2" class="w-7 h-7 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">Menunggu Approval</p>
                                    <p id="mgr-kpi-pending" class="text-3xl font-bold text-amber-600">0</p>
                                    <p class="text-xs text-slate-500 mt-1">Perlu tindakan segera</p>
                                </div>
                                <div class="w-14 h-14 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="clock" class="w-7 h-7 text-amber-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-slate-500">SLA Breach Risk</p>
                                    <p id="mgr-kpi-sla-risk" class="text-3xl font-bold text-red-600">0</p>
                                    <p class="text-xs text-slate-500 mt-1">Dalam 24 jam</p>
                                </div>
                                <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-7 h-7 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Status Distribution Chart -->
                        <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Distribusi Status Laporan
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <p class="text-2xl font-bold text-blue-600" id="mgr-stat-new">0</p>
                                    <p class="text-sm text-slate-600">Baru</p>
                                </div>
                                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                    <p class="text-2xl font-bold text-yellow-600" id="mgr-stat-reviewing">0</p>
                                    <p class="text-sm text-slate-600">Direview</p>
                                </div>
                                <div class="text-center p-4 bg-purple-50 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-600" id="mgr-stat-investigating">0</p>
                                    <p class="text-sm text-slate-600">Investigasi</p>
                                </div>
                                <div class="text-center p-4 bg-red-50 rounded-lg">
                                    <p class="text-2xl font-bold text-red-600" id="mgr-stat-escalated">0</p>
                                    <p class="text-sm text-slate-600">Eskalasi</p>
                                </div>
                            </div>
                            <!-- Severity Breakdown -->
                            <h4 class="font-medium text-islamic-dark mt-6 mb-3">Breakdown Tingkat Keparahan</h4>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <span class="w-20 text-sm text-slate-600">CRITICAL</span>
                                    <div class="flex-1 bg-slate-200 rounded-full h-4 overflow-hidden">
                                        <div id="mgr-sev-critical" class="bg-red-600 h-full rounded-full" style="width: 0%"></div>
                                    </div>
                                    <span id="mgr-sev-critical-count" class="text-sm font-medium text-slate-700">0</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="w-20 text-sm text-slate-600">HIGH</span>
                                    <div class="flex-1 bg-slate-200 rounded-full h-4 overflow-hidden">
                                        <div id="mgr-sev-high" class="bg-orange-500 h-full rounded-full" style="width: 0%"></div>
                                    </div>
                                    <span id="mgr-sev-high-count" class="text-sm font-medium text-slate-700">0</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="w-20 text-sm text-slate-600">MEDIUM</span>
                                    <div class="flex-1 bg-slate-200 rounded-full h-4 overflow-hidden">
                                        <div id="mgr-sev-medium" class="bg-yellow-500 h-full rounded-full" style="width: 0%"></div>
                                    </div>
                                    <span id="mgr-sev-medium-count" class="text-sm font-medium text-slate-700">0</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="w-20 text-sm text-slate-600">LOW</span>
                                    <div class="flex-1 bg-slate-200 rounded-full h-4 overflow-hidden">
                                        <div id="mgr-sev-low" class="bg-green-500 h-full rounded-full" style="width: 0%"></div>
                                    </div>
                                    <span id="mgr-sev-low-count" class="text-sm font-medium text-slate-700">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions & Alerts -->
                        <div class="space-y-6">
                            <!-- Urgent Alerts -->
                            <div class="bg-red-50 rounded-xl p-6 border border-red-200">
                                <h4 class="font-semibold text-red-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                    Perhatian Segera
                                </h4>
                                <div id="mgr-urgent-alerts" class="space-y-2">
                                    <p class="text-sm text-red-700">Memuat...</p>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3 flex items-center gap-2">
                                    <i data-lucide="activity" class="w-5 h-5 text-islamic-gold"></i>
                                    Aktivitas Terbaru
                                </h4>
                                <div id="mgr-recent-activity" class="space-y-3 max-h-60 overflow-y-auto">
                                    <p class="text-sm text-slate-500">Memuat...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Analysis -->
                    <div class="mt-6 bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                        <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Analisis Kategori Pelanggaran
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="mgr-category-stats">
                            <div class="text-center p-4 bg-slate-50 rounded-lg">
                                <p class="text-2xl font-bold text-slate-600">0</p>
                                <p class="text-xs text-slate-500">Korupsi</p>
                            </div>
                            <div class="text-center p-4 bg-slate-50 rounded-lg">
                                <p class="text-2xl font-bold text-slate-600">0</p>
                                <p class="text-xs text-slate-500">Fraud</p>
                            </div>
                            <div class="text-center p-4 bg-slate-50 rounded-lg">
                                <p class="text-2xl font-bold text-slate-600">0</p>
                                <p class="text-xs text-slate-500">COI</p>
                            </div>
                            <div class="text-center p-4 bg-slate-50 rounded-lg">
                                <p class="text-2xl font-bold text-slate-600">0</p>
                                <p class="text-xs text-slate-500">Gratifikasi</p>
                            </div>
                            <div class="text-center p-4 bg-slate-50 rounded-lg">
                                <p class="text-2xl font-bold text-slate-600">0</p>
                                <p class="text-xs text-slate-500">Lainnya</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manager Escalation & Approval Page -->
                <div id="page-mgr-escalation" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Escalation Queue -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Pending Approvals -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Menunggu Persetujuan
                                    </h3>
                                    <span id="mgr-pending-count" class="bg-amber-500 text-white px-3 py-1 rounded-full text-sm">0</span>
                                </div>
                                <div id="mgr-pending-list" class="space-y-4">
                                    <div class="p-4 bg-slate-50 rounded-lg text-center text-slate-500">
                                        Tidak ada item menunggu persetujuan
                                    </div>
                                </div>
                            </div>

                            <!-- Escalated Cases -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-red-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-red-800 flex items-center gap-2">
                                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                        Kasus Eskalasi
                                    </h3>
                                    <span id="mgr-escalated-count" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm">0</span>
                                </div>
                                <div id="mgr-escalated-list" class="space-y-4">
                                    <div class="p-4 bg-red-50 rounded-lg text-center text-red-600">
                                        Tidak ada kasus eskalasi
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Approval Actions Sidebar -->
                        <div class="space-y-6">
                            <!-- Quick Stats -->
                            <div class="bg-gradient-to-br from-islamic-green to-islamic-dark text-white rounded-xl p-6">
                                <h4 class="font-semibold mb-4">Ringkasan Approval</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-emerald-200">Disetujui Hari Ini</span>
                                        <span id="mgr-approved-today" class="font-bold">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-emerald-200">Ditolak Hari Ini</span>
                                        <span id="mgr-rejected-today" class="font-bold">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-emerald-200">Rata-rata Response</span>
                                        <span id="mgr-avg-response" class="font-bold">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Escalation Matrix -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Matriks Eskalasi</h4>
                                <div class="space-y-3 text-sm">
                                    <div class="p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                        <p class="font-medium text-red-800">Level 4 - Direktur Utama</p>
                                        <p class="text-red-600 text-xs">CRITICAL > Rp 1M</p>
                                    </div>
                                    <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                        <p class="font-medium text-orange-800">Level 3 - Direktur</p>
                                        <p class="text-orange-600 text-xs">HIGH > Rp 500jt</p>
                                    </div>
                                    <div class="p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                        <p class="font-medium text-yellow-800">Level 2 - Kepala Divisi</p>
                                        <p class="text-yellow-600 text-xs">MEDIUM > Rp 100jt</p>
                                    </div>
                                    <div class="p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                                        <p class="font-medium text-green-800">Level 1 - Manager WBS</p>
                                        <p class="text-green-600 text-xs">LOW < Rp 100jt</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manager SLA Monitoring Page -->
                <div id="page-mgr-sla" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-green-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-500">On Track</p>
                                    <p id="sla-on-track" class="text-2xl font-bold text-green-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-yellow-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-500">At Risk (24h)</p>
                                    <p id="sla-at-risk" class="text-2xl font-bold text-yellow-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-orange-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-500">Warning (48h)</p>
                                    <p id="sla-warning" class="text-2xl font-bold text-orange-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-red-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-slate-500">Breached</p>
                                    <p id="sla-breached" class="text-2xl font-bold text-red-600">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SLA Details Table -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Detail SLA per Laporan
                            </h3>
                            <select id="sla-filter" class="px-4 py-2 border border-islamic-green/20 rounded-lg text-sm" onchange="filterSLATable()">
                                <option value="all">Semua Status</option>
                                <option value="breached">Breached Only</option>
                                <option value="at-risk">At Risk</option>
                                <option value="on-track">On Track</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-islamic-light">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Ticket ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Severity</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Target SLA</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Elapsed</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Remaining</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="sla-table-body" class="divide-y divide-islamic-green/10">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-slate-500">Memuat data SLA...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SLA Configuration Reference -->
                    <div class="mt-6 bg-islamic-light rounded-xl p-6">
                        <h4 class="font-semibold text-islamic-dark mb-4">Konfigurasi SLA per Severity</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg border border-red-200">
                                <p class="font-medium text-red-600">CRITICAL</p>
                                <p class="text-sm text-slate-600">Response: 4 jam</p>
                                <p class="text-sm text-slate-600">Resolution: 3 hari</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-orange-200">
                                <p class="font-medium text-orange-600">HIGH</p>
                                <p class="text-sm text-slate-600">Response: 8 jam</p>
                                <p class="text-sm text-slate-600">Resolution: 7 hari</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-yellow-200">
                                <p class="font-medium text-yellow-600">MEDIUM</p>
                                <p class="text-sm text-slate-600">Response: 24 jam</p>
                                <p class="text-sm text-slate-600">Resolution: 14 hari</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-green-200">
                                <p class="font-medium text-green-600">LOW</p>
                                <p class="text-sm text-slate-600">Response: 48 jam</p>
                                <p class="text-sm text-slate-600">Resolution: 30 hari</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manager Risk Dashboard Page -->
                <div id="page-mgr-risk" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Risk Matrix -->
                        <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Risk Heat Map
                            </h3>
                            <div class="grid grid-cols-4 gap-2 text-center text-sm">
                                <div></div>
                                <div class="font-medium text-slate-600 py-2">Low Impact</div>
                                <div class="font-medium text-slate-600 py-2">Med Impact</div>
                                <div class="font-medium text-slate-600 py-2">High Impact</div>

                                <div class="font-medium text-slate-600 py-4">High Likelihood</div>
                                <div id="risk-hl-li" class="bg-yellow-400 rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('medium-high')">0</div>
                                <div id="risk-hl-mi" class="bg-orange-500 text-white rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('high')">0</div>
                                <div id="risk-hl-hi" class="bg-red-600 text-white rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('critical')">0</div>

                                <div class="font-medium text-slate-600 py-4">Med Likelihood</div>
                                <div id="risk-ml-li" class="bg-green-400 rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('low')">0</div>
                                <div id="risk-ml-mi" class="bg-yellow-400 rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('medium')">0</div>
                                <div id="risk-ml-hi" class="bg-orange-500 text-white rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('high')">0</div>

                                <div class="font-medium text-slate-600 py-4">Low Likelihood</div>
                                <div id="risk-ll-li" class="bg-green-300 rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('very-low')">0</div>
                                <div id="risk-ll-mi" class="bg-green-400 rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('low')">0</div>
                                <div id="risk-ll-hi" class="bg-yellow-400 rounded-lg p-4 cursor-pointer hover:opacity-80" onclick="showRiskDetails('medium')">0</div>
                            </div>
                        </div>

                        <!-- Risk Summary -->
                        <div class="space-y-6">
                            <div class="bg-gradient-to-br from-red-600 to-red-800 text-white rounded-xl p-6">
                                <h4 class="font-semibold mb-2">Total Potensi Kerugian</h4>
                                <p id="risk-total-loss" class="text-3xl font-bold">Rp 0</p>
                                <p class="text-red-200 text-sm mt-1">Berdasarkan estimasi dampak finansial</p>
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Top Risk Areas</h4>
                                <div id="risk-top-areas" class="space-y-3">
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                                        <span class="text-sm text-slate-600">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Register -->
                    <div class="mt-6 bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                        <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Risk Register
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-islamic-light">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Risk ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Deskripsi</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Kategori</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Likelihood</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Impact</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Score</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Mitigasi</th>
                                    </tr>
                                </thead>
                                <tbody id="risk-register-body" class="divide-y divide-islamic-green/10">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-slate-500">Memuat risk register...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manager Performance Page -->
                <div id="page-mgr-performance" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Team Performance -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Kinerja Tim
                            </h3>
                            <div id="team-performance" class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-islamic-green/20 rounded-full flex items-center justify-center">
                                            <i data-lucide="user" class="w-5 h-5 text-islamic-green"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-islamic-dark">Tim Intake</p>
                                            <p class="text-xs text-slate-500">2 anggota aktif</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-islamic-green">85%</p>
                                        <p class="text-xs text-slate-500">SLA compliance</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                            <i data-lucide="search" class="w-5 h-5 text-purple-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-islamic-dark">Tim Investigasi</p>
                                            <p class="text-xs text-slate-500">3 anggota aktif</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-purple-600">78%</p>
                                        <p class="text-xs text-slate-500">SLA compliance</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Metrics -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Metrik Bulanan
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <p id="perf-total-received" class="text-2xl font-bold text-blue-600">0</p>
                                    <p class="text-sm text-slate-600">Laporan Masuk</p>
                                </div>
                                <div class="text-center p-4 bg-green-50 rounded-lg">
                                    <p id="perf-total-closed" class="text-2xl font-bold text-green-600">0</p>
                                    <p class="text-sm text-slate-600">Laporan Selesai</p>
                                </div>
                                <div class="text-center p-4 bg-amber-50 rounded-lg">
                                    <p id="perf-avg-resolution" class="text-2xl font-bold text-amber-600">0</p>
                                    <p class="text-sm text-slate-600">Hari Rata-rata</p>
                                </div>
                                <div class="text-center p-4 bg-purple-50 rounded-lg">
                                    <p id="perf-proven-rate" class="text-2xl font-bold text-purple-600">0%</p>
                                    <p class="text-sm text-slate-600">Terbukti</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trend Analysis -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                        <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Tren 6 Bulan Terakhir
                        </h3>
                        <div class="grid grid-cols-6 gap-2 text-center">
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500">Jul</p>
                                <div class="h-20 flex items-end justify-center mt-2">
                                    <div class="w-6 bg-islamic-green/60 rounded-t" style="height: 40%"></div>
                                </div>
                                <p class="text-sm font-medium mt-2">12</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500">Aug</p>
                                <div class="h-20 flex items-end justify-center mt-2">
                                    <div class="w-6 bg-islamic-green/60 rounded-t" style="height: 60%"></div>
                                </div>
                                <p class="text-sm font-medium mt-2">18</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500">Sep</p>
                                <div class="h-20 flex items-end justify-center mt-2">
                                    <div class="w-6 bg-islamic-green/60 rounded-t" style="height: 45%"></div>
                                </div>
                                <p class="text-sm font-medium mt-2">14</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500">Oct</p>
                                <div class="h-20 flex items-end justify-center mt-2">
                                    <div class="w-6 bg-islamic-green/60 rounded-t" style="height: 70%"></div>
                                </div>
                                <p class="text-sm font-medium mt-2">21</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500">Nov</p>
                                <div class="h-20 flex items-end justify-center mt-2">
                                    <div class="w-6 bg-islamic-green/60 rounded-t" style="height: 55%"></div>
                                </div>
                                <p class="text-sm font-medium mt-2">16</p>
                            </div>
                            <div class="p-4 bg-islamic-green/10 rounded-lg border-2 border-islamic-green">
                                <p class="text-xs text-islamic-green font-medium">Dec</p>
                                <div class="h-20 flex items-end justify-center mt-2">
                                    <div class="w-6 bg-islamic-green rounded-t" style="height: 80%"></div>
                                </div>
                                <p class="text-sm font-bold text-islamic-green mt-2">24</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================== -->
                <!-- INTAKE OFFICER DASHBOARD PAGES                 -->
                <!-- ============================================== -->

                <!-- Intake Queue Page -->
                <div id="page-intake-queue" class="page-content hidden fade-in">
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-blue-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="inbox" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500">Laporan Baru</p>
                                    <p id="intake-new-count" class="text-xl font-bold text-blue-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-yellow-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="eye" class="w-5 h-5 text-yellow-600"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500">Sedang Direview</p>
                                    <p id="intake-reviewing-count" class="text-xl font-bold text-yellow-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-purple-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="help-circle" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500">Perlu Info Tambahan</p>
                                    <p id="intake-needinfo-count" class="text-xl font-bold text-purple-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-red-200">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500">Prioritas Tinggi</p>
                                    <p id="intake-priority-count" class="text-xl font-bold text-red-600">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Queue Table -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Antrian Laporan Masuk
                            </h3>
                            <div class="flex gap-2">
                                <select id="intake-queue-filter" class="px-3 py-2 border border-islamic-green/20 rounded-lg text-sm" onchange="filterIntakeQueue()">
                                    <option value="all">Semua Status</option>
                                    <option value="NEW">Baru</option>
                                    <option value="REVIEWING">Direview</option>
                                    <option value="NEED_INFO">Perlu Info</option>
                                </select>
                                <button onclick="loadIntakeQueue()" class="px-3 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark text-sm flex items-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-islamic-light">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Ticket ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Sumber</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Kategori</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Ringkasan</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">SLA</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-islamic-dark">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="intake-queue-body" class="divide-y divide-islamic-green/10">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-slate-500">Memuat antrian laporan...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Intake Review & Validation Page -->
                <div id="page-intake-review" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Report Details -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Selected Report -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-islamic-dark flex items-center gap-2">
                                        <span class="text-islamic-gold">€ù</span>
                                        Detail Laporan
                                    </h3>
                                    <span id="review-ticket-id" class="font-mono text-sm bg-slate-100 px-3 py-1 rounded">-</span>
                                </div>
                                <div id="review-report-content" class="space-y-4">
                                    <p class="text-slate-500 text-center py-8">Pilih laporan dari antrian untuk direview</p>
                                </div>
                            </div>

                            <!-- AI Analysis Summary -->
                            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-200">
                                <h4 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="cpu" class="w-5 h-5"></i>
                                    Analisis AI
                                </h4>
                                <div id="review-ai-analysis" class="space-y-3">
                                    <p class="text-purple-600 text-sm">Analisis AI akan muncul setelah memilih laporan</p>
                                </div>
                            </div>
                        </div>

                        <!-- Validation Actions -->
                        <div class="space-y-6">
                            <!-- Validation Checklist -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4">Checklist Validasi</h4>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="check-complete" class="w-5 h-5 rounded border-slate-300 text-islamic-green focus:ring-islamic-green">
                                        <span class="text-sm text-slate-700">Informasi lengkap (5W1H)</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="check-evidence" class="w-5 h-5 rounded border-slate-300 text-islamic-green focus:ring-islamic-green">
                                        <span class="text-sm text-slate-700">Bukti pendukung tersedia</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="check-jurisdiction" class="w-5 h-5 rounded border-slate-300 text-islamic-green focus:ring-islamic-green">
                                        <span class="text-sm text-slate-700">Dalam yurisdiksi BPKH</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="check-not-duplicate" class="w-5 h-5 rounded border-slate-300 text-islamic-green focus:ring-islamic-green">
                                        <span class="text-sm text-slate-700">Bukan duplikat</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="check-actionable" class="w-5 h-5 rounded border-slate-300 text-islamic-green focus:ring-islamic-green">
                                        <span class="text-sm text-slate-700">Dapat ditindaklanjuti</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4">Tindakan</h4>
                                <div class="space-y-3">
                                    <button onclick="acceptReport()" class="w-full px-4 py-3 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark flex items-center justify-center gap-2">
                                        <i data-lucide="check" class="w-5 h-5"></i>
                                        Terima & Teruskan ke Investigasi
                                    </button>
                                    <button onclick="requestMoreInfo()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
                                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                                        Minta Informasi Tambahan
                                    </button>
                                    <button onclick="rejectReport()" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center justify-center gap-2">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                        Tolak Laporan
                                    </button>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-3">Catatan Review</h4>
                                <textarea id="review-notes" rows="4" placeholder="Tambahkan catatan review..." class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg text-sm"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Intake Communication Page -->
                <div id="page-intake-communicate" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Communication List -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Daftar Komunikasi
                            </h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto" id="comm-ticket-list">
                                <div class="p-3 bg-slate-50 rounded-lg text-center text-slate-500">
                                    Tidak ada komunikasi pending
                                </div>
                            </div>
                        </div>

                        <!-- Chat Interface -->
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-islamic-green/10 flex flex-col h-[600px]">
                            <!-- Chat Header -->
                            <div class="p-4 border-b border-islamic-green/10 flex items-center justify-between">
                                <div>
                                    <h4 id="comm-current-ticket" class="font-semibold text-islamic-dark">Pilih Tiket</h4>
                                    <p id="comm-current-status" class="text-sm text-slate-500">-</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="loadChatHistory()" class="p-2 hover:bg-slate-100 rounded-lg">
                                        <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div id="comm-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50">
                                <div class="text-center text-slate-500 py-8">
                                    Pilih tiket untuk melihat riwayat komunikasi
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="p-4 border-t border-islamic-green/10">
                                <div class="flex gap-2">
                                    <input type="text" id="comm-message-input" placeholder="Ketik pesan..." class="flex-1 px-4 py-2 border border-islamic-green/20 rounded-lg" onkeypress="if(event.key==='Enter')sendMessage()">
                                    <button onclick="sendMessage()" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark flex items-center gap-2">
                                        <i data-lucide="send" class="w-5 h-5"></i>
                                        Kirim
                                    </button>
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <button onclick="sendTemplate('request_info')" class="text-xs px-3 py-1 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200">üìã Minta Info</button>
                                    <button onclick="sendTemplate('update_status')" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200">üìä Update Status</button>
                                    <button onclick="sendTemplate('thank_you')" class="text-xs px-3 py-1 bg-green-100 text-green-700 rounded-full hover:bg-green-200">üôè Terima Kasih</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Intake Escalation Page -->
                <div id="page-intake-escalate" class="page-content hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Reports to Escalate -->
                        <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                            <h3 class="font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                                <span class="text-islamic-gold">€ù</span>
                                Laporan Perlu Eskalasi
                            </h3>
                            <div id="escalate-list" class="space-y-4">
                                <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <span class="font-mono text-sm bg-amber-100 px-2 py-1 rounded">ABC12345</span>
                                            <span class="ml-2 px-2 py-1 bg-red-100 text-red-700 text-xs rounded">CRITICAL</span>
                                        </div>
                                        <span class="text-xs text-amber-600">SLA: 2 jam tersisa</span>
                                    </div>
                                    <p class="mt-2 text-sm text-slate-700">Dugaan penyalahgunaan dana operasional dengan estimasi kerugian > Rp 1 Miliar</p>
                                    <div class="mt-3 flex gap-2">
                                        <button onclick="escalateToManager('ABC12345')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                            Eskalasi ke Manager
                                        </button>
                                        <button onclick="viewReportDetail('ABC12345')" class="px-3 py-1 bg-slate-200 text-slate-700 rounded text-sm hover:bg-slate-300">
                                            Lihat Detail
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Escalation Guide -->
                        <div class="space-y-6">
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                                <h4 class="font-semibold text-islamic-dark mb-4">Kriteria Eskalasi</h4>
                                <div class="space-y-3 text-sm">
                                    <div class="p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                        <p class="font-medium text-red-800">CRITICAL</p>
                                        <p class="text-red-600 text-xs">Dampak > Rp 1M atau melibatkan pejabat tinggi</p>
                                    </div>
                                    <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                        <p class="font-medium text-orange-800">HIGH</p>
                                        <p class="text-orange-600 text-xs">Dampak Rp 500jt - Rp 1M atau reputasi institusi</p>
                                    </div>
                                    <div class="p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                        <p class="font-medium text-yellow-800">Auto-Escalate If:</p>
                                        <ul class="text-yellow-700 text-xs list-disc list-inside mt-1">
                                            <li>SLA response terlewat</li>
                                            <li>Fraud score > 0.7</li>
                                            <li>Bukti kuat tersedia</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-islamic-green to-islamic-dark text-white rounded-xl p-6">
                                <h4 class="font-semibold mb-3">Panduan Eskalasi</h4>
                                <ul class="text-sm text-emerald-200 space-y-2">
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                        <span>Pastikan semua informasi telah diverifikasi</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                        <span>Sertakan catatan analisis awal</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i data-lucide="check-circle" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                        <span>Pilih level eskalasi yang tepat</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // Configuration
        let API_URL = localStorage.getItem('api_url') || '';
        let currentPage = 1;
        let currentReportId = null;
        let authToken = null;
        let currentUser = null;

        // ============== Global UI Utilities ==============

        function showLoading(message = 'Memproses...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('global-loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('global-loading').classList.add('hidden');
        }

        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            const icons = {
                success: '&#10003;',
                error: '&#10007;',
                warning: '&#9888;',
                info: '&#8505;'
            };
            const toast = document.createElement('div');
            toast.className = `${colors[type] || colors.info} text-white px-5 py-3 rounded-lg shadow-lg pointer-events-auto flex items-center gap-3 transform translate-x-full transition-transform duration-300 max-w-sm`;
            toast.innerHTML = `<span class="text-lg">${icons[type] || icons.info}</span><span class="text-sm">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        async function apiFetch(url, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: { ...defaultHeaders, ...options.headers }
                });
                if (response.status === 401) {
                    showToast('Sesi berakhir. Silakan login ulang.', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return null;
                }
                if (response.status === 429) {
                    showToast('Terlalu banyak permintaan. Coba lagi nanti.', 'warning');
                    return null;
                }
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || `Error ${response.status}`);
                }
                return response;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showToast('Tidak dapat terhubung ke server', 'error');
                } else {
                    showToast(error.message || 'Terjadi kesalahan', 'error');
                }
                throw error;
            }
        }

        async function retryAnalysis(reportId) {
            showLoading('Menjalankan ulang AI Analysis...');
            try {
                const resp = await apiFetch(`${API_URL}/api/v1/analysis/run`, {
                    method: 'POST',
                    body: JSON.stringify({ report_id: reportId, use_full_analysis: true })
                });
                if (resp) {
                    showToast('Analisis sedang diproses ulang', 'success');
                    setTimeout(() => loadReports(), 2000);
                }
            } catch (e) {
                showToast('Gagal menjalankan ulang analisis', 'error');
            } finally {
                hideLoading();
            }
        }

        function exportCSV() {
            showLoading('Mengekspor data...');
            const url = `${API_URL}/api/v1/reports/export?format=csv`;
            fetch(url, { headers: { 'Authorization': `Bearer ${authToken}` } })
                .then(resp => {
                    if (!resp.ok) throw new Error('Export gagal');
                    return resp.blob();
                })
                .then(blob => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `wbs_reports_${new Date().toISOString().slice(0,10)}.csv`;
                    a.click();
                    showToast('Export berhasil', 'success');
                })
                .catch(e => showToast(e.message || 'Export gagal', 'error'))
                .finally(() => hideLoading());
        }

        // Authentication Check
        function checkAuth() {
            authToken = localStorage.getItem('wbs_token');
            const userJson = localStorage.getItem('wbs_user');

            if (!authToken || !userJson) {
                window.location.href = '/login';
                return false;
            }

            try {
                currentUser = JSON.parse(userJson);
                updateUserInfo();
                return true;
            } catch (e) {
                localStorage.removeItem('wbs_token');
                localStorage.removeItem('wbs_user');
                window.location.href = '/login';
                return false;
            }
        }

        function updateUserInfo() {
            const userNameEl = document.getElementById('user-name');
            const userRoleEl = document.getElementById('user-role');
            if (userNameEl) userNameEl.textContent = currentUser.full_name || currentUser.email;
            if (userRoleEl) userRoleEl.textContent = formatRole(currentUser.role);

            // Apply role-based menu visibility
            applyRoleBasedUI();
        }

        function formatRole(role) {
            const roles = {
                'ADMIN': 'Administrator',
                'MANAGER': 'Pimpinan WBS',
                'INVESTIGATOR': 'Tim Investigasi',
                'INTAKE_OFFICER': 'Penerima Laporan'
            };
            return roles[role] || role;
        }

        // Role-based UI configuration
        const ROLE_CONFIG = {
            'ADMIN': {
                menus: ['intake-section', 'manager-section', 'investigation-section', 'ai-screening', 'ai-deep-analysis', 'ai-insights', 'analysis', 'knowledge', 'settings-section', 'settings', 'audit', 'users'],
                welcome: 'Selamat Datang, Administrator',
                description: 'Anda memiliki akses penuh ke semua fitur sistem WBS BPKH',
                quickActions: [
                    { icon: 'users', label: 'Kelola User', action: "showPage('users')", color: 'bg-purple-500' },
                    { icon: 'layout-dashboard', label: 'Executive View', action: "showPage('mgr-overview')", color: 'bg-blue-500' },
                    { icon: 'settings', label: 'Pengaturan', action: "showPage('settings')", color: 'bg-slate-500' }
                ],
                statusFilter: null // Can see all
            },
            'MANAGER': {
                menus: ['manager-section', 'investigation-section', 'ai-insights', 'settings-section', 'audit'],
                welcome: 'Selamat Datang, Pimpinan WBS',
                description: 'Fokus: Oversight, monitoring SLA, dan eskalasi',
                quickActions: [
                    { icon: 'layout-dashboard', label: 'Executive Overview', action: "showPage('mgr-overview')", color: 'bg-blue-600' },
                    { icon: 'chart-network', label: 'AI Insights', action: "showPage('ai-insights')", color: 'bg-purple-500' },
                    { icon: 'clock', label: 'SLA Monitoring', action: "showPage('mgr-sla')", color: 'bg-amber-500' }
                ],
                statusFilter: null // Can see all but focus on escalated
            },
            'INVESTIGATOR': {
                menus: ['investigation-section', 'ai-deep-analysis', 'settings-section', 'audit'],
                welcome: 'Selamat Datang, Tim Investigasi',
                description: 'Fokus: Investigasi laporan dan analisis fraud',
                quickActions: [
                    { icon: 'search', label: 'Kasus Aktif', action: "showPage('inv-dashboard')", color: 'bg-indigo-500' },
                    { icon: 'brain-circuit', label: 'AI Deep Analysis', action: "showPage('ai-deep-analysis')", color: 'bg-purple-500' },
                    { icon: 'file-check', label: 'Temuan & Laporan', action: "showPage('inv-findings')", color: 'bg-islamic-green' }
                ],
                statusFilter: ['INVESTIGATING', 'ESCALATED', 'CLOSED_PROVEN', 'CLOSED_NOT_PROVEN']
            },
            'INTAKE_OFFICER': {
                menus: ['intake-section', 'ai-screening'],
                welcome: 'Selamat Datang, Penerima Laporan',
                description: 'Fokus: Review laporan baru dan komunikasi dengan pelapor',
                quickActions: [
                    { icon: 'inbox', label: 'Antrian Laporan', action: "showPage('intake-queue')", color: 'bg-blue-500' },
                    { icon: 'scan-search', label: 'AI Screening', action: "showPage('ai-screening')", color: 'bg-purple-500' },
                    { icon: 'message-circle', label: 'Komunikasi Pelapor', action: "showPage('intake-communicate')", color: 'bg-teal-500' }
                ],
                statusFilter: ['NEW', 'REVIEWING', 'NEED_INFO']
            }
        };

        function applyRoleBasedUI() {
            if (!currentUser || !currentUser.role) return;

            const config = ROLE_CONFIG[currentUser.role] || ROLE_CONFIG['INTAKE_OFFICER'];

            // Show/hide menu items - include all role-specific menus
            const allMenus = [
                'intake-section', 'manager-section', 'investigation-section',
                'ai-screening', 'ai-deep-analysis', 'ai-insights',
                'analysis', 'knowledge', 'settings-section', 'settings', 'audit', 'users'
            ];
            allMenus.forEach(menu => {
                const el = document.getElementById(`menu-${menu}`);
                if (el) {
                    if (config.menus.includes(menu)) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });

            // Update welcome banner
            const welcomeEl = document.getElementById('role-welcome');
            const descEl = document.getElementById('role-description');
            if (welcomeEl) welcomeEl.textContent = config.welcome;
            if (descEl) descEl.textContent = config.description;

            // Render quick actions
            const quickActionsEl = document.getElementById('quick-actions');
            if (quickActionsEl && config.quickActions) {
                quickActionsEl.classList.remove('hidden');
                quickActionsEl.innerHTML = config.quickActions.map(action => `
                    <button onclick="${action.action}" class="${action.color} text-white rounded-xl p-4 flex items-center gap-3 hover:opacity-90 transition shadow-sm">
                        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                            <i data-lucide="${action.icon}" class="w-5 h-5"></i>
                        </div>
                        <span class="font-medium">${action.label}</span>
                    </button>
                `).join('');
                lucide.createIcons();
            }

            // Store role filter for reports
            window.roleStatusFilter = config.statusFilter;
        }

        function filterByStatus(status) {
            document.getElementById('filter-status').value = status;
            showPage('reports');
            loadReports();
        }

        function filterBySeverity(severity) {
            document.getElementById('filter-severity').value = severity;
            showPage('reports');
            loadReports();
        }

        function logout() {
            localStorage.removeItem('wbs_token');
            localStorage.removeItem('wbs_user');
            localStorage.removeItem('wbs_refresh_token');
            window.location.href = '/login';
        }

        // API Fetch with Auth
        async function authFetch(url, options = {}) {
            if (!authToken) {
                window.location.href = '/login';
                return null;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`,
                ...options.headers
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                // Token expired, try refresh or redirect to login
                localStorage.removeItem('wbs_token');
                window.location.href = '/login';
                return null;
            }

            return response;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) return;

            lucide.createIcons();
            loadDashboard();
            document.getElementById('api-url').value = API_URL;
        });

        // Navigation
        function showPage(page) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-islamic-gold/20', 'text-white', 'border', 'border-islamic-gold/30');
                el.classList.add('text-emerald-100');
            });

            const pageEl = document.getElementById(`page-${page}`);
            if (pageEl) pageEl.classList.remove('hidden');

            const titles = {
                'dashboard': 'Dashboard',
                'reports': 'Daftar Laporan',
                'inbox': 'Inbox',
                'analysis': 'AI Analysis',
                'knowledge': 'Knowledge Base',
                'settings': 'Pengaturan',
                'audit': 'Audit Log',
                'users': 'Manajemen User',
                'inv-dashboard': 'Dashboard Investigasi',
                'inv-intake': 'Intake & Mandat',
                'inv-analysis': 'Analisis Data',
                'inv-evidence': 'Bukti & Chain of Custody',
                'inv-interview': 'Wawancara',
                'inv-findings': 'Temuan & Laporan',
                // Manager pages
                'mgr-overview': 'Executive Overview',
                'mgr-escalation': 'Eskalasi & Approval',
                'mgr-sla': 'SLA Monitoring',
                'mgr-risk': 'Risk Dashboard',
                'mgr-performance': 'Performance',
                // Intake Officer pages
                'intake-queue': 'Antrian Laporan',
                'intake-review': 'Review & Validasi',
                'intake-communicate': 'Komunikasi Pelapor',
                'intake-escalate': 'Eskalasi',
                // Role-specific AI Analysis pages
                'ai-screening': 'AI Screening Tool',
                'ai-deep-analysis': 'AI Deep Analysis',
                'ai-insights': 'AI Insights Dashboard'
            };
            document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

            if (page === 'dashboard') loadDashboard();
            if (page === 'reports') loadReports();
            if (page === 'users') loadUsers();
            if (page === 'inv-dashboard') loadInvestigationDashboard();
            if (page === 'inv-intake') loadIntakePage();
            if (page === 'inv-analysis') loadAnalysisPage();
            if (page === 'inv-evidence') loadEvidencePage();
            if (page === 'inv-interview') loadInterviewPage();
            if (page === 'inv-findings') loadFindingsPage();
            // Manager pages
            if (page === 'mgr-overview') loadManagerOverview();
            if (page === 'mgr-escalation') loadManagerEscalation();
            if (page === 'mgr-sla') loadManagerSLA();
            if (page === 'mgr-risk') loadManagerRisk();
            if (page === 'mgr-performance') loadManagerPerformance();
            // Intake Officer pages
            if (page === 'intake-queue') loadIntakeQueue();
            // Role-specific AI Analysis pages
            if (page === 'ai-screening') loadAIScreening();
            if (page === 'ai-deep-analysis') loadAIDeepAnalysis();
            if (page === 'ai-insights') loadAIInsights();
            if (page === 'intake-review') loadIntakeReviewPage();
            if (page === 'intake-communicate') loadIntakeCommunicate();
            if (page === 'intake-escalate') loadIntakeEscalate();

            lucide.createIcons();
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/dashboard/stats`);
                if (!response || !response.ok) throw new Error('Failed to load stats');
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.total_reports || 0;
                document.getElementById('stat-pending').textContent = data.pending_review || 0;

                // SLA at risk with color coding
                const slaCount = data.sla_at_risk || 0;
                const slaEl = document.getElementById('stat-sla-risk');
                slaEl.textContent = slaCount;
                // Color code: green=0, yellow=1-3, red=4+
                const slaParent = slaEl.closest('.bg-white, [class*="bg-"]');
                if (slaParent) {
                    slaParent.classList.remove('border-red-500', 'border-yellow-500', 'border-green-500');
                    if (slaCount >= 4) {
                        slaParent.classList.add('border-l-4', 'border-red-500');
                    } else if (slaCount >= 1) {
                        slaParent.classList.add('border-l-4', 'border-yellow-500');
                    }
                }

                const closedCount = (data.by_status?.CLOSED_PROVEN || 0) + (data.by_status?.CLOSED_NOT_PROVEN || 0) + (data.by_status?.CLOSED_INVALID || 0);
                document.getElementById('stat-closed').textContent = closedCount;

                if (data.pending_review > 0) {
                    document.getElementById('report-badge').textContent = data.pending_review;
                    document.getElementById('report-badge').classList.remove('hidden');
                }

                renderCategoryChart(data.by_category || {});
                renderSeverityChart(data.by_severity || {});
                loadRecentReports();
            } catch (error) {
                console.log('Dashboard: Using sample data');
                renderSampleDashboard();
            }
        }

        function renderSampleDashboard() {
            document.getElementById('stat-total').textContent = '24';
            document.getElementById('stat-pending').textContent = '8';
            document.getElementById('stat-sla-risk').textContent = '2';
            document.getElementById('stat-closed').textContent = '12';

            renderCategoryChart({ 'FRAUD': 5, 'CORRUPTION': 8, 'GRATIFICATION': 3, 'PROCUREMENT': 6, 'OTHER': 2 });
            renderSeverityChart({ 'CRITICAL': 2, 'HIGH': 6, 'MEDIUM': 10, 'LOW': 6 });

            document.getElementById('recent-reports').innerHTML = `
                <div class="p-4 hover:bg-islamic-light cursor-pointer" onclick="viewReport('sample-1')">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium text-islamic-dark">WBS-X7K9M2N4</span>
                            <p class="text-sm text-slate-600">Dugaan penyimpangan pengadaan barang</p>
                        </div>
                        <div class="text-right">
                            <span class="status-badge bg-red-100 text-red-700">CRITICAL</span>
                            <p class="text-xs text-slate-400 mt-1">2 jam lalu</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 hover:bg-islamic-light cursor-pointer" onclick="viewReport('sample-2')">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium text-islamic-dark">WBS-P3Q5R8S1</span>
                            <p class="text-sm text-slate-600">Laporan gratifikasi pejabat</p>
                        </div>
                        <div class="text-right">
                            <span class="status-badge bg-orange-100 text-orange-700">HIGH</span>
                            <p class="text-xs text-slate-400 mt-1">5 jam lalu</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('recent-activity').innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-islamic-green/20 rounded-full flex items-center justify-center shrink-0">
                        <i data-lucide="file-plus" class="w-4 h-4 text-islamic-green"></i>
                    </div>
                    <div>
                        <p class="text-sm text-islamic-dark">Laporan baru diterima</p>
                        <p class="text-xs text-slate-400">WBS-X7K9M2N4 ‚Ä¢ 2 jam lalu</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center shrink-0">
                        <i data-lucide="brain" class="w-4 h-4 text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-islamic-dark">AI Analysis selesai</p>
                        <p class="text-xs text-slate-400">WBS-P3Q5R8S1 ‚Ä¢ 3 jam lalu</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-islamic-gold/20 rounded-full flex items-center justify-center shrink-0">
                        <i data-lucide="check" class="w-4 h-4 text-islamic-gold"></i>
                    </div>
                    <div>
                        <p class="text-sm text-islamic-dark">Kasus ditutup</p>
                        <p class="text-xs text-slate-400">WBS-A1B2C3D4 ‚Ä¢ 1 hari lalu</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ data: Object.values(data), backgroundColor: ['#006B3F', '#C9A227', '#dc2626', '#8b5cf6', '#3b82f6', '#ec4899'] }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderSeverityChart(data) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ label: 'Jumlah Laporan', data: Object.values(data), backgroundColor: ['#dc2626', '#ea580c', '#C9A227', '#006B3F'] }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        async function loadRecentReports() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports?per_page=5`);
                if (!response || !response.ok) throw new Error('Failed to load');
                const data = await response.json();
                const container = document.getElementById('recent-reports');
                if (data.reports && data.reports.length > 0) {
                    container.innerHTML = data.reports.map(report => `
                        <div class="p-4 hover:bg-islamic-light cursor-pointer" onclick="viewReport('${report.id}')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium text-islamic-dark">${report.ticket_id}</span>
                                    <p class="text-sm text-slate-600 truncate max-w-xs">${report.subject}</p>
                                </div>
                                <div class="text-right">
                                    <span class="status-badge ${getSeverityClass(report.severity)}">${report.severity || 'PENDING'}</span>
                                    <p class="text-xs text-slate-400 mt-1">${formatDate(report.created_at)}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) { console.log('Using sample recent reports'); }
        }

        // Reports functions
        async function loadReports() {
            const status = document.getElementById('filter-status').value;
            const severity = document.getElementById('filter-severity').value;
            const category = document.getElementById('filter-category').value;
            const channel = document.getElementById('filter-channel').value;
            let url = `${API_URL}/api/v1/reports?page=${currentPage}&per_page=10`;
            if (status) url += `&status=${status}`;
            if (severity) url += `&severity=${severity}`;
            if (category) url += `&category=${category}`;
            if (channel) url += `&channel=${channel}`;

            try {
                const response = await authFetch(url);
                if (!response.ok) throw new Error('Failed to load reports');
                const data = await response.json();
                renderReportsTable(data.reports || []);
                document.getElementById('showing-count').textContent = data.reports?.length || 0;
                document.getElementById('total-count').textContent = data.total || 0;
                document.getElementById('page-info').textContent = `Halaman ${currentPage}`;
            } catch (error) { console.log('Using sample reports'); renderSampleReports(); }
        }

        function renderReportsTable(reports) {
            const tbody = document.getElementById('reports-table');
            if (reports.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="px-6 py-8 text-center text-slate-500">Tidak ada laporan ditemukan</td></tr>`;
                return;
            }
            tbody.innerHTML = reports.map(report => `
                <tr class="hover:bg-islamic-light">
                    <td class="px-6 py-4"><span class="font-mono text-sm font-medium text-islamic-dark">${report.ticket_id}</span></td>
                    <td class="px-4 py-4">${getChannelBadge(report.channel)}</td>
                    <td class="px-6 py-4"><p class="text-sm text-islamic-dark truncate max-w-xs">${report.subject}</p></td>
                    <td class="px-6 py-4"><span class="status-badge bg-islamic-light text-islamic-dark">${report.category || '-'}</span></td>
                    <td class="px-6 py-4"><span class="status-badge ${getSeverityClass(report.severity)}">${report.severity || '-'}</span></td>
                    <td class="px-6 py-4"><span class="status-badge ${getStatusClass(report.status)}">${report.status}</span></td>
                    <td class="px-6 py-4">${report.fraud_score ? `<div class="flex items-center gap-2"><div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden"><div class="h-full ${getFraudScoreColor(report.fraud_score)}" style="width: ${report.fraud_score * 100}%"></div></div><span class="text-sm text-slate-600">${(report.fraud_score * 100).toFixed(0)}%</span></div>` : '-'}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${formatDate(report.created_at)}</td>
                    <td class="px-6 py-4"><button onclick="viewReport('${report.id}')" class="text-islamic-green hover:text-islamic-dark"><i data-lucide="eye" class="w-5 h-5"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function getChannelBadge(channel) {
            const channels = {
                'WEB': { icon: 'üåê', label: 'Web', bg: 'bg-blue-100', text: 'text-blue-700' },
                'WHATSAPP': { icon: 'üí¨', label: 'WA', bg: 'bg-green-100', text: 'text-green-700' },
                'EMAIL': { icon: 'üìß', label: 'Email', bg: 'bg-amber-100', text: 'text-amber-700' }
            };
            const ch = channels[channel] || { icon: 'üìÑ', label: channel || 'Web', bg: 'bg-slate-100', text: 'text-slate-700' };
            return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${ch.bg} ${ch.text}">${ch.icon} ${ch.label}</span>`;
        }

        function renderSampleReports() {
            const sampleReports = [
                { ticket_id: 'WBS-X7K9M2N4', subject: 'Dugaan penyimpangan pengadaan barang', category: 'PROCUREMENT', severity: 'CRITICAL', status: 'NEW', channel: 'WEB', fraud_score: 0.85, created_at: new Date().toISOString() },
                { ticket_id: 'WBS-P3Q5R8S1', subject: 'Laporan gratifikasi pejabat', category: 'GRATIFICATION', severity: 'HIGH', status: 'REVIEWING', channel: 'WHATSAPP', fraud_score: 0.72, created_at: new Date().toISOString() },
                { ticket_id: 'WBS-A1B2C3D4', subject: 'Dugaan korupsi unit keuangan', category: 'CORRUPTION', severity: 'MEDIUM', status: 'INVESTIGATING', channel: 'EMAIL', fraud_score: 0.58, created_at: new Date().toISOString() }
            ];
            renderReportsTable(sampleReports);
            document.getElementById('showing-count').textContent = '3';
            document.getElementById('total-count').textContent = '3';
        }

        async function viewReport(reportId) {
            currentReportId = reportId;
            document.getElementById('report-detail-modal').classList.remove('hidden');
            document.getElementById('modal-content').innerHTML = '<div class="text-center py-8"><div class="animate-spin w-8 h-8 border-4 border-islamic-green border-t-transparent rounded-full mx-auto"></div><p class="mt-4 text-slate-600">Memuat data...</p></div>';

            try {
                const response = await authFetch(`${API_URL}/api/v1/reports/${reportId}`);
                if (!response || !response.ok) throw new Error('Failed to load report');
                const report = await response.json();
                renderReportDetail(report);
            } catch (error) { console.log('Using sample report detail'); renderSampleReportDetail(); }
        }

        function renderReportDetail(report) {
            document.getElementById('modal-ticket-id').textContent = `Ticket: ${report.ticket_id}`;

            // Check for AI analysis error state
            let analysisHtml = '';
            const analysis = report.ai_analysis ? (typeof report.ai_analysis === 'string' ? JSON.parse(report.ai_analysis) : report.ai_analysis) : null;

            if (analysis && analysis.status === 'ERROR') {
                analysisHtml = `
                    <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-red-600 text-lg">&#10007;</span>
                            <p class="text-red-700 font-medium">Analisis AI Gagal</p>
                        </div>
                        <p class="text-red-600 text-sm mb-3">${analysis.error || 'Unknown error'}</p>
                        <button onclick="retryAnalysis('${report.id}')"
                                class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            Ulangi Analisis
                        </button>
                    </div>`;
            } else if (!analysis || analysis.status === 'IN_PROGRESS') {
                analysisHtml = `
                    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-blue-700 text-sm flex items-center gap-2">
                            <span class="animate-spin inline-block w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"></span>
                            Analisis AI sedang diproses...
                        </p>
                    </div>`;
            }

            document.getElementById('modal-content').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-sm font-semibold text-islamic-dark uppercase tracking-wider mb-2">Informasi Laporan</h4>
                        <div class="space-y-3">
                            <div><p class="text-xs text-slate-500">Subject</p><p class="text-islamic-dark">${report.subject}</p></div>
                            <div><p class="text-xs text-slate-500">Deskripsi</p><p class="text-islamic-dark text-sm">${report.description}</p></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-xs text-slate-500">Tanggal Kejadian</p><p class="text-islamic-dark">${report.incident_date || '-'}</p></div>
                                <div><p class="text-xs text-slate-500">Lokasi</p><p class="text-islamic-dark">${report.incident_location || '-'}</p></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-islamic-dark uppercase tracking-wider mb-2">Status & Analisis</h4>
                        <div class="space-y-3">
                            <div class="flex items-center gap-4">
                                <div><p class="text-xs text-slate-500">Status</p><span class="status-badge ${getStatusClass(report.status)}">${report.status}</span></div>
                                <div><p class="text-xs text-slate-500">Severity</p><span class="status-badge ${getSeverityClass(report.severity)}">${report.severity || 'PENDING'}</span></div>
                                <div><p class="text-xs text-slate-500">Kategori</p><span class="status-badge bg-islamic-light text-islamic-dark">${report.category || 'PENDING'}</span></div>
                            </div>
                            ${report.fraud_score ? `<div><p class="text-xs text-slate-500 mb-1">Fraud Score</p><div class="flex items-center gap-3"><div class="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden"><div class="h-full ${getFraudScoreColor(report.fraud_score)}" style="width: ${report.fraud_score * 100}%"></div></div><span class="font-semibold ${report.fraud_score > 0.7 ? 'text-red-600' : report.fraud_score > 0.4 ? 'text-amber-600' : 'text-islamic-green'}">${(report.fraud_score * 100).toFixed(0)}%</span></div></div>` : ''}
                            ${analysisHtml}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-status').value = report.status;
        }

        function renderSampleReportDetail() {
            document.getElementById('modal-ticket-id').textContent = 'Ticket: WBS-X7K9M2N4';
            document.getElementById('modal-content').innerHTML = `<div class="text-center py-8 text-slate-600">Sample report detail</div>`;
        }

        function closeModal() { document.getElementById('report-detail-modal').classList.add('hidden'); currentReportId = null; }

        async function runAnalysis() {
            if (!currentReportId) return;
            document.getElementById('modal-content').innerHTML = `<div class="text-center py-8"><div class="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-4 text-slate-600">Menjalankan AI Analysis...</p></div>`;
            try {
                const response = await authFetch(`${API_URL}/api/v1/analysis/run`, { method: 'POST', body: JSON.stringify({ report_id: currentReportId, use_full_analysis: true }) });
                if (!response || !response.ok) throw new Error('Analysis failed');
                const result = await response.json();
                const fraudInterp = getFraudScoreInterpretation(result.fraud_score);
                const severityInterp = getSeverityInterpretation(result.severity);
                alert(`‚úÖ Analisis Selesai!\n\nüìä Fraud Score: ${(result.fraud_score * 100).toFixed(0)}% (${fraudInterp.label})\n${fraudInterp.description}\n\n‚ö†Ô∏è Severity: ${result.severity} (${severityInterp.label})\n${severityInterp.description}\n\nüìÅ Kategori: ${result.category}\nüéØ Prioritas: ${result.priority}`);
                viewReport(currentReportId);
            } catch (error) { alert('Gagal menjalankan analisis'); }
        }

        async function runAnalysisById() {
            const reportId = document.getElementById('analysis-report-id').value;
            if (!reportId) { alert('Masukkan Report ID'); return; }
            const resultContainer = document.getElementById('analysis-result');
            resultContainer.classList.remove('hidden');
            resultContainer.innerHTML = `<div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10"><div class="text-center py-8"><div class="animate-spin w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-4 text-slate-600">Menjalankan AI Analysis...</p></div></div>`;
            try {
                const response = await authFetch(`${API_URL}/api/v1/analysis/run`, { method: 'POST', body: JSON.stringify({ report_id: reportId, use_full_analysis: true }) });
                if (!response || !response.ok) throw new Error('Analysis failed');
                const result = await response.json();
                const fraudInterp = getFraudScoreInterpretation(result.fraud_score);
                const severityInterp = getSeverityInterpretation(result.severity);
                const priorityInterp = getPriorityInterpretation(result.priority);

                resultContainer.innerHTML = `
                <div class="bg-white rounded-xl p-6 shadow-sm border border-islamic-green/10">
                    <h3 class="font-semibold text-islamic-dark mb-6 text-lg flex items-center gap-2">
                        <i data-lucide="brain" class="w-5 h-5 text-purple-600"></i>
                        Hasil Analisis AI
                    </h3>

                    <!-- Score Cards with Explanations -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- Fraud Score -->
                        <div class="p-4 rounded-lg border ${fraudInterp.bgColor}">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium text-slate-600">Fraud Score</p>
                                <span class="text-2xl font-bold ${fraudInterp.color}">${(result.fraud_score * 100).toFixed(0)}%</span>
                            </div>
                            <p class="font-semibold ${fraudInterp.color}">${fraudInterp.label}</p>
                            <p class="text-xs text-slate-500 mt-1">${fraudInterp.description}</p>
                        </div>

                        <!-- Severity -->
                        <div class="p-4 rounded-lg border ${severityInterp.bgColor}">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium text-slate-600">Severity</p>
                                <span class="text-xl font-bold ${severityInterp.color}">${result.severity}</span>
                            </div>
                            <p class="font-semibold ${severityInterp.color}">${severityInterp.label}</p>
                            <p class="text-xs text-slate-500 mt-1">${severityInterp.description}</p>
                        </div>

                        <!-- Priority -->
                        <div class="p-4 rounded-lg border bg-purple-50 border-purple-200">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium text-slate-600">Prioritas</p>
                                <span class="text-xl font-bold text-purple-600">${result.priority}</span>
                            </div>
                            <p class="font-semibold text-purple-600">${priorityInterp.label}</p>
                            <p class="text-xs text-slate-500 mt-1">${priorityInterp.description}</p>
                        </div>
                    </div>

                    <!-- Category & Status -->
                    <div class="flex items-center gap-4 mb-6">
                        <div class="px-4 py-2 bg-islamic-light rounded-lg">
                            <p class="text-xs text-slate-500">Kategori</p>
                            <p class="font-semibold text-islamic-dark">${result.category || '-'}</p>
                        </div>
                        <div class="px-4 py-2 bg-islamic-light rounded-lg">
                            <p class="text-xs text-slate-500">Status</p>
                            <p class="font-semibold text-islamic-green">${result.status}</p>
                        </div>
                    </div>

                    <!-- Executive Summary -->
                    ${result.executive_summary ? `
                    <div class="bg-slate-50 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-islamic-dark mb-2 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Ringkasan Eksekutif
                        </h4>
                        <p class="text-sm text-slate-600">${result.executive_summary.executive_summary || '-'}</p>
                    </div>
                    ` : ''}

                    <!-- Key Findings -->
                    ${result.executive_summary?.key_findings?.length ? `
                    <div class="bg-amber-50 rounded-lg p-4 mb-4 border border-amber-200">
                        <h4 class="font-semibold text-amber-700 mb-2 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            Temuan Utama
                        </h4>
                        <ul class="text-sm text-slate-600 list-disc list-inside">
                            ${result.executive_summary.key_findings.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <!-- Recommended Actions -->
                    ${result.recommendations?.immediate_actions?.length ? `
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h4 class="font-semibold text-blue-700 mb-2 flex items-center gap-2">
                            <i data-lucide="list-checks" class="w-4 h-4"></i>
                            Tindakan Segera
                        </h4>
                        <ul class="text-sm text-slate-600 space-y-1">
                            ${result.recommendations.immediate_actions.map(a => `<li class="flex items-start gap-2"><span class="text-blue-500">‚Ä¢</span>${a.action}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>`;
                lucide.createIcons();
            } catch (error) { resultContainer.innerHTML = `<div class="bg-white rounded-xl p-6 shadow-sm border border-red-200"><p class="text-red-600">Gagal menjalankan analisis: ${error.message}</p></div>`; }
        }

        async function updateStatus() {
            if (!currentReportId) return;
            const newStatus = document.getElementById('modal-status').value;
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports/${currentReportId}/status`, { method: 'PATCH', body: JSON.stringify({ new_status: newStatus }) });
                if (!response || !response.ok) throw new Error('Update failed');
                alert('Status berhasil diupdate');
                closeModal();
                loadReports();
            } catch (error) { alert('Gagal update status'); }
        }

        async function loadKnowledgeBase() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/knowledge/load`, { method: 'POST' });
                if (!response || !response.ok) throw new Error('Failed');
                const result = await response.json();
                alert(`Knowledge base loaded: ${result.documents_loaded} documents`);
            } catch (error) { alert('Gagal load knowledge base'); }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            const container = document.getElementById('chat-messages');
            container.innerHTML += `<div class="flex justify-end"><div class="bg-islamic-green text-white rounded-lg px-4 py-2 max-w-[70%]"><p>${message}</p><span class="text-xs text-emerald-200">${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</span></div></div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;
        }

        function saveSettings() { const apiUrl = document.getElementById('api-url').value; localStorage.setItem('api_url', apiUrl); API_URL = apiUrl; alert('Pengaturan disimpan'); }
        function prevPage() { if (currentPage > 1) { currentPage--; loadReports(); } }
        function nextPage() { currentPage++; loadReports(); }

        function getSeverityClass(severity) {
            const classes = { 'CRITICAL': 'bg-red-100 text-red-700', 'HIGH': 'bg-orange-100 text-orange-700', 'MEDIUM': 'bg-yellow-100 text-yellow-700', 'LOW': 'bg-islamic-green/20 text-islamic-green' };
            return classes[severity] || 'bg-islamic-light text-islamic-dark';
        }

        function getStatusClass(status) {
            const classes = { 'NEW': 'bg-blue-100 text-blue-700', 'REVIEWING': 'bg-purple-100 text-purple-700', 'NEED_INFO': 'bg-yellow-100 text-yellow-700', 'INVESTIGATING': 'bg-indigo-100 text-indigo-700', 'ESCALATED': 'bg-red-100 text-red-700', 'CLOSED_PROVEN': 'bg-islamic-green/20 text-islamic-green', 'CLOSED_NOT_PROVEN': 'bg-slate-100 text-slate-700', 'CLOSED_INVALID': 'bg-slate-100 text-slate-700' };
            return classes[status] || 'bg-islamic-light text-islamic-dark';
        }

        function getFraudScoreColor(score) { if (score >= 0.7) return 'bg-red-500'; if (score >= 0.4) return 'bg-amber-500'; return 'bg-islamic-green'; }
        function formatDate(dateStr) { if (!dateStr) return '-'; return new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }); }

        // Score interpretation functions
        function getFraudScoreInterpretation(score) {
            if (score <= 0.30) return { level: 'LOW', label: 'Indikasi Rendah', description: 'Risiko fraud minimal, perlu monitoring standar', color: 'text-green-600', bgColor: 'bg-green-50 border-green-200' };
            if (score <= 0.70) return { level: 'MEDIUM', label: 'Indikasi Sedang', description: 'Risiko fraud moderat, perlu investigasi lebih lanjut', color: 'text-amber-600', bgColor: 'bg-amber-50 border-amber-200' };
            return { level: 'HIGH', label: 'Indikasi Tinggi', description: 'Risiko fraud tinggi, prioritas investigasi', color: 'text-red-600', bgColor: 'bg-red-50 border-red-200' };
        }

        function getSeverityInterpretation(severity) {
            const levels = {
                'CRITICAL': { label: 'Kritis', description: 'Kerugian > Rp 1 Miliar atau melibatkan pejabat tinggi. SLA: Respons < 4 jam.', color: 'text-red-700', bgColor: 'bg-red-50 border-red-200' },
                'HIGH': { label: 'Tinggi', description: 'Kerugian Rp 100 Juta - 1 Miliar. SLA: Respons < 24 jam.', color: 'text-orange-600', bgColor: 'bg-orange-50 border-orange-200' },
                'MEDIUM': { label: 'Sedang', description: 'Kerugian Rp 10 - 100 Juta. SLA: Respons < 3 hari.', color: 'text-yellow-600', bgColor: 'bg-yellow-50 border-yellow-200' },
                'LOW': { label: 'Rendah', description: 'Kerugian < Rp 10 Juta. SLA: Respons < 7 hari.', color: 'text-green-600', bgColor: 'bg-green-50 border-green-200' }
            };
            return levels[severity] || levels['MEDIUM'];
        }

        function getPriorityInterpretation(priority) {
            const priorities = {
                'P1 - Critical': { label: 'Sangat Tinggi', description: 'Tindakan segera diperlukan' },
                'P2 - Urgent': { label: 'Tinggi', description: 'Perhatian mendesak diperlukan' },
                'P3 - Normal': { label: 'Sedang', description: 'Prioritas normal' },
                'P4 - Low': { label: 'Rendah', description: 'Prioritas rendah' }
            };
            return priorities[priority] || { label: priority, description: '' };
        }
        function toggleSidebar() { const sidebar = document.getElementById('sidebar'); sidebar.classList.toggle('w-64'); sidebar.classList.toggle('w-0'); }
        function exportReports() { exportCSV(); }

        // User Management Functions (ADMIN only)
        async function loadUsers() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/auth/users`);
                if (!response || !response.ok) throw new Error('Failed to load users');
                const data = await response.json();
                renderUsersTable(data.users || []);
            } catch (error) {
                console.log('Using sample users');
                renderUsersTable([
                    { email: 'admin@bpkh.go.id', full_name: 'Administrator', role: 'ADMIN', department: '-', status: 'ACTIVE' },
                    { email: 'manager@bpkh.go.id', full_name: 'Manager WBS', role: 'MANAGER', department: 'Kepala Unit WBS', status: 'ACTIVE' },
                    { email: 'investigator@bpkh.go.id', full_name: 'Investigator WBS', role: 'INVESTIGATOR', department: 'Bidang Audit Internal', status: 'ACTIVE' },
                    { email: 'intake@bpkh.go.id', full_name: 'Petugas Intake', role: 'INTAKE_OFFICER', department: 'Unit Pengelola WBS', status: 'ACTIVE' }
                ]);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table');
            if (!users || users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">Tidak ada user</td></tr>`;
                return;
            }
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-islamic-light">
                    <td class="px-6 py-4 text-sm text-islamic-dark">${user.email}</td>
                    <td class="px-6 py-4 text-sm text-islamic-dark">${user.full_name}</td>
                    <td class="px-6 py-4"><span class="status-badge ${getRoleBadgeClass(user.role)}">${formatRole(user.role)}</span></td>
                    <td class="px-6 py-4 text-sm text-slate-600">${user.department || '-'}</td>
                    <td class="px-6 py-4"><span class="status-badge ${user.status === 'ACTIVE' ? 'bg-islamic-green/20 text-islamic-green' : 'bg-red-100 text-red-700'}">${user.status}</span></td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <button onclick="editUser('${user.id}')" class="text-islamic-green hover:text-islamic-dark" title="Edit">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="resetUserPassword('${user.id}', '${user.email}')" class="text-amber-500 hover:text-amber-700" title="Reset Password">
                                <i data-lucide="key" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function getRoleBadgeClass(role) {
            const classes = {
                'ADMIN': 'bg-purple-100 text-purple-700',
                'MANAGER': 'bg-blue-100 text-blue-700',
                'INVESTIGATOR': 'bg-indigo-100 text-indigo-700',
                'INTAKE_OFFICER': 'bg-islamic-green/20 text-islamic-green'
            };
            return classes[role] || 'bg-slate-100 text-slate-700';
        }

        function showAddUserModal() {
            const html = `
                <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-md p-6">
                        <h3 class="text-lg font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Tambah User Baru
                        </h3>
                        <form onsubmit="createUser(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Email</label>
                                    <input type="email" id="new-user-email" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Nama Lengkap</label>
                                    <input type="text" id="new-user-name" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Password</label>
                                    <input type="password" id="new-user-password" required minlength="8" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                    <p class="text-xs text-slate-500 mt-1">Min 8 karakter, huruf besar, huruf kecil, angka, simbol</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Role</label>
                                    <select id="new-user-role" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                        <option value="INTAKE_OFFICER">Penerima Laporan</option>
                                        <option value="INVESTIGATOR">Tim Investigasi</option>
                                        <option value="MANAGER">Pimpinan WBS</option>
                                        <option value="ADMIN">Administrator</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Department</label>
                                    <input type="text" id="new-user-dept" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-islamic-green">
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-2 mt-6">
                                <button type="button" onclick="closeAddUserModal()" class="px-4 py-2 border border-islamic-green/20 rounded-lg hover:bg-islamic-light">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) modal.remove();
        }

        async function createUser(event) {
            event.preventDefault();
            const userData = {
                email: document.getElementById('new-user-email').value,
                full_name: document.getElementById('new-user-name').value,
                password: document.getElementById('new-user-password').value,
                role: document.getElementById('new-user-role').value,
                department: document.getElementById('new-user-dept').value
            };

            try {
                const response = await authFetch(`${API_URL}/api/v1/auth/register`, {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
                if (!response || !response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Gagal membuat user');
                }
                alert('User berhasil dibuat');
                closeAddUserModal();
                loadUsers();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function editUser(userId) {
            alert('Fitur edit user dalam pengembangan');
        }

        async function resetUserPassword(userId, email) {
            if (!confirm(`Reset password untuk ${email}?`)) return;
            alert('Fitur reset password dalam pengembangan');
        }

        // =====================================================
        // INVESTIGATION DASHBOARD FUNCTIONS
        // =====================================================

        // Investigation data store (in-memory for demo, would be persisted to backend)
        let investigationData = {
            cases: [],
            evidence: [],
            interviews: [],
            findings: [],
            timeline: []
        };

        async function loadInvestigationDashboard() {
            try {
                // Load reports with INVESTIGATING status
                const response = await authFetch(`${API_URL}/api/v1/reports?status=INVESTIGATING&limit=50`);
                if (response && response.ok) {
                    const data = await response.json();
                    investigationData.cases = data.reports || [];
                }
            } catch (error) {
                console.log('Using demo data for investigation');
            }

            // Update counts
            const cases = investigationData.cases;
            document.getElementById('inv-active-count').textContent = cases.length;
            document.getElementById('stage-intake-count').textContent = cases.filter(c => c.inv_stage === 'INTAKE' || !c.inv_stage).length;
            document.getElementById('stage-analysis-count').textContent = cases.filter(c => c.inv_stage === 'ANALYSIS').length;
            document.getElementById('stage-evidence-count').textContent = cases.filter(c => c.inv_stage === 'EVIDENCE').length;
            document.getElementById('stage-interview-count').textContent = cases.filter(c => c.inv_stage === 'INTERVIEW').length;
            document.getElementById('stage-report-count').textContent = cases.filter(c => c.inv_stage === 'REPORTING').length;

            renderInvestigationCasesTable(cases);
        }

        function loadInvestigationCases() {
            const filter = document.getElementById('inv-stage-filter').value;
            let filtered = investigationData.cases;
            if (filter) {
                filtered = filtered.filter(c => c.inv_stage === filter);
            }
            renderInvestigationCasesTable(filtered);
        }

        function renderInvestigationCasesTable(cases) {
            const tbody = document.getElementById('inv-cases-table');
            if (!cases || cases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">Tidak ada kasus dalam investigasi</td></tr>';
                return;
            }

            tbody.innerHTML = cases.map((c, idx) => {
                const stage = c.inv_stage || 'INTAKE';
                const stageColors = {
                    'INTAKE': 'bg-blue-100 text-blue-700',
                    'ANALYSIS': 'bg-purple-100 text-purple-700',
                    'EVIDENCE': 'bg-amber-100 text-amber-700',
                    'INTERVIEW': 'bg-teal-100 text-teal-700',
                    'REPORTING': 'bg-islamic-green/20 text-islamic-green'
                };
                const progress = { 'INTAKE': 20, 'ANALYSIS': 40, 'EVIDENCE': 60, 'INTERVIEW': 80, 'REPORTING': 95 }[stage] || 10;

                return `
                    <tr class="hover:bg-islamic-light">
                        <td class="px-4 py-3 text-sm font-mono text-islamic-dark">INV-${String(idx + 1).padStart(3, '0')}</td>
                        <td class="px-4 py-3 text-sm font-mono text-indigo-600">${c.ticket_id}</td>
                        <td class="px-4 py-3 text-sm text-islamic-dark">${(c.subject || c.title || 'Tanpa Judul').substring(0, 40)}...</td>
                        <td class="px-4 py-3"><span class="status-badge ${stageColors[stage]}">${stage}</span></td>
                        <td class="px-4 py-3">
                            <div class="w-24 bg-slate-200 rounded-full h-2">
                                <div class="bg-indigo-500 h-2 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </td>
                        <td class="px-4 py-3"><span class="status-badge ${getSeverityClass(c.severity)}">${c.severity || 'MEDIUM'}</span></td>
                        <td class="px-4 py-3 text-sm text-slate-500">${c.sla_deadline ? new Date(c.sla_deadline).toLocaleDateString('id-ID') : '-'}</td>
                        <td class="px-4 py-3">
                            <button onclick="openInvestigationCase('${c.id}')" class="text-indigo-600 hover:text-indigo-800">
                                <i data-lucide="external-link" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        function openInvestigationCase(caseId) {
            localStorage.setItem('current_inv_case', caseId);
            showPage('inv-intake');
        }

        // Intake & Mandate Functions
        async function loadIntakePage() {
            const select = document.getElementById('intake-case-select');
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports?status=INVESTIGATING&limit=50`);
                if (response && response.ok) {
                    const data = await response.json();
                    const reports = data.reports || [];
                    select.innerHTML = '<option value="">-- Pilih Laporan --</option>' +
                        reports.map(r => `<option value="${r.id}">${r.ticket_id} - ${(r.subject || r.title || '').substring(0, 50)}</option>`).join('');
                }
            } catch (error) {
                console.log('Error loading reports for intake');
            }

            // Check if there's a pre-selected case
            const currentCase = localStorage.getItem('current_inv_case');
            if (currentCase) {
                select.value = currentCase;
                loadIntakeCase();
            }
        }

        function loadIntakeCase() {
            const caseId = document.getElementById('intake-case-select').value;
            if (!caseId) {
                document.getElementById('intake-form-container').classList.add('hidden');
                document.getElementById('intake-case-summary').classList.add('hidden');
                return;
            }

            document.getElementById('intake-form-container').classList.remove('hidden');
            document.getElementById('intake-case-summary').classList.remove('hidden');

            // Load case summary
            const caseData = investigationData.cases.find(c => c.id === caseId);
            if (caseData) {
                document.getElementById('intake-summary-content').innerHTML = `
                    <div class="flex justify-between"><span class="text-slate-500">Ticket:</span><span class="font-medium">${caseData.ticket_id}</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Severity:</span><span class="font-medium">${caseData.severity || 'MEDIUM'}</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Kategori:</span><span class="font-medium">${caseData.category || '-'}</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Tanggal Masuk:</span><span class="font-medium">${new Date(caseData.created_at).toLocaleDateString('id-ID')}</span></div>
                    <div class="mt-3 pt-3 border-t border-slate-200">
                        <p class="text-slate-500 mb-1">Deskripsi:</p>
                        <p class="text-slate-700 text-xs">${(caseData.description || '').substring(0, 200)}...</p>
                    </div>
                `;
            }

            // Set default dates
            document.getElementById('mandate-start').value = new Date().toISOString().split('T')[0];
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + 30);
            document.getElementById('mandate-target').value = targetDate.toISOString().split('T')[0];
        }

        function submitIntake(event) {
            event.preventDefault();
            alert('Mandat investigasi berhasil ditetapkan! Kasus akan berpindah ke tahap Analisis Data.');
            // In real implementation, save to backend
            showPage('inv-analysis');
        }

        function clearIntakeForm() {
            document.getElementById('intake-form').reset();
        }

        // Analysis Page Functions
        function loadAnalysisPage() {
            const caseList = document.getElementById('analysis-case-list');
            const cases = investigationData.cases;

            if (cases.length === 0) {
                caseList.innerHTML = '<p class="text-sm text-slate-500">Tidak ada kasus aktif</p>';
                return;
            }

            caseList.innerHTML = cases.map(c => `
                <button onclick="selectAnalysisCase('${c.id}')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 border border-transparent hover:border-indigo-200 transition">
                    <p class="font-mono text-sm text-indigo-600">${c.ticket_id}</p>
                    <p class="text-xs text-slate-500 truncate">${(c.subject || c.title || '').substring(0, 30)}</p>
                </button>
            `).join('');
        }

        function selectAnalysisCase(caseId) {
            const caseData = investigationData.cases.find(c => c.id === caseId);
            if (caseData) {
                document.getElementById('analysis-case-title').textContent = caseData.ticket_id;
                localStorage.setItem('current_inv_case', caseId);
            }
        }

        function showAnalysisTab(tab) {
            document.querySelectorAll('.analysis-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');

            document.querySelectorAll('.analysis-tab').forEach(el => {
                el.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-600', 'font-medium');
                el.classList.add('text-slate-500');
            });
            event.target.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-600', 'font-medium');
            event.target.classList.remove('text-slate-500');
        }

        function saveAnalysisNotes(type) {
            alert(`Catatan ${type} berhasil disimpan!`);
        }

        function addTimelineEvent() {
            const date = document.getElementById('timeline-date').value;
            const event = document.getElementById('timeline-event').value;
            if (!date || !event) {
                alert('Tanggal dan deskripsi kejadian harus diisi');
                return;
            }

            investigationData.timeline.push({ date, event });
            renderTimeline();
            document.getElementById('timeline-date').value = '';
            document.getElementById('timeline-event').value = '';
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            if (investigationData.timeline.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-sm">Belum ada timeline.</p>';
                return;
            }

            container.innerHTML = investigationData.timeline
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(t => `
                    <div class="relative">
                        <div class="absolute -left-6 w-3 h-3 bg-indigo-500 rounded-full border-2 border-white"></div>
                        <div class="bg-slate-50 rounded-lg p-3 border">
                            <p class="text-xs text-indigo-600 font-medium">${new Date(t.date).toLocaleDateString('id-ID')}</p>
                            <p class="text-sm text-slate-700">${t.event}</p>
                        </div>
                    </div>
                `).join('');
        }

        async function runAIAnalysis() {
            const caseId = localStorage.getItem('current_inv_case');
            if (!caseId) {
                alert('Pilih kasus terlebih dahulu');
                return;
            }
            alert('AI Analysis sedang dijalankan... Hasil akan ditampilkan di halaman AI Analysis.');
            showPage('analysis');
        }

        // Evidence Page Functions
        function loadEvidencePage() {
            updateEvidenceCounts();
        }

        function updateEvidenceCounts() {
            const evidence = investigationData.evidence;
            document.getElementById('coc-total').textContent = evidence.length;
            document.getElementById('coc-digital').textContent = evidence.filter(e => e.type === 'DIGITAL').length;
            document.getElementById('coc-physical').textContent = evidence.filter(e => e.type === 'PHYSICAL').length;
            document.getElementById('coc-document').textContent = evidence.filter(e => e.type === 'DOCUMENT').length;
        }

        function showAddEvidenceModal() {
            const html = `
                <div id="evidence-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-lg p-6">
                        <h3 class="text-lg font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Tambah Bukti Baru
                        </h3>
                        <form onsubmit="addEvidence(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Jenis Bukti</label>
                                    <select id="ev-type" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                        <option value="DIGITAL">Digital (file, email, log)</option>
                                        <option value="PHYSICAL">Fisik (barang, perangkat)</option>
                                        <option value="DOCUMENT">Dokumen (surat, kontrak)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Deskripsi</label>
                                    <textarea id="ev-desc" rows="2" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Lokasi Pengambilan</label>
                                    <input type="text" id="ev-location" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Lokasi Penyimpanan</label>
                                    <input type="text" id="ev-storage" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Hash (untuk digital)</label>
                                    <input type="text" id="ev-hash" placeholder="SHA-256 hash" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-6">
                                <button type="button" onclick="closeEvidenceModal()" class="px-4 py-2 border border-islamic-green/20 rounded-lg">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">Simpan Bukti</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeEvidenceModal() {
            document.getElementById('evidence-modal')?.remove();
        }

        function addEvidence(event) {
            event.preventDefault();
            const evidence = {
                id: 'EV-' + String(investigationData.evidence.length + 1).padStart(3, '0'),
                type: document.getElementById('ev-type').value,
                description: document.getElementById('ev-desc').value,
                location: document.getElementById('ev-location').value,
                storage: document.getElementById('ev-storage').value,
                hash: document.getElementById('ev-hash').value,
                collected_at: new Date().toISOString(),
                collected_by: currentUser.full_name
            };
            investigationData.evidence.push(evidence);
            closeEvidenceModal();
            renderEvidenceTable();
            updateEvidenceCounts();
            alert('Bukti berhasil ditambahkan dengan Chain of Custody');
        }

        function renderEvidenceTable() {
            const tbody = document.getElementById('evidence-table');
            if (investigationData.evidence.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Belum ada bukti terdaftar</td></tr>';
                return;
            }
            tbody.innerHTML = investigationData.evidence.map(e => `
                <tr class="hover:bg-islamic-light">
                    <td class="px-4 py-3 font-mono text-sm text-amber-600">${e.id}</td>
                    <td class="px-4 py-3"><span class="status-badge bg-amber-100 text-amber-700">${e.type}</span></td>
                    <td class="px-4 py-3 text-sm text-islamic-dark">${e.description.substring(0, 40)}...</td>
                    <td class="px-4 py-3 text-sm text-slate-500">${e.storage}</td>
                    <td class="px-4 py-3"><span class="status-badge bg-islamic-green/20 text-islamic-green">SECURED</span></td>
                    <td class="px-4 py-3">
                        <button onclick="viewEvidenceCoC('${e.id}')" class="text-amber-600 hover:text-amber-800" title="Lihat Chain of Custody">
                            <i data-lucide="link" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function viewEvidenceCoC(evidenceId) {
            const ev = investigationData.evidence.find(e => e.id === evidenceId);
            if (ev) {
                alert(`Chain of Custody - ${ev.id}\n\nDikumpulkan oleh: ${ev.collected_by}\nTanggal: ${new Date(ev.collected_at).toLocaleString('id-ID')}\nLokasi Pengambilan: ${ev.location}\nLokasi Penyimpanan: ${ev.storage}\nHash: ${ev.hash || 'N/A'}`);
            }
        }

        // Interview Page Functions
        function loadInterviewPage() {
            renderInterviewTable();
        }

        function showScheduleInterviewModal() {
            const html = `
                <div id="interview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-lg p-6">
                        <h3 class="text-lg font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Jadwalkan Wawancara
                        </h3>
                        <form onsubmit="scheduleInterview(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Nama Narasumber</label>
                                    <input type="text" id="int-name" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Peran</label>
                                    <select id="int-role" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                        <option value="SUBJECT">Subjek (Terlapor)</option>
                                        <option value="DIRECT_WITNESS">Saksi Langsung</option>
                                        <option value="INDIRECT_WITNESS">Saksi Tidak Langsung</option>
                                        <option value="EXPERT">Ahli/Expert</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-1">Tanggal</label>
                                        <input type="date" id="int-date" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-islamic-dark mb-1">Waktu</label>
                                        <input type="time" id="int-time" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Lokasi</label>
                                    <input type="text" id="int-location" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-6">
                                <button type="button" onclick="closeInterviewModal()" class="px-4 py-2 border border-islamic-green/20 rounded-lg">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600">Jadwalkan</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeInterviewModal() {
            document.getElementById('interview-modal')?.remove();
        }

        function scheduleInterview(event) {
            event.preventDefault();
            const interview = {
                id: 'INT-' + String(investigationData.interviews.length + 1).padStart(3, '0'),
                name: document.getElementById('int-name').value,
                role: document.getElementById('int-role').value,
                date: document.getElementById('int-date').value,
                time: document.getElementById('int-time').value,
                location: document.getElementById('int-location').value,
                status: 'SCHEDULED',
                berita_acara: null
            };
            investigationData.interviews.push(interview);
            closeInterviewModal();
            renderInterviewTable();
            alert('Wawancara berhasil dijadwalkan');
        }

        function renderInterviewTable() {
            const tbody = document.getElementById('interview-table');
            if (investigationData.interviews.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Belum ada wawancara terjadwal</td></tr>';
                return;
            }

            const roleColors = {
                'SUBJECT': 'bg-red-100 text-red-700',
                'DIRECT_WITNESS': 'bg-blue-100 text-blue-700',
                'INDIRECT_WITNESS': 'bg-amber-100 text-amber-700',
                'EXPERT': 'bg-green-100 text-green-700'
            };

            tbody.innerHTML = investigationData.interviews.map(i => `
                <tr class="hover:bg-islamic-light">
                    <td class="px-4 py-3 text-sm text-islamic-dark">${new Date(i.date).toLocaleDateString('id-ID')} ${i.time}</td>
                    <td class="px-4 py-3 text-sm text-islamic-dark font-medium">${i.name}</td>
                    <td class="px-4 py-3"><span class="status-badge ${roleColors[i.role]}">${i.role.replace('_', ' ')}</span></td>
                    <td class="px-4 py-3"><span class="status-badge ${i.status === 'COMPLETED' ? 'bg-islamic-green/20 text-islamic-green' : 'bg-blue-100 text-blue-700'}">${i.status}</span></td>
                    <td class="px-4 py-3">${i.berita_acara ? '<span class="text-islamic-green"><i data-lucide="check-circle" class="w-4 h-4"></i></span>' : '<span class="text-slate-400">-</span>'}</td>
                    <td class="px-4 py-3">
                        <button onclick="openBeritaAcara('${i.id}')" class="text-teal-600 hover:text-teal-800" title="Buat Berita Acara">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function openBeritaAcara(interviewId) {
            const interview = investigationData.interviews.find(i => i.id === interviewId);
            if (!interview) return;

            document.getElementById('berita-acara-form').classList.remove('hidden');
            document.getElementById('ba-number').value = `BA/${interview.id}/${new Date().getFullYear()}`;
            document.getElementById('ba-datetime').value = `${interview.date}T${interview.time}`;
            document.getElementById('ba-location').value = interview.location;
            document.getElementById('ba-interviewer').value = currentUser.full_name;

            localStorage.setItem('current_interview', interviewId);
        }

        function hideBeritaAcaraForm() {
            document.getElementById('berita-acara-form').classList.add('hidden');
        }

        function saveBeritaAcara(event) {
            event.preventDefault();
            const interviewId = localStorage.getItem('current_interview');
            const interview = investigationData.interviews.find(i => i.id === interviewId);
            if (interview) {
                interview.status = 'COMPLETED';
                interview.berita_acara = {
                    number: document.getElementById('ba-number').value,
                    datetime: document.getElementById('ba-datetime').value,
                    location: document.getElementById('ba-location').value,
                    interviewer: document.getElementById('ba-interviewer').value,
                    content: document.getElementById('ba-content').value,
                    conclusion: document.getElementById('ba-conclusion').value
                };
            }
            hideBeritaAcaraForm();
            renderInterviewTable();
            alert('Berita Acara berhasil disimpan');
        }

        // Findings Page Functions
        function loadFindingsPage() {
            renderFindingsTable();
            updateReportChecklist();
        }

        function showAddFindingModal() {
            const html = `
                <div id="finding-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl w-full max-w-2xl p-6">
                        <h3 class="text-lg font-semibold text-islamic-dark mb-4 flex items-center gap-2">
                            <span class="text-islamic-gold">€ù</span>
                            Tambah Temuan
                        </h3>
                        <form onsubmit="addFinding(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Deskripsi Temuan</label>
                                    <textarea id="find-desc" rows="3" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Bukti Pendukung</label>
                                    <input type="text" id="find-evidence" required placeholder="ID bukti (pisahkan dengan koma)" class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Regulasi yang Dilanggar</label>
                                    <input type="text" id="find-regulation" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-islamic-dark mb-1">Dampak</label>
                                    <select id="find-impact" required class="w-full px-4 py-2 border border-islamic-green/20 rounded-lg">
                                        <option value="HIGH">Tinggi - Kerugian signifikan</option>
                                        <option value="MEDIUM">Sedang - Kerugian moderat</option>
                                        <option value="LOW">Rendah - Kerugian minimal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-6">
                                <button type="button" onclick="closeFindingModal()" class="px-4 py-2 border border-islamic-green/20 rounded-lg">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeFindingModal() {
            document.getElementById('finding-modal')?.remove();
        }

        function addFinding(event) {
            event.preventDefault();
            const finding = {
                id: investigationData.findings.length + 1,
                description: document.getElementById('find-desc').value,
                evidence: document.getElementById('find-evidence').value,
                regulation: document.getElementById('find-regulation').value,
                impact: document.getElementById('find-impact').value
            };
            investigationData.findings.push(finding);
            closeFindingModal();
            renderFindingsTable();
            updateReportChecklist();
            alert('Temuan berhasil ditambahkan');
        }

        function renderFindingsTable() {
            const tbody = document.getElementById('findings-table');
            if (investigationData.findings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">Belum ada temuan.</td></tr>';
                return;
            }

            const impactColors = {
                'HIGH': 'bg-red-100 text-red-700',
                'MEDIUM': 'bg-amber-100 text-amber-700',
                'LOW': 'bg-blue-100 text-blue-700'
            };

            tbody.innerHTML = investigationData.findings.map(f => `
                <tr class="hover:bg-islamic-light">
                    <td class="px-4 py-3 text-sm text-islamic-dark">${f.id}</td>
                    <td class="px-4 py-3 text-sm text-islamic-dark">${f.description.substring(0, 50)}...</td>
                    <td class="px-4 py-3 text-sm text-slate-500">${f.evidence}</td>
                    <td class="px-4 py-3 text-sm text-slate-500">${f.regulation}</td>
                    <td class="px-4 py-3"><span class="status-badge ${impactColors[f.impact]}">${f.impact}</span></td>
                    <td class="px-4 py-3">
                        <button onclick="deleteFinding(${f.id})" class="text-red-500 hover:text-red-700">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function deleteFinding(id) {
            if (confirm('Hapus temuan ini?')) {
                investigationData.findings = investigationData.findings.filter(f => f.id !== id);
                renderFindingsTable();
            }
        }

        function saveRecommendations() {
            alert('Rekomendasi berhasil disimpan');
            updateReportChecklist();
        }

        function saveManagementResponse() {
            alert('Tanggapan manajemen berhasil disimpan');
        }

        function updateReportChecklist() {
            // Simple checklist update logic
            const checkItems = ['mandate', 'analysis', 'evidence', 'interview', 'findings', 'recommendations'];
            const hasData = {
                mandate: true, // Assumed from intake
                analysis: investigationData.timeline.length > 0,
                evidence: investigationData.evidence.length > 0,
                interview: investigationData.interviews.filter(i => i.status === 'COMPLETED').length > 0,
                findings: investigationData.findings.length > 0,
                recommendations: document.getElementById('rec-corrective')?.value?.length > 0
            };

            checkItems.forEach(item => {
                const el = document.getElementById(`check-${item}`);
                if (el && hasData[item]) {
                    el.classList.remove('border-slate-300');
                    el.classList.add('border-islamic-green', 'bg-islamic-green');
                    el.querySelector('i').classList.remove('text-slate-300');
                    el.querySelector('i').classList.add('text-white');
                }
            });
        }

        function generateFinalReport() {
            if (investigationData.findings.length === 0) {
                alert('Harap tambahkan minimal satu temuan sebelum generate laporan');
                return;
            }
            alert('Laporan Final Investigasi sedang di-generate...\n\nLaporan akan mencakup:\n- Mandat & Ruang Lingkup\n- Metodologi Investigasi\n- Analisis Data\n- Daftar Bukti & Chain of Custody\n- Hasil Wawancara\n- Matriks Temuan\n- Rekomendasi Tindakan\n- Tanggapan Manajemen');
        }

        function previewReport() {
            alert('Fitur preview laporan dalam pengembangan');
        }

        // ============================================
        // MANAGER DASHBOARD FUNCTIONS
        // ============================================

        async function loadManagerOverview() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/dashboard/stats`);
                if (!response || !response.ok) throw new Error('Failed to load stats');
                const data = await response.json();

                // Update KPIs
                document.getElementById('mgr-kpi-total').textContent = data.total_reports || 0;
                document.getElementById('mgr-kpi-sla-risk').textContent = data.sla_at_risk || 0;
                document.getElementById('mgr-kpi-pending').textContent = data.pending_review || 0;

                // Calculate resolution rate
                const total = data.total_reports || 1;
                const closed = (data.status_breakdown?.CLOSED_PROVEN || 0) + (data.status_breakdown?.CLOSED_NOT_PROVEN || 0) + (data.status_breakdown?.CLOSED_DROPPED || 0);
                const resolutionRate = Math.round((closed / total) * 100);
                document.getElementById('mgr-kpi-resolution').textContent = resolutionRate + '%';

                // Update status distribution
                if (data.status_breakdown) {
                    document.getElementById('mgr-stat-new').textContent = data.status_breakdown.NEW || 0;
                    document.getElementById('mgr-stat-reviewing').textContent = data.status_breakdown.REVIEWING || 0;
                    document.getElementById('mgr-stat-investigating').textContent = data.status_breakdown.INVESTIGATING || 0;
                    document.getElementById('mgr-stat-escalated').textContent = data.status_breakdown.ESCALATED || 0;
                }

                // Update severity breakdown
                if (data.severity_breakdown) {
                    const sevTotal = Object.values(data.severity_breakdown).reduce((a, b) => a + b, 0) || 1;
                    const critical = data.severity_breakdown.CRITICAL || 0;
                    const high = data.severity_breakdown.HIGH || 0;
                    const medium = data.severity_breakdown.MEDIUM || 0;
                    const low = data.severity_breakdown.LOW || 0;

                    document.getElementById('mgr-sev-critical').style.width = (critical / sevTotal * 100) + '%';
                    document.getElementById('mgr-sev-critical-count').textContent = critical;
                    document.getElementById('mgr-sev-high').style.width = (high / sevTotal * 100) + '%';
                    document.getElementById('mgr-sev-high-count').textContent = high;
                    document.getElementById('mgr-sev-medium').style.width = (medium / sevTotal * 100) + '%';
                    document.getElementById('mgr-sev-medium-count').textContent = medium;
                    document.getElementById('mgr-sev-low').style.width = (low / sevTotal * 100) + '%';
                    document.getElementById('mgr-sev-low-count').textContent = low;
                }

                // Update urgent alerts
                const alertsEl = document.getElementById('mgr-urgent-alerts');
                const alerts = [];
                if (data.sla_at_risk > 0) alerts.push(`<div class="p-2 bg-red-100 rounded text-sm">${data.sla_at_risk} laporan hampir breach SLA</div>`);
                if (data.status_breakdown?.ESCALATED > 0) alerts.push(`<div class="p-2 bg-orange-100 rounded text-sm">${data.status_breakdown.ESCALATED} kasus eskalasi menunggu</div>`);
                if (data.severity_breakdown?.CRITICAL > 0) alerts.push(`<div class="p-2 bg-red-100 rounded text-sm">${data.severity_breakdown.CRITICAL} kasus CRITICAL aktif</div>`);
                alertsEl.innerHTML = alerts.length > 0 ? alerts.join('') : '<p class="text-sm text-green-600">Tidak ada alert mendesak</p>';

                // Update recent activity
                document.getElementById('mgr-recent-activity').innerHTML = `
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-slate-600">Dashboard dimuat</span>
                        <span class="text-slate-400 ml-auto text-xs">${new Date().toLocaleTimeString('id-ID')}</span>
                    </div>
                `;

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading manager overview:', error);
            }
        }

        async function loadManagerEscalation() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports?status=ESCALATED&limit=20`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const reports = data.reports || [];

                // Update escalated count
                document.getElementById('mgr-escalated-count').textContent = reports.length;

                // Render escalated list
                const listEl = document.getElementById('mgr-escalated-list');
                if (reports.length === 0) {
                    listEl.innerHTML = '<div class="p-4 bg-green-50 rounded-lg text-center text-green-600">Tidak ada kasus eskalasi</div>';
                } else {
                    listEl.innerHTML = reports.map(r => `
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                            <div class="flex items-start justify-between">
                                <div>
                                    <span class="font-mono text-sm bg-red-100 px-2 py-1 rounded">${r.ticket_id}</span>
                                    <span class="ml-2 px-2 py-1 bg-${getSeverityColor(r.severity)}-100 text-${getSeverityColor(r.severity)}-700 text-xs rounded">${r.severity || 'MEDIUM'}</span>
                                </div>
                                <span class="text-xs text-red-600">${formatDate(r.created_at)}</span>
                            </div>
                            <p class="mt-2 text-sm text-slate-700">${escapeHtml(r.subject || r.title || '-')}</p>
                            <div class="mt-3 flex gap-2">
                                <button onclick="approveEscalation('${r.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">Approve</button>
                                <button onclick="viewReportModal('${r.id}')" class="px-3 py-1 bg-slate-200 text-slate-700 rounded text-sm hover:bg-slate-300">Detail</button>
                            </div>
                        </div>
                    `).join('');
                }

                // Load pending approvals (using REVIEWING status as proxy)
                const pendingResponse = await authFetch(`${API_URL}/api/v1/reports?status=REVIEWING&limit=10`);
                if (pendingResponse && pendingResponse.ok) {
                    const pendingData = await pendingResponse.json();
                    const pending = pendingData.reports || [];
                    document.getElementById('mgr-pending-count').textContent = pending.length;

                    const pendingListEl = document.getElementById('mgr-pending-list');
                    if (pending.length === 0) {
                        pendingListEl.innerHTML = '<div class="p-4 bg-slate-50 rounded-lg text-center text-slate-500">Tidak ada item menunggu persetujuan</div>';
                    } else {
                        pendingListEl.innerHTML = pending.map(r => `
                            <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
                                <div class="flex items-start justify-between">
                                    <span class="font-mono text-sm bg-amber-100 px-2 py-1 rounded">${r.ticket_id}</span>
                                    <span class="text-xs text-amber-600">${formatDate(r.created_at)}</span>
                                </div>
                                <p class="mt-2 text-sm text-slate-700">${escapeHtml(r.subject || r.title || '-')}</p>
                                <div class="mt-3 flex gap-2">
                                    <button onclick="approveReport('${r.id}')" class="px-3 py-1 bg-islamic-green text-white rounded text-sm hover:bg-islamic-dark">Approve</button>
                                    <button onclick="viewReportModal('${r.id}')" class="px-3 py-1 bg-slate-200 text-slate-700 rounded text-sm hover:bg-slate-300">Detail</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading escalation:', error);
            }
        }

        function approveEscalation(reportId) {
            if (confirm('Setujui eskalasi kasus ini?')) {
                updateReportStatus(reportId, 'INVESTIGATING');
            }
        }

        function approveReport(reportId) {
            if (confirm('Setujui laporan ini untuk investigasi?')) {
                updateReportStatus(reportId, 'INVESTIGATING');
            }
        }

        async function loadManagerSLA() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=100`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const reports = data.reports || [];

                // Calculate SLA status for each report
                const slaConfig = {
                    'CRITICAL': { response: 4, resolution: 72 },
                    'HIGH': { response: 8, resolution: 168 },
                    'MEDIUM': { response: 24, resolution: 336 },
                    'LOW': { response: 48, resolution: 720 }
                };

                let onTrack = 0, atRisk = 0, warning = 0, breached = 0;
                const tableRows = [];

                reports.forEach(r => {
                    if (r.status?.includes('CLOSED')) return;

                    const created = new Date(r.created_at);
                    const now = new Date();
                    const hoursElapsed = (now - created) / (1000 * 60 * 60);
                    const config = slaConfig[r.severity] || slaConfig['MEDIUM'];
                    const hoursRemaining = config.resolution - hoursElapsed;

                    let slaStatus = 'on-track';
                    if (hoursRemaining <= 0) {
                        breached++;
                        slaStatus = 'breached';
                    } else if (hoursRemaining <= 24) {
                        atRisk++;
                        slaStatus = 'at-risk';
                    } else if (hoursRemaining <= 48) {
                        warning++;
                        slaStatus = 'warning';
                    } else {
                        onTrack++;
                    }

                    const statusColors = {
                        'on-track': 'bg-green-100 text-green-700',
                        'at-risk': 'bg-yellow-100 text-yellow-700',
                        'warning': 'bg-orange-100 text-orange-700',
                        'breached': 'bg-red-100 text-red-700'
                    };

                    tableRows.push(`
                        <tr data-sla="${slaStatus}">
                            <td class="px-4 py-3 font-mono text-sm">${r.ticket_id}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 bg-${getSeverityColor(r.severity)}-100 text-${getSeverityColor(r.severity)}-700 text-xs rounded">${r.severity || 'MEDIUM'}</span></td>
                            <td class="px-4 py-3 text-sm">${config.resolution}h</td>
                            <td class="px-4 py-3 text-sm">${Math.round(hoursElapsed)}h</td>
                            <td class="px-4 py-3 text-sm font-medium ${hoursRemaining <= 0 ? 'text-red-600' : ''}">${hoursRemaining <= 0 ? 'OVERDUE' : Math.round(hoursRemaining) + 'h'}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 ${statusColors[slaStatus]} text-xs rounded">${slaStatus.toUpperCase()}</span></td>
                            <td class="px-4 py-3"><button onclick="viewReportModal('${r.id}')" class="text-islamic-green hover:underline text-sm">Detail</button></td>
                        </tr>
                    `);
                });

                document.getElementById('sla-on-track').textContent = onTrack;
                document.getElementById('sla-at-risk').textContent = atRisk;
                document.getElementById('sla-warning').textContent = warning;
                document.getElementById('sla-breached').textContent = breached;

                document.getElementById('sla-table-body').innerHTML = tableRows.length > 0 ? tableRows.join('') :
                    '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">Tidak ada data SLA</td></tr>';

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading SLA:', error);
            }
        }

        function filterSLATable() {
            const filter = document.getElementById('sla-filter').value;
            const rows = document.querySelectorAll('#sla-table-body tr[data-sla]');
            rows.forEach(row => {
                if (filter === 'all' || row.dataset.sla === filter) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }

        async function loadManagerRisk() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=100`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const reports = data.reports || [];

                // Calculate risk matrix based on severity
                let totalLoss = 0;
                const riskMatrix = {
                    'hl-li': 0, 'hl-mi': 0, 'hl-hi': 0,
                    'ml-li': 0, 'ml-mi': 0, 'ml-hi': 0,
                    'll-li': 0, 'll-mi': 0, 'll-hi': 0
                };

                const lossEstimates = {
                    'CRITICAL': 1000000000,
                    'HIGH': 500000000,
                    'MEDIUM': 100000000,
                    'LOW': 50000000
                };

                reports.forEach(r => {
                    if (r.status?.includes('CLOSED')) return;
                    totalLoss += lossEstimates[r.severity] || lossEstimates['MEDIUM'];

                    // Map severity to risk matrix
                    if (r.severity === 'CRITICAL') riskMatrix['hl-hi']++;
                    else if (r.severity === 'HIGH') riskMatrix['hl-mi']++;
                    else if (r.severity === 'MEDIUM') riskMatrix['ml-mi']++;
                    else riskMatrix['ll-li']++;
                });

                document.getElementById('risk-total-loss').textContent = 'Rp ' + (totalLoss / 1000000000).toFixed(1) + ' M';

                // Update risk heat map
                Object.keys(riskMatrix).forEach(key => {
                    const el = document.getElementById(`risk-${key}`);
                    if (el) el.textContent = riskMatrix[key];
                });

                // Update top risk areas
                const categories = {};
                reports.forEach(r => {
                    const cat = r.category || 'Lainnya';
                    categories[cat] = (categories[cat] || 0) + 1;
                });

                const topAreas = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                document.getElementById('risk-top-areas').innerHTML = topAreas.map(([cat, count]) => `
                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded">
                        <span class="text-sm text-slate-600">${cat}</span>
                        <span class="text-sm font-medium text-islamic-dark">${count}</span>
                    </div>
                `).join('') || '<div class="p-2 bg-slate-50 rounded text-sm text-slate-500">Tidak ada data</div>';

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading risk:', error);
            }
        }

        function showRiskDetails(level) {
            alert(`Menampilkan detail risiko level: ${level.toUpperCase()}\n\nFitur dalam pengembangan`);
        }

        async function loadManagerPerformance() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/dashboard/stats`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();

                document.getElementById('perf-total-received').textContent = data.total_reports || 0;

                const closed = (data.status_breakdown?.CLOSED_PROVEN || 0) +
                               (data.status_breakdown?.CLOSED_NOT_PROVEN || 0) +
                               (data.status_breakdown?.CLOSED_DROPPED || 0);
                document.getElementById('perf-total-closed').textContent = closed;

                // Mock avg resolution and proven rate
                document.getElementById('perf-avg-resolution').textContent = '12';
                const provenRate = closed > 0 ? Math.round((data.status_breakdown?.CLOSED_PROVEN || 0) / closed * 100) : 0;
                document.getElementById('perf-proven-rate').textContent = provenRate + '%';

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading performance:', error);
            }
        }

        // ============================================
        // INTAKE OFFICER DASHBOARD FUNCTIONS
        // ============================================

        let selectedIntakeTicket = null;
        let selectedCommTicket = null;

        async function loadIntakeQueue() {
            try {
                // Fetch all reports and filter client-side for intake officer statuses
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=100`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const intakeStatuses = ['NEW', 'REVIEWING', 'NEED_INFO'];
                const reports = (data.reports || []).filter(r => intakeStatuses.includes(r.status));

                // Update counts
                const newCount = reports.filter(r => r.status === 'NEW').length;
                const reviewingCount = reports.filter(r => r.status === 'REVIEWING').length;
                const needInfoCount = reports.filter(r => r.status === 'NEED_INFO').length;
                const priorityCount = reports.filter(r => r.severity === 'CRITICAL' || r.severity === 'HIGH').length;

                document.getElementById('intake-new-count').textContent = newCount;
                document.getElementById('intake-reviewing-count').textContent = reviewingCount;
                document.getElementById('intake-needinfo-count').textContent = needInfoCount;
                document.getElementById('intake-priority-count').textContent = priorityCount;

                // Update badge in sidebar
                const badgeEl = document.getElementById('intake-queue-badge');
                if (badgeEl) badgeEl.textContent = newCount;

                // Render table
                const tbody = document.getElementById('intake-queue-body');
                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-slate-500">Tidak ada laporan dalam antrian</td></tr>';
                } else {
                    tbody.innerHTML = reports.map(r => {
                        const statusColors = {
                            'NEW': 'bg-blue-100 text-blue-700',
                            'REVIEWING': 'bg-yellow-100 text-yellow-700',
                            'NEED_INFO': 'bg-purple-100 text-purple-700'
                        };
                        const channelColors = {
                            'WEB': 'bg-blue-100 text-blue-700',
                            'WHATSAPP': 'bg-green-100 text-green-700',
                            'EMAIL': 'bg-amber-100 text-amber-700'
                        };
                        return `
                            <tr class="hover:bg-slate-50 cursor-pointer" onclick="selectIntakeReport('${r.id}')">
                                <td class="px-4 py-3 font-mono text-sm">${r.ticket_id}</td>
                                <td class="px-4 py-3 text-sm">${formatDate(r.created_at)}</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 ${channelColors[r.channel] || channelColors['WEB']} text-xs rounded">${r.channel || 'WEB'}</span></td>
                                <td class="px-4 py-3 text-sm">${escapeHtml(r.category || '-')}</td>
                                <td class="px-4 py-3 text-sm max-w-xs truncate">${escapeHtml(r.subject || r.title || '-')}</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 ${statusColors[r.status] || ''} text-xs rounded">${r.status}</span></td>
                                <td class="px-4 py-3"><span class="px-2 py-1 bg-${getSeverityColor(r.severity)}-100 text-${getSeverityColor(r.severity)}-700 text-xs rounded">${r.severity || '-'}</span></td>
                                <td class="px-4 py-3">
                                    <button onclick="event.stopPropagation(); selectIntakeReport('${r.id}'); showPage('intake-review')" class="text-islamic-green hover:underline text-sm">Review</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading intake queue:', error);
            }
        }

        function filterIntakeQueue() {
            const filter = document.getElementById('intake-queue-filter').value;
            // Reload with filter
            loadIntakeQueue();
        }

        async function selectIntakeReport(reportId) {
            selectedIntakeTicket = reportId;
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports/${reportId}`);
                if (!response || !response.ok) throw new Error('Failed');
                const report = await response.json();

                document.getElementById('review-ticket-id').textContent = report.ticket_id;
                document.getElementById('review-report-content').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-500">Subjek</label>
                            <p class="font-medium text-islamic-dark">${escapeHtml(report.subject || report.title || '-')}</p>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500">Kategori</label>
                            <p class="text-islamic-dark">${escapeHtml(report.category || '-')}</p>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500">Deskripsi</label>
                            <p class="text-slate-700 whitespace-pre-wrap">${escapeHtml(report.description || '-')}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-slate-500">Tanggal</label>
                                <p class="text-islamic-dark">${formatDate(report.created_at)}</p>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500">Sumber</label>
                                <p class="text-islamic-dark">${report.channel || 'WEB'}</p>
                            </div>
                        </div>
                    </div>
                `;

                // Show AI analysis if available
                if (report.ai_analysis) {
                    const analysis = typeof report.ai_analysis === 'string' ? JSON.parse(report.ai_analysis) : report.ai_analysis;
                    document.getElementById('review-ai-analysis').innerHTML = `
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="p-2 bg-white rounded">
                                <span class="text-purple-600 font-medium">Severity:</span> ${analysis.severity || '-'}
                            </div>
                            <div class="p-2 bg-white rounded">
                                <span class="text-purple-600 font-medium">Fraud Score:</span> ${analysis.fraud_score || '-'}
                            </div>
                        </div>
                        ${analysis.summary ? `<p class="mt-2 text-sm text-purple-700">${escapeHtml(analysis.summary)}</p>` : ''}
                    `;
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading report:', error);
            }
        }

        function loadIntakeReviewPage() {
            if (selectedIntakeTicket) {
                selectIntakeReport(selectedIntakeTicket);
            }
        }

        async function acceptReport() {
            if (!selectedIntakeTicket) {
                alert('Pilih laporan terlebih dahulu');
                return;
            }
            if (confirm('Terima laporan ini dan teruskan ke investigasi?')) {
                await updateReportStatus(selectedIntakeTicket, 'INVESTIGATING');
                selectedIntakeTicket = null;
                showPage('intake-queue');
            }
        }

        async function requestMoreInfo() {
            if (!selectedIntakeTicket) {
                alert('Pilih laporan terlebih dahulu');
                return;
            }
            const message = prompt('Pesan untuk pelapor (informasi yang dibutuhkan):');
            if (message) {
                await updateReportStatus(selectedIntakeTicket, 'NEED_INFO');
                // Send message to reporter
                try {
                    await authFetch(`${API_URL}/api/v1/tickets/${selectedIntakeTicket}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: message, is_admin: true })
                    });
                } catch (e) { console.error(e); }
                showPage('intake-queue');
            }
        }

        async function rejectReport() {
            if (!selectedIntakeTicket) {
                alert('Pilih laporan terlebih dahulu');
                return;
            }
            const reason = prompt('Alasan penolakan:');
            if (reason && confirm('Yakin ingin menolak laporan ini?')) {
                await updateReportStatus(selectedIntakeTicket, 'CLOSED_DROPPED');
                selectedIntakeTicket = null;
                showPage('intake-queue');
            }
        }

        async function loadIntakeCommunicate() {
            try {
                // Fetch all and filter client-side
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=100`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const commStatuses = ['NEW', 'REVIEWING', 'NEED_INFO'];
                const reports = (data.reports || []).filter(r => commStatuses.includes(r.status));

                const listEl = document.getElementById('comm-ticket-list');
                if (reports.length === 0) {
                    listEl.innerHTML = '<div class="p-3 bg-slate-50 rounded-lg text-center text-slate-500">Tidak ada komunikasi pending</div>';
                } else {
                    listEl.innerHTML = reports.map(r => `
                        <div onclick="selectCommTicket('${r.ticket_id}', '${r.status}')" class="p-3 rounded-lg cursor-pointer hover:bg-islamic-green/10 border border-transparent hover:border-islamic-green/20 ${selectedCommTicket === r.ticket_id ? 'bg-islamic-green/10 border-islamic-green/20' : 'bg-slate-50'}">
                            <div class="flex items-center justify-between">
                                <span class="font-mono text-sm font-medium">${r.ticket_id}</span>
                                <span class="text-xs px-2 py-0.5 rounded ${r.status === 'NEED_INFO' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">${r.status}</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1 truncate">${escapeHtml(r.subject || r.title || '-')}</p>
                        </div>
                    `).join('');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading communicate:', error);
            }
        }

        async function selectCommTicket(ticketId, status) {
            selectedCommTicket = ticketId;
            document.getElementById('comm-current-ticket').textContent = ticketId;
            document.getElementById('comm-current-status').textContent = status;
            await loadChatHistory();
            loadIntakeCommunicate(); // Refresh list to update selection
        }

        async function loadChatHistory() {
            if (!selectedCommTicket) return;

            const messagesEl = document.getElementById('comm-messages');
            try {
                const response = await authFetch(`${API_URL}/api/v1/tickets/${selectedCommTicket}/messages`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const messages = data.messages || [];

                if (messages.length === 0) {
                    messagesEl.innerHTML = '<div class="text-center text-slate-500 py-8">Belum ada pesan</div>';
                } else {
                    messagesEl.innerHTML = messages.map(m => {
                        const isAdmin = m.is_admin;
                        return `
                            <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-[70%] p-3 rounded-lg ${isAdmin ? 'bg-islamic-green text-white' : 'bg-white border border-slate-200'}">
                                    <p class="text-sm">${escapeHtml(m.content)}</p>
                                    <p class="text-xs ${isAdmin ? 'text-emerald-200' : 'text-slate-400'} mt-1">${formatDate(m.created_at)}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat:', error);
                messagesEl.innerHTML = '<div class="text-center text-red-500 py-8">Gagal memuat pesan</div>';
            }
        }

        async function sendMessage() {
            if (!selectedCommTicket) {
                alert('Pilih tiket terlebih dahulu');
                return;
            }

            const input = document.getElementById('comm-message-input');
            const content = input.value.trim();
            if (!content) return;

            try {
                const response = await authFetch(`${API_URL}/api/v1/tickets/${selectedCommTicket}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, is_admin: true })
                });

                if (response && response.ok) {
                    input.value = '';
                    await loadChatHistory();
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Gagal mengirim pesan');
            }
        }

        function sendTemplate(type) {
            const templates = {
                'request_info': 'Terima kasih atas laporan Anda. Untuk menindaklanjuti, kami memerlukan informasi tambahan:\n\n1. [Detail spesifik yang dibutuhkan]\n2. [Bukti pendukung jika ada]\n\nMohon berikan informasi tersebut melalui portal ini.',
                'update_status': 'Yth. Pelapor,\n\nKami informasikan bahwa laporan Anda sedang dalam proses [STATUS]. Tim kami akan menghubungi Anda jika memerlukan informasi tambahan.\n\nTerima kasih atas kesabaran Anda.',
                'thank_you': 'Terima kasih atas informasi tambahan yang Anda berikan. Laporan Anda akan segera kami tindaklanjuti.\n\nJika ada pertanyaan, silakan hubungi kami melalui portal ini.'
            };

            document.getElementById('comm-message-input').value = templates[type] || '';
        }

        async function loadIntakeEscalate() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=50`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const reports = data.reports || [];

                // Filter reports that need escalation (CRITICAL/HIGH severity or high fraud score)
                const needsEscalation = reports.filter(r =>
                    !r.status?.includes('CLOSED') &&
                    !r.status?.includes('ESCALATED') &&
                    (r.severity === 'CRITICAL' || r.severity === 'HIGH')
                );

                const listEl = document.getElementById('escalate-list');
                if (needsEscalation.length === 0) {
                    listEl.innerHTML = '<div class="p-4 bg-green-50 rounded-lg text-center text-green-600">Tidak ada laporan yang perlu dieskalasi</div>';
                } else {
                    listEl.innerHTML = needsEscalation.map(r => `
                        <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="flex items-start justify-between">
                                <div>
                                    <span class="font-mono text-sm bg-amber-100 px-2 py-1 rounded">${r.ticket_id}</span>
                                    <span class="ml-2 px-2 py-1 bg-${getSeverityColor(r.severity)}-100 text-${getSeverityColor(r.severity)}-700 text-xs rounded">${r.severity}</span>
                                </div>
                                <span class="text-xs text-amber-600">${formatDate(r.created_at)}</span>
                            </div>
                            <p class="mt-2 text-sm text-slate-700">${escapeHtml(r.subject || r.title || '-')}</p>
                            <div class="mt-3 flex gap-2">
                                <button onclick="escalateToManager('${r.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">Eskalasi ke Manager</button>
                                <button onclick="viewReportModal('${r.id}')" class="px-3 py-1 bg-slate-200 text-slate-700 rounded text-sm hover:bg-slate-300">Lihat Detail</button>
                            </div>
                        </div>
                    `).join('');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading escalate:', error);
            }
        }

        async function escalateToManager(reportId) {
            if (confirm('Eskalasi laporan ini ke Manager?')) {
                await updateReportStatus(reportId, 'ESCALATED');
                loadIntakeEscalate();
            }
        }

        function viewReportDetail(ticketId) {
            // Navigate to reports page and show detail
            showPage('reports');
        }

        // Helper function for severity colors
        function getSeverityColor(severity) {
            const colors = {
                'CRITICAL': 'red',
                'HIGH': 'orange',
                'MEDIUM': 'yellow',
                'LOW': 'green'
            };
            return colors[severity] || 'slate';
        }

        function getStatusColor(status) {
            const colors = {
                'NEW': 'blue',
                'REVIEWING': 'yellow',
                'NEED_INFO': 'purple',
                'INVESTIGATING': 'indigo',
                'ESCALATED': 'red',
                'CLOSED_PROVEN': 'green',
                'CLOSED_NOT_PROVEN': 'slate',
                'CLOSED_DROPPED': 'slate'
            };
            return colors[status] || 'slate';
        }

        // View Report Modal
        async function viewReportModal(reportId) {
            try {
                const response = await authFetch(`${API_URL}/api/v1/reports/${reportId}`);
                if (!response || !response.ok) throw new Error('Failed to load report');
                const report = await response.json();

                const analysis = report.ai_analysis ? (typeof report.ai_analysis === 'string' ? JSON.parse(report.ai_analysis) : report.ai_analysis) : null;

                const modalHtml = `
                    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'report-modal') closeReportModal()">
                        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                            <div class="bg-gradient-to-r from-islamic-green to-islamic-dark text-white p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-emerald-200 text-sm">Detail Laporan</p>
                                        <h2 class="text-xl font-bold">${report.ticket_id}</h2>
                                    </div>
                                    <button onclick="closeReportModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Left Column -->
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-xs text-slate-500 uppercase tracking-wider">Subjek</label>
                                            <p class="font-medium text-islamic-dark">${escapeHtml(report.subject || report.title || '-')}</p>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 uppercase tracking-wider">Kategori</label>
                                            <p class="text-islamic-dark">${escapeHtml(report.category || '-')}</p>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 uppercase tracking-wider">Deskripsi</label>
                                            <p class="text-slate-700 whitespace-pre-wrap text-sm bg-slate-50 p-3 rounded-lg max-h-48 overflow-y-auto">${escapeHtml(report.description || '-')}</p>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="text-xs text-slate-500 uppercase tracking-wider">Tanggal Lapor</label>
                                                <p class="text-islamic-dark">${formatDate(report.created_at)}</p>
                                            </div>
                                            <div>
                                                <label class="text-xs text-slate-500 uppercase tracking-wider">Sumber</label>
                                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">${report.channel || 'WEB'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Right Column -->
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="text-xs text-slate-500 uppercase tracking-wider">Status</label>
                                                <p><span class="px-2 py-1 bg-${getStatusColor(report.status)}-100 text-${getStatusColor(report.status)}-700 text-sm rounded">${report.status}</span></p>
                                            </div>
                                            <div>
                                                <label class="text-xs text-slate-500 uppercase tracking-wider">Severity</label>
                                                <p><span class="px-2 py-1 bg-${getSeverityColor(report.severity)}-100 text-${getSeverityColor(report.severity)}-700 text-sm rounded">${report.severity || '-'}</span></p>
                                            </div>
                                        </div>
                                        ${analysis ? `
                                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                            <h4 class="font-medium text-purple-800 mb-3 flex items-center gap-2">
                                                <i data-lucide="cpu" class="w-4 h-4"></i>
                                                Hasil Analisis AI
                                            </h4>
                                            <div class="space-y-2 text-sm">
                                                <div class="flex justify-between">
                                                    <span class="text-purple-600">Fraud Score:</span>
                                                    <span class="font-bold text-purple-800">${analysis.fraud_score || '-'}</span>
                                                </div>
                                                ${analysis.summary ? `<p class="text-purple-700 mt-2">${escapeHtml(analysis.summary)}</p>` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                        <div class="bg-slate-50 p-4 rounded-lg">
                                            <h4 class="font-medium text-slate-700 mb-3">Aksi</h4>
                                            <div class="space-y-2">
                                                <button onclick="closeReportModal(); updateReportStatus('${report.id}', 'INVESTIGATING')" class="w-full px-4 py-2 bg-islamic-green text-white rounded-lg hover:bg-islamic-dark text-sm">
                                                    Proses ke Investigasi
                                                </button>
                                                <button onclick="closeReportModal(); updateReportStatus('${report.id}', 'ESCALATED')" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                                                    Eskalasi
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('report-modal');
                if (existingModal) existingModal.remove();

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading report:', error);
                alert('Gagal memuat detail laporan');
            }
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            if (modal) modal.remove();
        }

        // ============================================
        // ROLE-SPECIFIC AI ANALYSIS FUNCTIONS
        // ============================================

        // === AI Screening (INTAKE_OFFICER) ===
        let selectedScreenTicket = null;

        async function loadAIScreening() {
            try {
                // Fetch all and filter client-side for screening statuses
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=100`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const screenStatuses = ['NEW', 'REVIEWING'];
                const reports = (data.reports || []).filter(r => screenStatuses.includes(r.status));

                const select = document.getElementById('screen-ticket-select');
                select.innerHTML = '<option value="">-- Pilih Laporan Baru --</option>' +
                    reports.map(r => `<option value="${r.id}">${r.ticket_id} - ${escapeHtml((r.subject || r.title || '').substring(0, 40))}...</option>`).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading AI screening:', error);
            }
        }

        async function loadTicketForScreening() {
            const select = document.getElementById('screen-ticket-select');
            const reportId = select.value;
            if (!reportId) {
                document.getElementById('screen-report-preview').innerHTML = '<p class="text-slate-500 text-center">Pilih laporan untuk melihat preview</p>';
                return;
            }

            selectedScreenTicket = reportId;

            try {
                const response = await authFetch(`${API_URL}/api/v1/reports/${reportId}`);
                if (!response || !response.ok) throw new Error('Failed');
                const report = await response.json();

                document.getElementById('screen-report-preview').innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="font-mono text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">${report.ticket_id}</span>
                            <span class="text-xs text-slate-500">${formatDate(report.created_at)}</span>
                        </div>
                        <p class="font-medium text-islamic-dark">${escapeHtml(report.subject || report.title || '-')}</p>
                        <p class="text-sm text-slate-600 line-clamp-3">${escapeHtml((report.description || '').substring(0, 200))}...</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading ticket:', error);
            }
        }

        async function runQuickScreen() {
            if (!selectedScreenTicket) {
                alert('Pilih laporan terlebih dahulu');
                return;
            }

            const resultsEl = document.getElementById('screen-results');
            resultsEl.innerHTML = `
                <div class="p-8 bg-blue-50 rounded-lg text-center">
                    <div class="animate-spin w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-blue-600 font-medium">Menjalankan AI Screening...</p>
                    <p class="text-blue-500 text-sm">Auto-categorization, duplicate detection, priority scoring</p>
                </div>
            `;

            try {
                // Run analysis
                const response = await authFetch(`${API_URL}/api/v1/analysis/${selectedScreenTicket}`, { method: 'POST' });

                // Wait a bit for analysis
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Fetch updated report
                const reportRes = await authFetch(`${API_URL}/api/v1/reports/${selectedScreenTicket}`);
                if (!reportRes || !reportRes.ok) throw new Error('Failed');
                const report = await reportRes.json();

                // Show results
                const analysis = report.ai_analysis ? (typeof report.ai_analysis === 'string' ? JSON.parse(report.ai_analysis) : report.ai_analysis) : null;

                if (analysis) {
                    resultsEl.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                            <div class="flex items-center gap-2 text-green-700 mb-2">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                                <span class="font-medium">Screening Selesai</span>
                            </div>
                            <p class="text-sm text-green-600">${analysis.summary || 'Analisis berhasil dilakukan'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Severity</p>
                                <span class="px-2 py-1 bg-${getSeverityColor(analysis.severity)}-100 text-${getSeverityColor(analysis.severity)}-700 text-sm rounded">${analysis.severity || 'MEDIUM'}</span>
                            </div>
                            <div class="p-3 bg-slate-50 rounded-lg">
                                <p class="text-xs text-slate-500 mb-1">Fraud Score</p>
                                <span class="text-lg font-bold text-indigo-600">${analysis.fraud_score || '-'}</span>
                            </div>
                        </div>
                    `;

                    // Show categorization
                    document.getElementById('screen-categorization').classList.remove('hidden');
                    document.getElementById('screen-category').textContent = report.category || analysis.category || 'Terdeteksi';
                    document.getElementById('screen-confidence').textContent = Math.round((analysis.confidence || 0.85) * 100) + '%';
                    document.getElementById('screen-priority').textContent = analysis.severity === 'CRITICAL' ? 'Urgent' : analysis.severity === 'HIGH' ? 'High' : 'Normal';
                    document.getElementById('screen-completeness').textContent = analysis.completeness || '75%';
                } else {
                    resultsEl.innerHTML = `
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                            <p class="text-amber-700">Analisis selesai, menunggu hasil...</p>
                        </div>
                    `;
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error running screening:', error);
                resultsEl.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-700">Gagal menjalankan screening: ${error.message}</p>
                    </div>
                `;
            }
        }

        function applyScreeningResult() {
            if (!selectedScreenTicket) {
                alert('Tidak ada hasil screening untuk diterapkan');
                return;
            }
            alert('Hasil screening telah diterapkan ke laporan');
            showPage('intake-review');
        }

        // === AI Deep Analysis (INVESTIGATOR) ===
        let selectedDeepCase = null;
        let deepAnalysisResults = {};

        async function loadAIDeepAnalysis() {
            try {
                // Fetch all and filter client-side for investigation statuses
                const response = await authFetch(`${API_URL}/api/v1/reports?limit=100`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();
                const investigationStatuses = ['INVESTIGATING', 'ESCALATED'];
                const reports = (data.reports || []).filter(r => investigationStatuses.includes(r.status));

                const select = document.getElementById('deep-case-select');
                select.innerHTML = '<option value="">-- Pilih Kasus Aktif --</option>' +
                    reports.map(r => `<option value="${r.id}">${r.ticket_id} - ${escapeHtml((r.subject || r.title || '').substring(0, 40))}...</option>`).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading deep analysis:', error);
            }
        }

        function loadCaseForDeepAnalysis() {
            const select = document.getElementById('deep-case-select');
            selectedDeepCase = select.value;
        }

        async function runDeepAnalysis() {
            if (!selectedDeepCase) {
                alert('Pilih kasus terlebih dahulu');
                return;
            }

            // Update pipeline status - show running state
            const pipelineEl = document.getElementById('deep-pipeline-status');
            const agents = ['Intake Agent', 'Analysis Agent', 'Compliance Agent', 'Severity Agent', 'Recommendation Agent'];

            // Animate pipeline
            for (let i = 0; i < agents.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 800));
                const items = pipelineEl.querySelectorAll('.flex');
                if (items[i]) {
                    const statusEl = items[i].querySelector('span:last-child');
                    const circleEl = items[i].querySelector('.w-10');
                    if (i > 0 && items[i-1]) {
                        const prevStatus = items[i-1].querySelector('span:last-child');
                        const prevCircle = items[i-1].querySelector('.w-10');
                        prevStatus.textContent = '‚úì Done';
                        prevStatus.className = 'text-xs text-green-600 font-medium';
                        prevCircle.className = 'w-10 h-10 bg-green-500 rounded-full flex items-center justify-center';
                        prevCircle.innerHTML = '<i data-lucide="check" class="w-5 h-5 text-white"></i>';
                    }
                    statusEl.textContent = 'Running...';
                    statusEl.className = 'text-xs text-blue-600 font-medium animate-pulse';
                    circleEl.className = 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center';
                }
                lucide.createIcons();
            }

            // Run actual analysis
            try {
                const response = await authFetch(`${API_URL}/api/v1/analysis/${selectedDeepCase}`, { method: 'POST' });

                // Mark last agent as done
                const items = pipelineEl.querySelectorAll('.flex');
                const lastItem = items[items.length - 1];
                if (lastItem) {
                    const statusEl = lastItem.querySelector('span:last-child');
                    const circleEl = lastItem.querySelector('.w-10');
                    statusEl.textContent = '‚úì Done';
                    statusEl.className = 'text-xs text-green-600 font-medium';
                    circleEl.className = 'w-10 h-10 bg-green-500 rounded-full flex items-center justify-center';
                    circleEl.innerHTML = '<i data-lucide="check" class="w-5 h-5 text-white"></i>';
                }

                // Fetch results
                const reportRes = await authFetch(`${API_URL}/api/v1/reports/${selectedDeepCase}`);
                if (reportRes && reportRes.ok) {
                    const report = await reportRes.json();
                    deepAnalysisResults = report.ai_analysis ? (typeof report.ai_analysis === 'string' ? JSON.parse(report.ai_analysis) : report.ai_analysis) : {};

                    // Update fraud score gauge
                    const fraudScore = parseFloat(deepAnalysisResults.fraud_score) || 0;
                    const gauge = document.getElementById('deep-fraud-gauge');
                    const circumference = 351.86;
                    const offset = circumference - (fraudScore * circumference);
                    gauge.style.strokeDashoffset = offset;

                    document.getElementById('deep-fraud-score').textContent = fraudScore.toFixed(2);
                    const level = fraudScore > 0.7 ? 'High Risk' : fraudScore > 0.3 ? 'Medium Risk' : 'Low Risk';
                    const levelColor = fraudScore > 0.7 ? 'text-red-600' : fraudScore > 0.3 ? 'text-amber-600' : 'text-green-600';
                    document.getElementById('deep-fraud-level').textContent = level;
                    document.getElementById('deep-fraud-level').className = `text-center mt-2 text-sm font-medium ${levelColor}`;

                    // Show first tab
                    showDeepTab('4w1h');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error running deep analysis:', error);
                alert('Gagal menjalankan deep analysis');
            }
        }

        function showDeepTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.deep-tab').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-slate-600');
            });
            const activeTab = document.querySelector(`.deep-tab[data-tab="${tab}"]`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-slate-600');
                activeTab.classList.add('border-indigo-600', 'text-indigo-600');
            }

            // Show content
            const contentEl = document.getElementById('deep-tab-content');
            const analysis = deepAnalysisResults;

            switch (tab) {
                case '4w1h':
                    contentEl.innerHTML = analysis.parsed_report ? `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <p class="font-medium text-blue-800 mb-1">WHAT (Apa)</p>
                                <p class="text-sm text-blue-700">${escapeHtml(analysis.parsed_report.what || '-')}</p>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <p class="font-medium text-purple-800 mb-1">WHO (Siapa)</p>
                                <p class="text-sm text-purple-700">${escapeHtml(analysis.parsed_report.who || '-')}</p>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-lg">
                                <p class="font-medium text-amber-800 mb-1">WHEN (Kapan)</p>
                                <p class="text-sm text-amber-700">${escapeHtml(analysis.parsed_report.when || '-')}</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <p class="font-medium text-green-800 mb-1">WHERE (Dimana)</p>
                                <p class="text-sm text-green-700">${escapeHtml(analysis.parsed_report.where || '-')}</p>
                            </div>
                            <div class="col-span-2 p-4 bg-indigo-50 rounded-lg">
                                <p class="font-medium text-indigo-800 mb-1">HOW (Bagaimana)</p>
                                <p class="text-sm text-indigo-700">${escapeHtml(analysis.parsed_report.how || '-')}</p>
                            </div>
                        </div>
                    ` : '<p class="text-slate-500 text-center py-8">Data 4W+1H tidak tersedia</p>';
                    break;

                case 'fraud':
                    contentEl.innerHTML = analysis.fraud_indicators ? `
                        <div class="space-y-4">
                            <div class="p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                                <p class="font-medium text-red-800 mb-2">Opportunity (Kesempatan)</p>
                                <p class="text-sm text-red-700">${escapeHtml(analysis.fraud_indicators.opportunity || '-')}</p>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="text-xs text-red-600">Score:</span>
                                    <div class="flex-1 bg-red-200 rounded-full h-2">
                                        <div class="bg-red-500 h-2 rounded-full" style="width: ${(analysis.fraud_indicators.opportunity_score || 0) * 100}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-red-700">${((analysis.fraud_indicators.opportunity_score || 0) * 100).toFixed(0)}%</span>
                                </div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-lg border-l-4 border-amber-500">
                                <p class="font-medium text-amber-800 mb-2">Pressure (Tekanan)</p>
                                <p class="text-sm text-amber-700">${escapeHtml(analysis.fraud_indicators.pressure || '-')}</p>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="text-xs text-amber-600">Score:</span>
                                    <div class="flex-1 bg-amber-200 rounded-full h-2">
                                        <div class="bg-amber-500 h-2 rounded-full" style="width: ${(analysis.fraud_indicators.pressure_score || 0) * 100}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-amber-700">${((analysis.fraud_indicators.pressure_score || 0) * 100).toFixed(0)}%</span>
                                </div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                                <p class="font-medium text-purple-800 mb-2">Rationalization (Rasionalisasi)</p>
                                <p class="text-sm text-purple-700">${escapeHtml(analysis.fraud_indicators.rationalization || '-')}</p>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="text-xs text-purple-600">Score:</span>
                                    <div class="flex-1 bg-purple-200 rounded-full h-2">
                                        <div class="bg-purple-500 h-2 rounded-full" style="width: ${(analysis.fraud_indicators.rationalization_score || 0) * 100}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-purple-700">${((analysis.fraud_indicators.rationalization_score || 0) * 100).toFixed(0)}%</span>
                                </div>
                            </div>
                        </div>
                    ` : '<p class="text-slate-500 text-center py-8">Data Fraud Triangle tidak tersedia</p>';
                    break;

                case 'compliance':
                    contentEl.innerHTML = analysis.compliance_check ? `
                        <div class="space-y-3">
                            ${(analysis.compliance_check.violations || []).map(v => `
                                <div class="p-4 bg-slate-50 rounded-lg border-l-4 border-islamic-green">
                                    <p class="font-medium text-islamic-dark">${escapeHtml(v.regulation || v)}</p>
                                    <p class="text-sm text-slate-600 mt-1">${escapeHtml(v.description || '')}</p>
                                </div>
                            `).join('') || '<p class="text-slate-500">Tidak ada pelanggaran regulasi terdeteksi</p>'}
                        </div>
                    ` : '<p class="text-slate-500 text-center py-8">Data Compliance tidak tersedia</p>';
                    break;

                case 'timeline':
                    contentEl.innerHTML = `
                        <div class="space-y-4">
                            <p class="text-sm text-slate-600">Timeline rekonstruksi kejadian berdasarkan analisis AI:</p>
                            <div class="border-l-2 border-indigo-300 pl-4 space-y-4">
                                <div class="relative">
                                    <div class="absolute -left-6 w-4 h-4 bg-indigo-500 rounded-full"></div>
                                    <p class="text-xs text-slate-500">Periode Awal</p>
                                    <p class="text-sm text-slate-700">${escapeHtml(analysis.parsed_report?.when || 'Waktu tidak dispesifikkan')}</p>
                                </div>
                                <div class="relative">
                                    <div class="absolute -left-6 w-4 h-4 bg-indigo-400 rounded-full"></div>
                                    <p class="text-xs text-slate-500">Kejadian</p>
                                    <p class="text-sm text-slate-700">${escapeHtml(analysis.parsed_report?.what || '-')}</p>
                                </div>
                                <div class="relative">
                                    <div class="absolute -left-6 w-4 h-4 bg-indigo-300 rounded-full"></div>
                                    <p class="text-xs text-slate-500">Laporan Diterima</p>
                                    <p class="text-sm text-slate-700">Sistem WBS BPKH</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'patterns':
                    contentEl.innerHTML = `
                        <div class="space-y-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h4 class="font-medium text-purple-800 mb-2">Pattern Detection</h4>
                                <p class="text-sm text-purple-700">AI menganalisis pola berdasarkan kasus historis dan knowledge base.</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded-lg text-center">
                                    <p class="text-2xl font-bold text-indigo-600">${analysis.similar_cases?.length || 0}</p>
                                    <p class="text-xs text-slate-600">Kasus Serupa</p>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-lg text-center">
                                    <p class="text-2xl font-bold text-amber-600">${analysis.patterns_detected || 0}</p>
                                    <p class="text-xs text-slate-600">Pola Terdeteksi</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }

            lucide.createIcons();
        }

        function exportDeepAnalysis(format) {
            alert(`Export ke format ${format.toUpperCase()} dalam pengembangan`);
        }

        // === AI Insights (MANAGER) ===
        async function loadAIInsights() {
            try {
                const response = await authFetch(`${API_URL}/api/v1/dashboard/stats`);
                if (!response || !response.ok) throw new Error('Failed');
                const data = await response.json();

                // Update category distribution
                if (data.category_breakdown) {
                    const categories = document.getElementById('insights-categories');
                    const cats = data.category_breakdown;
                    categories.innerHTML = `
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <p class="text-2xl font-bold text-red-600">${cats.KORUPSI || 0}</p>
                            <p class="text-xs text-slate-600">Korupsi</p>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <p class="text-2xl font-bold text-orange-600">${cats.FRAUD || 0}</p>
                            <p class="text-xs text-slate-600">Fraud</p>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <p class="text-2xl font-bold text-yellow-600">${cats.COI || 0}</p>
                            <p class="text-xs text-slate-600">COI</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <p class="text-2xl font-bold text-purple-600">${cats.GRATIFIKASI || 0}</p>
                            <p class="text-xs text-slate-600">Gratifikasi</p>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-2xl font-bold text-blue-600">${cats.PELANGGARAN_SOP || 0}</p>
                            <p class="text-xs text-slate-600">Pelanggaran SOP</p>
                        </div>
                        <div class="text-center p-4 bg-slate-50 rounded-lg">
                            <p class="text-2xl font-bold text-slate-600">${cats.LAINNYA || 0}</p>
                            <p class="text-xs text-slate-600">Lainnya</p>
                        </div>
                    `;
                }

                // Load trend visualization
                loadInsightsTrend();

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading AI insights:', error);
            }
        }

        async function loadInsightsTrend() {
            const period = document.getElementById('insights-period')?.value || 30;
            const chartEl = document.getElementById('insights-trend-chart');

            // Simple bar chart visualization
            chartEl.innerHTML = `
                <div class="w-full h-full p-4">
                    <div class="flex items-end justify-between h-48 gap-2">
                        ${Array(7).fill(0).map((_, i) => {
                            const height = Math.random() * 80 + 20;
                            return `<div class="flex-1 bg-emerald-500 rounded-t transition-all hover:bg-emerald-600" style="height: ${height}%" title="Week ${i+1}"></div>`;
                        }).join('')}
                    </div>
                    <div class="flex justify-between mt-2 text-xs text-slate-500">
                        <span>W1</span><span>W2</span><span>W3</span><span>W4</span><span>W5</span><span>W6</span><span>W7</span>
                    </div>
                </div>
            `;
        }

        function generateInsightsReport(type) {
            alert(`Generate ${type === 'executive' ? 'Executive Summary' : 'Detailed Report'} dalam pengembangan`);
        }
    </script>
</body>
</html>
